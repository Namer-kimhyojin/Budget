[{"filePath":"D:\\Budget\\src\\App.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'setSidebarOpen' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":105,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":105,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSidebarOpen"},"fix":{"range":[3801,3817],"text":""},"desc":"Remove unused variable 'setSidebarOpen'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'activeMenu' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":122,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":122,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"activeMenu"},"fix":{"range":[4675,4828],"text":""},"desc":"Remove unused variable 'activeMenu'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":207,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":207,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'bootstrap'. Either include it or remove the dependency array.","line":216,"column":48,"nodeType":"ArrayExpression","endLine":216,"endColumn":55,"suggestions":[{"desc":"Update the dependencies array to be: [bootstrap, token]","fix":{"range":[8408,8415],"text":"[bootstrap, token]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'refresh' and 'token'. Either include them or remove the dependency array.","line":217,"column":57,"nodeType":"ArrayExpression","endLine":217,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [refresh, token, version]","fix":{"range":[8475,8484],"text":"[refresh, token, version]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'breadcrumbBar' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":492,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":492,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"breadcrumbBar"},"fix":{"range":[21401,21584],"text":""},"desc":"Remove unused variable 'breadcrumbBar'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'bcLeft' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":493,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":493,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"bcLeft"},"fix":{"range":[21586,21705],"text":""},"desc":"Remove unused variable 'bcLeft'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'bcVersion' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":494,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":494,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"bcVersion"},"fix":{"range":[21707,21845],"text":""},"desc":"Remove unused variable 'bcVersion'."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import React, { Suspense, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport axios from 'axios';\r\nimport MenuPageRouter from './pages/menu/MenuPageRouter';\r\nimport { APP_MENU_SECTIONS, APP_MENU_META, isMenuAllowed, ROLE_LABELS } from './pages/menu/config';\r\nimport {\n  ChevronRight, Home, Lock, LogOut, User\n} from 'lucide-react';\n\r\nconst TraditionalLedgerView = React.lazy(() => import('./pages/core/TraditionalLedgerView'));\r\nconst SubjectManagementView = React.lazy(() => import('./pages/core/SubjectManagementView'));\r\nimport { MenuShell } from './pages/menu/shared/menuUi';\r\n\r\nconst API_BASE_URL = '';\r\nconst TOKEN_KEY = 'ibms_auth_token';\r\nconst MENU_PATH_BY_ID = {\r\n  dashboard: '/dashboard',\r\n  intake: '/intake',\r\n  planning: '/planning',\r\n  deptApproval: '/dept-approval',\r\n  hqReview: '/hq-review',\r\n  reports: '/reports',\r\n  users: '/users',\r\n  masters: '/masters',\r\n  audit: '/audit',\r\n  notice: '/notice',\r\n  closing: '/closing',\r\n};\r\nconst MENU_ID_BY_PATH = Object.fromEntries(\n  Object.entries(MENU_PATH_BY_ID).map(([id, path]) => [path, id])\n);\nconst BRAND_SHORT = 'P.BOS';\nconst BRAND_FULL_EN = 'PTP Budget Operating System';\nconst BRAND_FULL_KO = '포항테크노파크 예산 운영 시스템';\n\r\nconst COLORS = {\r\n  blue: '#0059b3',\r\n  sidebar: '#0f172a',\r\n  bg: '#fcfcfd',\r\n  border: '#e2e8f0',\r\n  muted: '#64748b',\r\n  success: '#10b981',\r\n  danger: '#ef4444',\r\n  income: '#0369a1',\r\n  expense: '#be123c',\r\n  white: '#ffffff',\r\n};\r\n\r\nconst toList = (d) => (Array.isArray(d) ? d : d?.results || []);\r\nconst normalizePath = (pathname) => {\r\n  if (!pathname) return '/';\r\n  if (pathname === '/') return '/';\r\n  return pathname.replace(/\\/+$/, '') || '/';\r\n};\r\nconst getMenuIdFromPath = (pathname) => MENU_ID_BY_PATH[normalizePath(pathname)] || null;\r\nconst getPathFromMenuId = (menuId) => MENU_PATH_BY_ID[menuId] || MENU_PATH_BY_ID.dashboard;\r\n\r\n\r\nconst safeJsonParse = (value, fallback = null) => {\r\n  if (!value) return fallback;\r\n  try {\r\n    return JSON.parse(value);\r\n  } catch {\r\n    return fallback;\r\n  }\r\n};\r\n\r\nconst apiErrorMessage = (e, fallback = '오류가 발생했습니다.') => {\r\n  const data = e?.response?.data;\r\n  if (!data) {\r\n    const status = e?.response?.status;\r\n    const msg = e?.message || '네트워크 오류';\r\n    return status ? `${fallback} (상태코드 ${status})` : `${fallback} (${msg})`;\r\n  }\r\n  if (typeof data === 'string') {\r\n    if (data.includes('<html') || data.includes('<!DOCTYPE')) {\r\n      const titleMatch = data.match(/<title>(.*?)<\\/title>/i);\r\n      const title = titleMatch?.[1]?.trim();\r\n      return title ? `서버 오류: ${title}` : fallback;\r\n    }\r\n    return data;\r\n  }\r\n  if (typeof data.error === 'string') {\r\n    const trace = typeof data.trace_id === 'string' ? ` [추적ID: ${data.trace_id}]` : '';\r\n    if (typeof data.details === 'string' && data.details.trim()) return `${data.error}: ${data.details}${trace}`;\r\n    if (data.details && typeof data.details === 'object') return `${data.error}: ${JSON.stringify(data.details)}${trace}`;\r\n    return `${data.error}${trace}`;\r\n  }\r\n  const parts = [];\r\n  Object.entries(data).forEach(([k, v]) => {\r\n    if (Array.isArray(v)) parts.push(`${k}: ${v.join(', ')}`);\r\n    else if (typeof v === 'string') parts.push(`${k}: ${v}`);\r\n  });\r\n  if (typeof data.trace_id === 'string') parts.push(`추적ID: ${data.trace_id}`);\r\n  return parts.length ? parts.join('\\n') : fallback;\r\n};\r\n\r\nexport default function App() {\r\n  const [token, setToken] = useState(localStorage.getItem(TOKEN_KEY));\r\n  const [user, setUser] = useState(() => safeJsonParse(localStorage.getItem('ibms_user'), null));\r\n  const [activeTab, setActiveTab] = useState(() => {\r\n    if (typeof window === 'undefined') return 'dashboard';\r\n    return getMenuIdFromPath(window.location.pathname) || 'dashboard';\r\n  });\r\n  const [sidebarOpen, setSidebarOpen] = useState(true);\r\n  const [loading, setLoading] = useState(!!token);\r\n\r\n  const [orgs, setOrgs] = useState([]);\r\n  const [subjects, setSubjects] = useState([]);\r\n  const [projects, setProjects] = useState([]);\r\n  const [entries, setEntries] = useState([]);\r\n  const [version, setVersion] = useState(null);\r\n  const [versions, setVersions] = useState([]);\r\n  const [modal, setModal] = useState(null);\r\n  const bootstrapInFlightRef = useRef(false);\r\n  const visibleMenuSections = useMemo(() => {\r\n    return APP_MENU_SECTIONS\r\n      .map(section => ({ ...section, items: section.items.filter(item => isMenuAllowed(user?.role, item.id)) }))\r\n      .filter(section => section.items.length > 0);\r\n  }, [user?.role]);\r\n  const allowedMenuIds = useMemo(() => visibleMenuSections.flatMap(section => section.items.map(item => item.id)), [visibleMenuSections]);\r\n  const activeMenu = APP_MENU_META.find(menu => menu.id === activeTab) || APP_MENU_META.find(menu => allowedMenuIds.includes(menu.id)) || APP_MENU_META[0];\r\n\r\n  const authAxios = useMemo(() => {\r\n    const instance = axios.create({ baseURL: API_BASE_URL });\r\n    if (token) {\r\n      instance.defaults.headers.common['Authorization'] = `Token ${token}`;\r\n    }\r\n    return instance;\r\n  }, [token]);\r\n\r\n  const modalApi = useMemo(() => ({\r\n    alert: (message, title = '알림') => new Promise(res => setModal({ type: 'alert', title, message, onClose: () => { setModal(null); res(true); } })),\r\n    confirm: (message, title = '확인') => new Promise(res => setModal({ type: 'confirm', title, message, onConfirm: () => { setModal(null); res(true); }, onCancel: () => { setModal(null); res(false); } })),\r\n  }), []);\r\n\r\n  const bootstrap = async () => {\r\n    if (!token) return;\r\n    if (bootstrapInFlightRef.current) return;\r\n    bootstrapInFlightRef.current = true;\r\n    setLoading(true);\r\n    try {\r\n      const me = await authAxios.get(`/api/auth/me/`);\r\n      const meData = me?.data || {};\r\n      const meUser = meData.user || {};\r\n      const meProfile = meData.profile || {};\r\n      const mergedUser = { ...meUser, role: meProfile.role, organization: meProfile.organization, organization_name: meProfile.organization_name };\r\n      setUser(mergedUser);\r\n      localStorage.setItem('ibms_user', JSON.stringify(mergedUser));\r\n\r\n      const [o, s, v, p] = await Promise.all([\r\n        authAxios.get(`/api/orgs/`),\r\n        authAxios.get(`/api/subjects/`),\r\n        authAxios.get(`/api/versions/`),\r\n        authAxios.get(`/api/entrusted-projects/`),\r\n      ]);\r\n      setOrgs(toList(o.data));\r\n      setSubjects(toList(s.data));\r\n      setProjects(toList(p.data));\r\n\r\n      const vl = toList(v.data);\r\n      setVersions(vl);\r\n      if (vl.length > 0) {\r\n        const sorted = [...vl].sort((a, b) => b.year - a.year || b.round - a.round);\r\n        setVersion(sorted.find(v => v.round === 0) || sorted[0]);\r\n      }\r\n    } catch (e) {\r\n      console.error('Bootstrap Error:', e);\r\n      if (e.response?.status === 401) {\r\n        handleLogout();\r\n      } else {\r\n        modalApi.alert(apiErrorMessage(e, '초기 데이터를 불러오는 데 실패했습니다.'));\r\n      }\r\n    } finally {\r\n      setLoading(false);\r\n      bootstrapInFlightRef.current = false;\r\n    }\r\n  };\r\n\r\n  const refresh = async () => {\r\n    if (!version || !token) return;\r\n    try {\r\n      const r = await authAxios.get(`/api/entries/`, { params: { year: version.year, round: version.round } });\r\n      setEntries(toList(r.data));\r\n    } catch (e) { console.error(e); }\r\n  };\r\n\r\n  const createVersion = async (year) => {\r\n    try {\r\n      const res = await authAxios.post('/api/versions/create_next_round/', { year });\r\n      setVersions(p => [...p, res.data]);\r\n      setVersion(res.data);\r\n      modalApi.alert(`${res.data.name}이 생성되었습니다.`);\r\n    } catch (e) {\r\n      alert('버전 생성 실패: ' + (e.response?.data?.error || '오류'));\r\n    }\r\n  };\r\n\r\n  const handleLogin = async (username, password) => {\r\n    try {\r\n      const res = await axios.post('/api/auth/login/', { username, password });\r\n      const { token: tk, user: us, profile } = res.data;\r\n      const mergedUser = { ...us, role: profile?.role, organization: profile?.organization, organization_name: profile?.organization_name };\r\n      setToken(tk); setUser(mergedUser);\r\n      localStorage.setItem(TOKEN_KEY, tk);\r\n      localStorage.setItem('ibms_user', JSON.stringify(mergedUser));\r\n    } catch (e) { alert('로그인 실패'); }\r\n  };\r\n\r\n  const handleLogout = () => {\r\n    setToken(null); setUser(null);\r\n    localStorage.removeItem(TOKEN_KEY);\r\n    localStorage.removeItem('ibms_user');\r\n  };\r\n\r\n  useEffect(() => { if (token) bootstrap(); }, [token]);\r\n  useEffect(() => { if (version && token) refresh(); }, [version]);\r\n  useEffect(() => {\r\n    const handlePopState = () => {\r\n      const menuId = getMenuIdFromPath(window.location.pathname);\r\n      if (menuId) setActiveTab(menuId);\r\n    };\r\n    window.addEventListener('popstate', handlePopState);\r\n    return () => window.removeEventListener('popstate', handlePopState);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (allowedMenuIds.length === 0) return;\r\n    if (token && loading) return;\r\n    if (allowedMenuIds.includes(activeTab)) return;\r\n\r\n    const fromPath = getMenuIdFromPath(window.location.pathname);\r\n    const fallbackMenuId = fromPath && allowedMenuIds.includes(fromPath)\r\n      ? fromPath\r\n      : allowedMenuIds[0];\r\n\r\n    if (activeTab !== fallbackMenuId) setActiveTab(fallbackMenuId);\r\n    const fallbackPath = getPathFromMenuId(fallbackMenuId);\r\n    if (normalizePath(window.location.pathname) !== fallbackPath) {\r\n      window.history.replaceState({}, '', fallbackPath);\r\n    }\r\n  }, [allowedMenuIds, activeTab, token, loading]);\r\n\r\n  useEffect(() => {\r\n    const nextPath = getPathFromMenuId(activeTab);\r\n    if (normalizePath(window.location.pathname) === nextPath) return;\r\n    window.history.pushState({}, '', nextPath);\r\n  }, [activeTab]);\r\n\r\n  if (!token) return <LoginScreen onLogin={handleLogin} />;\r\n  if (loading) return <LoadingScreen />;\r\n\r\n  return (\r\n    <div style={rootWrapper}>\r\n      <header style={topHeader}>\r\n        <div\n          style={{ ...logoWrapper, cursor: 'pointer' }}\n          onClick={() => setActiveTab('dashboard')}\n          title={BRAND_FULL_KO}\n        >\n          <div style={logoIconBox}>\n            <img src=\"/vite.svg\" alt=\"P.BOS logo\" style={{ width: 24, height: 24, display: 'block' }} />\n          </div>\n          <div style={logoTypo}>\n            <div style={logoTop}>{`${BRAND_SHORT} (${BRAND_FULL_EN})`}</div>\n            <div style={logoBottom}>{BRAND_FULL_KO}</div>\n          </div>\n        </div>\r\n        <div style={headerActionGroup}>\r\n          <div style={userProfileTile} onClick={handleLogout}>\r\n            <div style={avatarCircle}>{(user?.username || '').substring(0, 2).toUpperCase()}</div>\r\n            <div style={userBrief}><div style={uNameLabel}>{user?.username}</div><div style={uRoleTag}>{ROLE_LABELS[user?.role] || user?.role}</div></div>\r\n            <LogOut size={14} opacity={0.4} />\r\n          </div>\r\n        </div>\r\n      </header>\r\n      <div style={mainContentWrapper}>\r\n        <aside style={{ ...sideNav, width: sidebarOpen ? 220 : 72 }}>\r\n          <div style={navScrollArea}>\r\n            {visibleMenuSections.map(section => (\r\n              <div key={section.key} style={navSectionWrap}>\r\n                {sidebarOpen && <div style={navSectionTitle}>{section.title}</div>}\r\n                {section.items.map(menu => {\r\n                  const Icon = menu.icon;\r\n                  const isActive = activeTab === menu.id;\r\n                  return (\r\n                    <div\r\n                      key={menu.id}\r\n                      onClick={() => setActiveTab(menu.id)}\r\n                      style={{\r\n                        ...navItem,\r\n                        color: isActive ? '#fff' : '#94a3b8',\r\n                        background: isActive ? 'rgba(255,255,255,0.1)' : 'transparent',\r\n                      }}\r\n                    >\r\n                      <div style={navIconSlot}><Icon size={18} /></div>\r\n                      {sidebarOpen && <span style={navLabelSlot}>{menu.label}</span>}\r\n                    </div>\r\n                  );\r\n                })}\r\n                <div style={navDivider} />\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </aside>\r\n        <main style={workspaceArea}>\r\n\r\n          <div style={viewPortPadding}>\r\n            <Suspense fallback={<LoadingScreen />}>\r\n              {activeTab === 'planning' && (\r\n                <MenuShell menuId=\"planning\" user={user} breadcrumbs={['예산 편성/관리']} contextBadge={version ? `${version.year}년도 ${version.name}` : ''} hideHero={true}>\r\n                  <TraditionalLedgerView authAxios={authAxios} entries={entries} subjects={subjects} projects={projects} orgs={orgs} onRefresh={refresh} modalApi={modalApi} version={version} versions={versions} setVersion={setVersion} onCreateVersion={createVersion} user={user} />\r\n                </MenuShell>\r\n              )}\r\n              {activeTab === 'masters' && (\r\n                <MenuShell menuId=\"masters\" user={user} hideHero={true}>\r\n                  <SubjectManagementView authAxios={authAxios} subjects={subjects} orgs={orgs} projects={projects} onRefresh={bootstrap} />\r\n                </MenuShell>\r\n              )}\r\n              {activeTab !== 'planning' && activeTab !== 'masters' && (\r\n                <MenuPageRouter\r\n                  menuId={activeTab}\r\n                  authAxios={authAxios}\r\n                  version={version}\r\n                  versions={versions}\r\n                  setVersion={setVersion}\r\n                  onCreateVersion={createVersion}\r\n                  onBootstrap={bootstrap}\r\n                  onRefreshEntries={refresh}\r\n                  subjects={subjects}\r\n                  orgs={orgs}\r\n                  projects={projects}\r\n                  entries={entries}\r\n                  user={user}\r\n                  modalApi={modalApi}\r\n                  onNavigate={setActiveTab}\r\n                />\r\n              )}\r\n            </Suspense>\r\n          </div>\r\n        </main>\r\n      </div>\r\n      <SystemModal modal={modal} />\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction LoginScreen({ onLogin }) {\r\n  const [u, setU] = useState(''); const [p, setP] = useState('');\r\n  return (\r\n    <div style={lOv}><div style={lCd}><h2>{`${BRAND_SHORT} 로그인`}</h2>\n      <div style={lF}><User size={18} /><input id=\"login-username\" name=\"username\" autoComplete=\"username\" style={lI} value={u} onChange={e => setU(e.target.value)} placeholder=\"아이디\" /></div>\r\n      <div style={lF}><Lock size={18} /><input id=\"login-password\" name=\"password\" autoComplete=\"current-password\" style={lI} type=\"password\" value={p} onChange={e => setP(e.target.value)} placeholder=\"비밀번호\" /></div>\r\n      <button style={lB} onClick={() => onLogin(u, p)}>접속</button>\r\n    </div></div>\r\n  );\r\n}\r\n\r\nfunction LoadingScreen() { return <div style={lFull}><div style={lSp} /></div>; }\r\n\r\nfunction SystemModal({ modal }) {\r\n  if (!modal) return null;\r\n\r\n  const lines = typeof modal.message === 'string'\r\n    ? modal.message.split('\\n').filter(l => l !== undefined)\r\n    : null;\r\n\r\n  // 번호 목록 항목인지 판별 (예: \"1. 내용\" or \"... 총 N건\")\r\n  const isNumberedItem = (line) => /^\\d+\\./.test(line.trim()) || /^\\.\\.\\./.test(line.trim());\r\n  const hasNumberedList = lines && lines.some(isNumberedItem);\r\n\r\n  const renderMessage = () => {\r\n    if (!lines) return <p style={{ margin: 0, color: '#475569', lineHeight: 1.7 }}>{modal.message}</p>;\r\n\r\n    if (!hasNumberedList) {\r\n      // 단순 줄바꿈 메시지\r\n      return (\r\n        <div style={{ color: '#475569', lineHeight: 1.7 }}>\r\n          {lines.map((line, i) => (\r\n            line.trim() === ''\r\n              ? <div key={i} style={{ height: 8 }} />\r\n              : <div key={i}>{line}</div>\r\n          ))}\r\n        </div>\r\n      );\r\n    }\r\n\r\n    // 번호 목록이 포함된 메시지: 헤더 + 아이템 구분\r\n    const headerLines = [];\r\n    const listItems = [];\r\n    let inList = false;\r\n    for (const line of lines) {\r\n      if (line.trim() === '') continue;\r\n      if (isNumberedItem(line)) {\r\n        inList = true;\r\n        listItems.push(line.trim());\r\n      } else if (!inList) {\r\n        headerLines.push(line.trim());\r\n      }\r\n    }\r\n\r\n    return (\r\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\r\n        {headerLines.length > 0 && (\r\n          <div style={{ fontSize: 13, color: '#64748b', fontWeight: 500 }}>\r\n            {headerLines.join(' ')}\r\n          </div>\r\n        )}\r\n        <div style={{ maxHeight: 340, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: 4 }}>\r\n          {listItems.map((item, i) => {\r\n            const isMeta = /^\\.\\.\\./.test(item);\r\n            // \"1. 날짜 | 행위자 | from -> to | 사유\" 파싱\r\n            const rest = item.replace(/^\\d+\\.\\s*/, '');\r\n            const parts = rest.split(' | ');\r\n            if (isMeta) {\r\n              return (\r\n                <div key={i} style={{ fontSize: 12, color: '#94a3b8', paddingLeft: 8, paddingTop: 4 }}>{item}</div>\r\n              );\r\n            }\r\n            return (\r\n              <div key={i} style={{ background: i % 2 === 0 ? '#f8fafc' : '#fff', borderRadius: 8, padding: '8px 12px', border: '1px solid #f1f5f9', display: 'flex', flexDirection: 'column', gap: 3 }}>\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap' }}>\r\n                  <span style={{ fontSize: 11, color: '#94a3b8', fontWeight: 600, minWidth: 18 }}>{i + 1}</span>\r\n                  {parts[0] && <span style={{ fontSize: 12, color: '#64748b' }}>{parts[0]}</span>}\r\n                  {parts[1] && <span style={{ fontSize: 12, fontWeight: 700, color: '#1e293b' }}>{parts[1]}</span>}\r\n                  {parts[2] && (\r\n                    <span style={{ fontSize: 12, color: '#2563eb', fontWeight: 600, background: '#eff6ff', padding: '1px 7px', borderRadius: 999 }}>\r\n                      {parts[2]}\r\n                    </span>\r\n                  )}\r\n                </div>\r\n                {parts[3] && (\r\n                  <div style={{ fontSize: 12, color: '#ef4444', paddingLeft: 26 }}>{parts[3]}</div>\r\n                )}\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return createPortal(\r\n    <div style={mOv}>\r\n      <div style={mCd}>\r\n        <h4 style={{ margin: '0 0 16px 0', fontSize: '1.1rem', fontWeight: 800, color: '#0f172a' }}>{modal.title}</h4>\r\n        {renderMessage()}\r\n        <div style={mBs}>\r\n          {modal.type === 'confirm' && <button style={btnG} onClick={modal.onCancel}>취소</button>}\r\n          <button style={btnP} onClick={modal.type === 'alert' ? modal.onClose : modal.onConfirm}>확인</button>\r\n        </div>\r\n      </div>\r\n    </div>,\r\n    document.body\r\n  );\r\n}\r\n\r\n// --- Styles & Global Polish ---\r\nconst rootWrapper = {\r\n  display: 'flex',\r\n  flexDirection: 'column',\r\n  width: '100vw',\r\n  height: '100vh',\r\n  background: '#fcfcfd',\r\n  fontFamily: '\"Pretendard Variable\", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, \"Helvetica Neue\", \"Segoe UI\", \"Apple SD Gothic Neo\", \"Noto Sans KR\", sans-serif',\r\n  color: '#1e293b',\r\n  WebkitFontSmoothing: 'antialiased',\r\n  letterSpacing: '-0.01em'\r\n};\r\nconst topHeader = { height: 64, background: '#1e293b', display: 'flex', alignItems: 'center', padding: '0 32px', color: '#fff', justifyContent: 'space-between', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' };\r\nconst logoWrapper = { display: 'flex', alignItems: 'center', gap: 14 };\r\nconst logoIconBox = { width: 36, height: 36, background: '#ffffff', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 2 };\nconst logoTypo = { display: 'flex', flexDirection: 'column', lineHeight: 1.2 };\r\nconst logoTop = { fontSize: '14px', fontWeight: 800, letterSpacing: '-0.01em' };\nconst logoBottom = { fontSize: '11px', opacity: 0.7, fontWeight: 600 };\nconst headerActionGroup = { display: 'flex', alignItems: 'center', gap: 20 };\r\nconst userProfileTile = { display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer', padding: '8px 12px', borderRadius: 12, transition: 'background 0.2s' };\r\nconst avatarCircle = { width: 32, height: 32, background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 800, color: '#fff', fontSize: '12pt' };\r\nconst userBrief = { textAlign: 'right' };\r\nconst uNameLabel = { fontSize: '12pt', fontWeight: 700 };\r\nconst uRoleTag = { fontSize: '12pt', opacity: 0.5, fontWeight: 500 };\r\nconst mainContentWrapper = { display: 'flex', flex: 1, overflow: 'hidden' };\r\nconst sideNav = { background: '#1e293b', display: 'flex', flexDirection: 'column', width: 220, borderRight: '1px solid rgba(255,255,255,0.05)' };\r\nconst navScrollArea = { flex: 1, padding: '24px 12px' };\r\nconst navDivider = { height: 1, background: 'rgba(255,255,255,0.08)', margin: '16px 8px' };\r\nconst navSectionWrap = { marginBottom: 2 };\r\nconst navSectionTitle = { color: 'rgba(255,255,255,0.45)', fontSize: '11px', fontWeight: 700, letterSpacing: '0.06em', textTransform: 'uppercase', padding: '2px 12px 8px' };\r\nconst navItem = { height: 48, padding: '0 16px', borderRadius: 10, display: 'flex', alignItems: 'center', cursor: 'pointer', marginBottom: 4, transition: 'all 0.2s', gap: 12 };\r\nconst navIconSlot = { width: 20, display: 'flex', justifyContent: 'center', opacity: 0.7 };\r\nconst navLabelSlot = { fontSize: '12pt', fontWeight: 500 };\r\nconst workspaceArea = { flex: 1, display: 'flex', flexDirection: 'column', overflow: 'auto' };\r\nconst breadcrumbBar = { height: 50, background: '#fff', borderBottom: '1px solid #e2e8f0', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 32px' };\r\nconst bcLeft = { display: 'flex', alignItems: 'center', gap: 10, fontSize: '12pt', color: '#64748b', fontWeight: 500 };\r\nconst bcVersion = { fontSize: '12pt', fontWeight: 800, color: COLORS.blue, background: '#eff6ff', padding: '4px 12px', borderRadius: 20 };\r\nconst viewPortPadding = { flex: 1, padding: '24px 32px', overflowY: 'auto' };\r\nconst btnP = { background: COLORS.blue, color: '#fff', border: 'none', padding: '16px', borderRadius: 12, fontWeight: 800, cursor: 'pointer', fontSize: '1rem' };\r\nconst lOv = { height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#1e293b' };\r\nconst lCd = { width: 400, background: '#fff', padding: '48px', borderRadius: 24, textAlign: 'center', boxShadow: '0 25px 50px -12px rgb(0 0 0 / 0.25)' };\r\nconst lF = { display: 'flex', alignItems: 'center', gap: 12, background: '#f1f5f9', padding: '16px 20px', borderRadius: 14, marginTop: 16 };\r\nconst lI = { flex: 1, border: 'none', background: 'transparent', outline: 'none' };\r\nconst lB = { width: '100%', marginTop: 32, background: COLORS.blue, color: '#fff', border: 'none', padding: '18px', borderRadius: 14, fontWeight: 800 };\r\nconst mOv = { position: 'fixed', inset: 0, background: 'rgba(15, 23, 42, 0.5)', zIndex: 30000, display: 'flex', alignItems: 'center', justifyContent: 'center', backdropFilter: 'blur(4px)' };\nconst mCd = { background: '#fff', padding: '32px', borderRadius: 20, width: 500, maxWidth: '92vw', boxShadow: '0 25px 50px -12px rgb(0 0 0 / 0.25)' };\r\nconst mBs = { display: 'flex', justifyContent: 'flex-end', gap: 12, marginTop: 32 };\r\nconst btnG = { padding: '12px 24px', border: '1px solid #e2e8f0', background: '#fff', borderRadius: 12, fontWeight: 700, cursor: 'pointer', color: '#64748b' };\r\nconst lFull = { height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#fcfcfd' };\r\nconst lSp = { width: 48, height: 48, border: '4px solid #f1f5f9', borderTop: `4px solid ${COLORS.blue}`, borderRadius: '50%', animation: 'spin 1s linear infinite' };\r\nconst spinAnime = `@keyframes spin {0 % { transform: rotate(0deg); } 100% {transform: rotate(360deg); } }`;\r\n\r\nif (typeof document !== 'undefined') {\r\n  const s = document.createElement('style');\r\n  s.innerHTML = `\r\n      @import url(\"https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css\");\r\n      ${spinAnime}\r\n      * { font-size: 14px !important; font-weight: 400 !important; font-family: inherit; box-sizing: border-box; }\r\n      input, select, button, textarea { font-size: 14px !important; font-weight: 400 !important; font-family: inherit; border-radius: inherit; }\r\n      input[type=number]::-webkit-outer-spin-button,\r\n      input[type=number]::-webkit-inner-spin-button {-webkit - appearance: none; margin: 0; }\r\n      input[type=number] {-moz - appearance: textfield; appearance: textfield; }\r\n      th, td { font-size: 14px !important; font-weight: 400 !important; font-family: '\"Pretendard Variable\", Pretendard, sans-serif' !important; }\r\n      table input {background: transparent !important; }\r\n      table {width: 100%; border-collapse: collapse; }\r\n      th {vertical - align: middle; }\r\n      td {vertical - align: middle; }\r\n      `;\r\n  document.head.appendChild(s);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\data\\mockData.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\SubjectManagementView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\TraditionalLedgerView.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'selPro' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"selPro"},"fix":{"range":[732,740],"text":""},"desc":"Remove unused variable 'selPro'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'tdMokLabel' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":723,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":733,"suggestions":[{"messageId":"removeVar","data":{"varName":"tdMokLabel"},"fix":{"range":[1421,1433],"text":""},"desc":"Remove unused variable 'tdMokLabel'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'tdCalcNumCell' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":826,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":839,"suggestions":[{"messageId":"removeVar","data":{"varName":"tdCalcNumCell"},"fix":{"range":[1524,1539],"text":""},"desc":"Remove unused variable 'tdCalcNumCell'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'wfBadge' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":1369,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":1376,"suggestions":[{"messageId":"removeVar","data":{"varName":"wfBadge"},"fix":{"range":[2067,2076],"text":""},"desc":"Remove unused variable 'wfBadge'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'wfLogBtnNew' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":1388,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":1399,"suggestions":[{"messageId":"removeVar","data":{"varName":"wfLogBtnNew"},"fix":{"range":[2086,2099],"text":""},"desc":"Remove unused variable 'wfLogBtnNew'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'wfCommentBtn' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":1431,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":1443,"suggestions":[{"messageId":"removeVar","data":{"varName":"wfCommentBtn"},"fix":{"range":[2129,2143],"text":""},"desc":"Remove unused variable 'wfCommentBtn'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'wfBtn' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":1775,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":1780,"suggestions":[{"messageId":"removeVar","data":{"varName":"wfBtn"},"fix":{"range":[2473,2480],"text":""},"desc":"Remove unused variable 'wfBtn'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'wfBtnGhost' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":1782,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":1792,"suggestions":[{"messageId":"removeVar","data":{"varName":"wfBtnGhost"},"fix":{"range":[2480,2492],"text":""},"desc":"Remove unused variable 'wfBtnGhost'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'wfBtnWarn' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":15,"column":1794,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":1803,"suggestions":[{"messageId":"removeVar","data":{"varName":"wfBtnWarn"},"fix":{"range":[2492,2503],"text":""},"desc":"Remove unused variable 'wfBtnWarn'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'openLogPopover' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":152,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":152,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"openLogPopover"},"fix":{"range":[8673,9937],"text":""},"desc":"Remove unused variable 'openLogPopover'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'runDeptWorkflow' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1046,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1046,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"runDeptWorkflow"},"fix":{"range":[45123,45165],"text":""},"desc":"Remove unused variable 'runDeptWorkflow'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'canSubmitDept' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1091,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1091,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"canSubmitDept"},"fix":{"range":[46701,46784],"text":""},"desc":"Remove unused variable 'canSubmitDept'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'canApproveDept' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1092,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1092,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"canApproveDept"},"fix":{"range":[46788,46945],"text":""},"desc":"Remove unused variable 'canApproveDept'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'canRejectDept' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1093,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1093,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"canRejectDept"},"fix":{"range":[46949,47105],"text":""},"desc":"Remove unused variable 'canRejectDept'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'canReopenDept' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1094,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1094,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"canReopenDept"},"fix":{"range":[47109,47190],"text":""},"desc":"Remove unused variable 'canReopenDept'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'progressCounts' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1103,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1103,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"progressCounts"},"fix":{"range":[47725,48264],"text":""},"desc":"Remove unused variable 'progressCounts'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'orgId' is defined but never used.","line":1226,"column":88,"nodeType":"Identifier","messageId":"unusedVar","endLine":1226,"endColumn":93,"suggestions":[{"messageId":"removeVar","data":{"varName":"orgId"},"fix":{"range":[52980,52987],"text":""},"desc":"Remove unused variable 'orgId'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'COMMENT_TYPE_BADGE'. Either include it or remove the dependency array.","line":1312,"column":6,"nodeType":"ArrayExpression","endLine":1312,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [COMMENT_TYPE_BADGE]","fix":{"range":[56811,56830],"text":"[COMMENT_TYPE_BADGE]"}}]}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import React, { useEffect, useMemo, useState, useCallback, useRef } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport * as XLSX from 'xlsx';\r\nimport { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';\r\nimport {\r\n  AlertCircle, Download, GripVertical, HelpCircle, MessageSquare, MoreHorizontal, Plus, Save, Trash2, X\r\n} from 'lucide-react';\r\nimport {\r\n  COLORS, num, formatDate, toDateOnly, dayDiff, apiErrorMessage\r\n} from './traditionalLedger/shared';\r\nimport { btnG, btnP } from './traditionalLedger/uiStyles';\r\nimport { useExcelExport } from './traditionalLedger/hooks/useExcelExport';\r\nimport { useWorkflow } from './traditionalLedger/hooks/useWorkflow';\r\nimport {\r\n  ledgerLayout, _ctrlBar, _fBox, selPro, plannerSectionTitle, plannerStatusPill, plannerStatusPillOpen, _plannerStatusPillLocked, plannerSelectGrid, plannerFieldBlock, plannerFieldLabel, plannerSelect, plannerModalBackdrop, plannerModalCard, plannerModalHead, plannerModalTitle, plannerModalSubTitle, plannerModalBody, plannerVersionList, plannerVersionItem, plannerVersionItemActive, plannerVersionTop, plannerVersionName, plannerVersionMeta, plannerModalScope, plannerModalFooter, plannerModalEmpty, _balanceCard, _balItem, _balVal, _balSep, btnWhite, btnPlus, _modeSw, _mBtn, sheetContainer, sheetTable, thStyle, thNum, thCalcMerged, rowGwan, rowHang, rowMok, rowDetail, tdSpanned, tdEmpty, tdBase, tdAmtSum, tdAmtMok, tdMokLabel, tdMokLabelAction, tdMokLabelActionCompact, tdCalcBase, tdBlank, tdBudgetBlank, _tdNumCell, tdCalcNumCell, tdCalcNameCell, tdCalcPriceCell, tdCalcQtyCell, _tdCenterCell, _tdCalcCenterCell, tdCalcUnitOpCell, tdCalcAmountCell, tdAmtMokCompact, _tdCalcTailUnitCell, formulaUnitOpWrap, formulaOperator, _formulaBox, _orderBtns, fName, fPrice, fQty, fFreq, fUnit, _fRes, _addMin, _io, _ioDanger, _lOv, _lCd, _lF, _lI, _lB, _mBs, _lvBadge, _sCodeIn, _sNameIn, _sActGroup, _btnIcon, _btnIconD, mokCellWrap, mokInlineHead, mokNameText, mokActionPopoverWrap, mokActionTrigger, mokActionPopover, bubbleActionBtn, bubbleActionBtnDanger, _wfWrap, wfBadge, wfLogBtn, wfLogBtnNew, wfRejectLogBtn, wfLogSparkle, wfCommentBtn, tabLogBanner, tabLogBannerLabel, logGroupSection, logGroupSectionTitle, logGroupMore, logPopoverCard, logPopoverHead, logPopoverHeadText, logPopoverTitle, logPopoverSubtitle, logPopoverCloseBtn, logPopoverList, logItemRow, logItemMeta, logItemFlow, logItemReason, logItemEmpty, logPopoverFoot, logPopoverCount, logPopoverMoreBtn, wfBtn, wfBtnGhost, wfBtnWarn, _overviewCard, _overviewTopRow, _overviewMetricGroup, _overviewMetric, _overviewMetricLabel, _overviewMetricValue, _overviewStatusArea, _overviewStatusText, _overviewFlowWrap, _overviewTrack, _overviewTrackFill, _overviewSteps, _overviewStepItem, _overviewStepDot, _overviewStepText, _overviewHint, _overviewActionRow, _overviewPermissionText, _flowGuide, _deptFlowPanel, tableBottomPad, _explorerCard, _subjectRow, _subjectIcon, _lvlBadge, _masterWrapper, _mH, _btnLink, toastViewport, toastItem, toastItemSuccess, toastItemError\r\n} from './traditionalLedger/styles';\r\nimport AutoResizeInput from './traditionalLedger/components/AutoResizeInput';\r\nimport QuickAddModal from './traditionalLedger/components/QuickAddModal';\r\nimport CommentThread from '../menu/pages/DepartmentApproval/CommentThread';\r\n\r\n// Backup source: src/App.jsx\r\n// Component: TraditionalLedgerView\r\n// Snapshot date: 2026-02-12\r\n\r\nconst toLogMarker = (log) => {\r\n  if (!log) return '';\r\n  return String(\r\n    log.id ||\r\n    `${log.created_at || ''}:${log.from_status || ''}:${log.to_status || ''}:${log.reason || ''}`\r\n  );\r\n};\r\n\r\nconst formatLogDateTime = (value) => {\r\n  if (!value) return '-';\r\n  const dt = new Date(value);\r\n  if (Number.isNaN(dt.getTime())) return String(value);\r\n  return dt.toLocaleString('ko-KR', { hour12: false });\r\n};\r\n\r\nconst isRejectLog = (log) => (\r\n  log?.to_status === 'DRAFT' && String(log?.reason || '').trim()\r\n);\r\n\r\nexport default function TraditionalLedgerView({\r\n  authAxios,\r\n  entries,\r\n  subjects,\r\n  projects = [],\r\n  orgs,\r\n  onRefresh,\r\n  modalApi,\r\n  version,\r\n  versions,\r\n  setVersion,\r\n  user,\r\n  targetDeptId,\r\n  targetTeamId,\r\n  focusEntryId,\r\n  focusEntryIds,\r\n  showCombinedTypeView = false,\r\n  embeddedMode\r\n}) {\r\n  const [selectedDeptId, setSelectedDeptId] = useState(targetDeptId || null);\r\n  const [selectedTeamId, setSelectedTeamId] = useState(targetTeamId || null);\r\n\r\n  useEffect(() => {\r\n    if (targetDeptId) setSelectedDeptId(targetDeptId);\r\n  }, [targetDeptId]);\r\n\r\n  useEffect(() => {\r\n    if (targetTeamId) setSelectedTeamId(targetTeamId);\r\n  }, [targetTeamId]);\r\n\r\n  const [projectId, setProjectId] = useState(null);\r\n  const [viewType, setViewType] = useState('expense');\r\n  const [isAddOpen, setIsAddOpen] = useState(false);\r\n  const [localDetails, setLocalDetails] = useState({});\r\n  const [addingEntryId, setAddingEntryId] = useState(null);\r\n  const [deletingDetailId, setDeletingDetailId] = useState(null);\r\n  const [focusDetailId, setFocusDetailId] = useState(null);\r\n  const [openMokActionEntryId, setOpenMokActionEntryId] = useState(null);\r\n  const [mokActionAnchor, setMokActionAnchor] = useState(null);\r\n  const [commentEntryId, setCommentEntryId] = useState(null);\r\n  const [commentSubjectTarget, setCommentSubjectTarget] = useState(null); // { subjectId, orgId, label }\r\n  const [bulkCommentDialog, setBulkCommentDialog] = useState(null); // { commentType, subjectId, orgId, label, versionId }\r\n  const [bulkPosting, setBulkPosting] = useState(false);\r\n  const mokActionRefs = useRef({});\r\n  const mokActionPopoverRef = useRef(null);\r\n  const [openHierarchyActionId, setOpenHierarchyActionId] = useState(null);\r\n  const [hierarchyActionAnchor, setHierarchyActionAnchor] = useState(null);\r\n  const hierarchyActionRefs = useRef({});\r\n  const hierarchyActionPopoverRef = useRef(null);\r\n  const [isHierarchyAddMenuOpen, setIsHierarchyAddMenuOpen] = useState(false);\r\n  const [hierarchySelectedGwanId, setHierarchySelectedGwanId] = useState('');\r\n  const [hierarchySelectedHangId, setHierarchySelectedHangId] = useState('');\r\n  const [hierarchySelectedMokId, setHierarchySelectedMokId] = useState('');\r\n  const [hierarchyAddLoading, setHierarchyAddLoading] = useState(false);\r\n  const [toastItems, setToastItems] = useState([]);\r\n  const [isRoundSelectModalOpen, setIsRoundSelectModalOpen] = useState(false);\r\n  const [modalVersionId, setModalVersionId] = useState('');\r\n  const [modalDeptId, setModalDeptId] = useState('');\r\n  const [modalTeamId, setModalTeamId] = useState('');\r\n  const [entryLogsById, setEntryLogsById] = useState({});\r\n  const [openLogEntry, setOpenLogEntry] = useState(null);\r\n  const [logAnchor, setLogAnchor] = useState(null);\r\n  const [newLogEntries, setNewLogEntries] = useState({});\r\n  const logPopoverRef = useRef(null);\r\n  const autoSaveTimersRef = useRef({});\r\n  const autoSavePendingRef = useRef({});\r\n  const autoSaveAbortRef = useRef({});\r\n  const autoSaveSuccessAtRef = useRef(0);\r\n  const initialVersionGuideRef = useRef(false);\r\n  const logMarkersRef = useRef({});\r\n  const hasLogBaselineRef = useRef(false);\r\n  const embeddedModalZBase = embeddedMode ? 21000 : 0;\r\n  const roundSelectZIndex = embeddedModalZBase ? embeddedModalZBase + 10 : plannerModalBackdrop.zIndex;\r\n  const workflowModalZIndex = embeddedModalZBase ? embeddedModalZBase + 20 : 9999;\r\n  const actionPopoverZIndex = embeddedModalZBase ? embeddedModalZBase + 30 : mokActionPopover.zIndex;\r\n  const logPopoverZIndex = embeddedModalZBase ? embeddedModalZBase + 40 : logPopoverCard.zIndex;\r\n  const toastZIndex = embeddedModalZBase ? embeddedModalZBase + 50 : toastViewport.zIndex;\r\n  const nestedOverlayZIndex = embeddedModalZBase ? embeddedModalZBase + 60 : undefined;\r\n  const commentPanelZIndex = embeddedModalZBase ? embeddedModalZBase + 45 : 19500;\r\n\r\n  const pushToast = useCallback((message, type = 'success') => {\r\n    const id = Date.now() + Math.random();\r\n    setToastItems(prev => [...prev, { id, message, type }]);\r\n    window.setTimeout(() => {\r\n      setToastItems(prev => prev.filter(item => item.id !== id));\r\n    }, 2200);\r\n  }, []);\r\n\r\n  const closeMokAction = useCallback(() => {\r\n    setOpenMokActionEntryId(null);\r\n    setMokActionAnchor(null);\r\n  }, []);\r\n\r\n  const closeHierarchyAction = useCallback(() => {\r\n    setOpenHierarchyActionId(null);\r\n    setHierarchyActionAnchor(null);\r\n    setIsHierarchyAddMenuOpen(false);\r\n    setHierarchySelectedGwanId('');\r\n    setHierarchySelectedHangId('');\r\n    setHierarchySelectedMokId('');\r\n    setHierarchyAddLoading(false);\r\n  }, []);\r\n\r\n  const closeLogPopover = useCallback(() => {\r\n    setOpenLogEntry(null);\r\n    setLogAnchor(null);\r\n  }, []);\r\n\r\n  const openLogPopover = useCallback((entry, buttonEl, mode = 'change') => {\r\n    const targetId = Number(entry.id);\r\n    if (openLogEntry?.id === targetId && openLogEntry?.mode === mode && !openLogEntry?.groupKey) {\r\n      closeLogPopover();\r\n      return;\r\n    }\r\n    const rect = buttonEl.getBoundingClientRect();\r\n    const menuWidth = 336;\r\n    const menuHeight = 216;\r\n    const edge = 8;\r\n    const downTop = rect.bottom + 6;\r\n    const upTop = rect.top - menuHeight - 6;\r\n    const nextTop = downTop + menuHeight <= window.innerHeight - edge ? downTop : Math.max(edge, upTop);\r\n    const nextLeft = Math.min(\r\n      Math.max(rect.left - menuWidth + rect.width, edge),\r\n      Math.max(edge, window.innerWidth - menuWidth - edge)\r\n    );\r\n    setLogAnchor({ top: nextTop, left: nextLeft });\r\n    setOpenLogEntry({\r\n      id: targetId,\r\n      title: entry.subject_name || entry.subject_code || `항목 ${targetId}`,\r\n      mode,\r\n      groupKey: null,\r\n      entryIds: null,\r\n    });\r\n    setNewLogEntries((prev) => {\r\n      const key = String(targetId);\r\n      if (!prev[key]) return prev;\r\n      const next = { ...prev };\r\n      delete next[key];\r\n      return next;\r\n    });\r\n  }, [openLogEntry?.id, openLogEntry?.mode, openLogEntry?.groupKey, closeLogPopover]);\r\n\r\n  // 관/항 단위 팝오버 열기\r\n  const openGroupLogPopover = useCallback((groupKey, groupTitle, entryIds, buttonEl, mode = 'change') => {\r\n    if (openLogEntry?.groupKey === groupKey && openLogEntry?.mode === mode) {\r\n      closeLogPopover();\r\n      return;\r\n    }\r\n    const rect = buttonEl.getBoundingClientRect();\r\n    const menuWidth = 336;\r\n    const menuHeight = 260;\r\n    const edge = 8;\r\n    const downTop = rect.bottom + 6;\r\n    const upTop = rect.top - menuHeight - 6;\r\n    const nextTop = downTop + menuHeight <= window.innerHeight - edge ? downTop : Math.max(edge, upTop);\r\n    const nextLeft = Math.min(\r\n      Math.max(rect.left - menuWidth + rect.width, edge),\r\n      Math.max(edge, window.innerWidth - menuWidth - edge)\r\n    );\r\n    setLogAnchor({ top: nextTop, left: nextLeft });\r\n    setOpenLogEntry({\r\n      id: null,\r\n      title: groupTitle,\r\n      mode,\r\n      groupKey,\r\n      entryIds,\r\n    });\r\n    // 해당 entry들의 신규 로그 하이라이트 해제\r\n    setNewLogEntries((prev) => {\r\n      const hasAny = entryIds.some(eid => prev[String(eid)]);\r\n      if (!hasAny) return prev;\r\n      const next = { ...prev };\r\n      entryIds.forEach(eid => { delete next[String(eid)]; });\r\n      return next;\r\n    });\r\n  }, [openLogEntry?.groupKey, openLogEntry?.mode, closeLogPopover]);\r\n\r\n  const openMokAction = useCallback((entryId, buttonEl) => {\r\n    const rect = buttonEl.getBoundingClientRect();\r\n    const menuWidth = 156;\r\n    const menuHeight = 88;\r\n    const edge = 8;\r\n    const downTop = rect.bottom + 6;\r\n    const upTop = rect.top - menuHeight - 6;\r\n    const nextTop = downTop + menuHeight <= window.innerHeight - edge ? downTop : Math.max(edge, upTop);\r\n    const nextLeft = Math.min(\r\n      Math.max(rect.left, edge),\r\n      Math.max(edge, window.innerWidth - menuWidth - edge)\r\n    );\r\n    setMokActionAnchor({ top: nextTop, left: nextLeft });\r\n    setOpenMokActionEntryId(entryId);\r\n  }, []);\r\n\r\n  const openHierarchyAction = useCallback((subjectId, buttonEl) => {\r\n    const rect = buttonEl.getBoundingClientRect();\r\n    const menuWidth = 560;\r\n    const menuHeight = 320;\r\n    const edge = 8;\r\n    const downTop = rect.bottom + 6;\r\n    const upTop = rect.top - menuHeight - 6;\r\n    const nextTop = downTop + menuHeight <= window.innerHeight - edge ? downTop : Math.max(edge, upTop);\r\n    const nextLeft = Math.min(\r\n      Math.max(rect.left, edge),\r\n      Math.max(edge, window.innerWidth - menuWidth - edge)\r\n    );\r\n    setHierarchyActionAnchor({ top: nextTop, left: nextLeft });\r\n    setOpenHierarchyActionId(subjectId);\r\n    setIsHierarchyAddMenuOpen(false);\r\n    setHierarchySelectedGwanId('');\r\n    setHierarchySelectedHangId('');\r\n    setHierarchySelectedMokId('');\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (openMokActionEntryId == null) return undefined;\r\n\r\n    const handleOutside = (event) => {\r\n      const wrapper = mokActionRefs.current[openMokActionEntryId];\r\n      const popover = mokActionPopoverRef.current;\r\n      if (wrapper && wrapper.contains(event.target)) return;\r\n      if (popover && popover.contains(event.target)) return;\r\n      closeMokAction();\r\n    };\r\n    const handleEsc = (event) => {\r\n      if (event.key === 'Escape') closeMokAction();\r\n    };\r\n    const handleViewportChange = () => {\r\n      closeMokAction();\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleOutside);\r\n    document.addEventListener('touchstart', handleOutside);\r\n    document.addEventListener('keydown', handleEsc);\r\n    window.addEventListener('resize', handleViewportChange);\r\n    window.addEventListener('scroll', handleViewportChange, true);\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleOutside);\r\n      document.removeEventListener('touchstart', handleOutside);\r\n      document.removeEventListener('keydown', handleEsc);\r\n      window.removeEventListener('resize', handleViewportChange);\r\n      window.removeEventListener('scroll', handleViewportChange, true);\r\n    };\r\n  }, [openMokActionEntryId, closeMokAction]);\r\n\r\n  useEffect(() => {\r\n    if (openHierarchyActionId == null) return undefined;\r\n\r\n    const handleOutside = (event) => {\r\n      const wrapper = hierarchyActionRefs.current[openHierarchyActionId];\r\n      const popover = hierarchyActionPopoverRef.current;\r\n      if (wrapper && wrapper.contains(event.target)) return;\r\n      if (popover && popover.contains(event.target)) return;\r\n      closeHierarchyAction();\r\n    };\r\n    const handleEsc = (event) => {\r\n      if (event.key === 'Escape') closeHierarchyAction();\r\n    };\r\n    const handleViewportChange = () => {\r\n      closeHierarchyAction();\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleOutside);\r\n    document.addEventListener('touchstart', handleOutside);\r\n    document.addEventListener('keydown', handleEsc);\r\n    window.addEventListener('resize', handleViewportChange);\r\n    window.addEventListener('scroll', handleViewportChange, true);\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleOutside);\r\n      document.removeEventListener('touchstart', handleOutside);\r\n      document.removeEventListener('keydown', handleEsc);\r\n      window.removeEventListener('resize', handleViewportChange);\r\n      window.removeEventListener('scroll', handleViewportChange, true);\r\n    };\r\n  }, [openHierarchyActionId, closeHierarchyAction]);\r\n\r\n  useEffect(() => {\r\n    if (!openLogEntry?.id && !openLogEntry?.groupKey) return undefined;\r\n\r\n    const handleOutside = (event) => {\r\n      const popover = logPopoverRef.current;\r\n      if (popover && popover.contains(event.target)) return;\r\n      // 목 단위 버튼 클릭은 openLogPopover에서 처리\r\n      if (openLogEntry?.id && event.target instanceof Element && event.target.closest(`[data-log-entry-btn=\"${openLogEntry.id}\"]`)) return;\r\n      // 그룹 버튼 클릭은 openGroupLogPopover에서 처리\r\n      if (openLogEntry?.groupKey && event.target instanceof Element && event.target.closest(`[data-log-entry-btn=\"${openLogEntry.groupKey}\"]`)) return;\r\n      closeLogPopover();\r\n    };\r\n    const handleEsc = (event) => {\r\n      if (event.key === 'Escape') closeLogPopover();\r\n    };\r\n    const handleViewportChange = () => {\r\n      closeLogPopover();\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleOutside);\r\n    document.addEventListener('touchstart', handleOutside);\r\n    document.addEventListener('keydown', handleEsc);\r\n    window.addEventListener('resize', handleViewportChange);\r\n    window.addEventListener('scroll', handleViewportChange, true);\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleOutside);\r\n      document.removeEventListener('touchstart', handleOutside);\r\n      document.removeEventListener('keydown', handleEsc);\r\n      window.removeEventListener('resize', handleViewportChange);\r\n      window.removeEventListener('scroll', handleViewportChange, true);\r\n    };\r\n  }, [openLogEntry, closeLogPopover]);\r\n\r\n  useEffect(() => () => {\r\n    Object.values(autoSaveTimersRef.current).forEach(timerId => clearTimeout(timerId));\r\n    Object.values(autoSaveAbortRef.current).forEach(controller => {\r\n      try { controller.abort(); } catch { /* ignore */ }\r\n    });\r\n  }, []);\r\n\r\n  const isAdminUser = user?.role === 'ADMIN';\r\n  const departments = useMemo(() => orgs.filter(o => o.org_type !== 'team' && !o.parent), [orgs]);\r\n  const teams = useMemo(() => orgs.filter(o => o.org_type === 'team' || !!o.parent), [orgs]);\r\n  const myOrg = useMemo(() => orgs.find(o => Number(o.id) === Number(user?.organization)), [orgs, user?.organization]);\r\n  const myDeptId = useMemo(() => {\r\n    if (!myOrg) return null;\r\n    if (myOrg.org_type === 'team' || myOrg.parent) return Number(myOrg.parent);\r\n    return Number(myOrg.id);\r\n  }, [myOrg]);\r\n  const selectableDepartments = useMemo(() => {\r\n    if (isAdminUser) return departments;\r\n    if (!myDeptId) return [];\r\n    return departments.filter(d => Number(d.id) === Number(myDeptId));\r\n  }, [departments, isAdminUser, myDeptId]);\r\n  const teamsOfDept = useMemo(() => teams.filter(t => Number(t.parent) === Number(selectedDeptId)), [teams, selectedDeptId]);\r\n  const selectableTeams = useMemo(() => {\r\n    if (isAdminUser) return teamsOfDept;\r\n    if (!myDeptId) return [];\r\n    if (Number(selectedDeptId) !== Number(myDeptId)) return [];\r\n    return teamsOfDept;\r\n  }, [isAdminUser, teamsOfDept, myDeptId, selectedDeptId]);\r\n  const selectedScopeOrgId = selectedTeamId || selectedDeptId || null;\r\n  const selectedScopeOrgIds = useMemo(() => {\r\n    if (selectedTeamId) return [Number(selectedTeamId)];\r\n    if (!selectedDeptId) return [];\r\n    const deptId = Number(selectedDeptId);\r\n    return [deptId, ...teams.filter(t => Number(t.parent) === deptId).map(t => Number(t.id))];\r\n  }, [selectedTeamId, selectedDeptId, teams]);\r\n  const modalTeamsOfDept = useMemo(() => {\r\n    if (!modalDeptId) return [];\r\n    return teams.filter(t => Number(t.parent) === Number(modalDeptId));\r\n  }, [teams, modalDeptId]);\r\n  const modalSelectableTeams = useMemo(() => {\r\n    if (isAdminUser) return modalTeamsOfDept;\r\n    if (!myDeptId) return [];\r\n    if (Number(modalDeptId) !== Number(myDeptId)) return [];\r\n    return modalTeamsOfDept;\r\n  }, [isAdminUser, modalTeamsOfDept, myDeptId, modalDeptId]);\r\n\r\n  const openHierarchyParentSubject = useMemo(() => {\r\n    if (!openHierarchyActionId) return null;\r\n    const [, rawId] = String(openHierarchyActionId).split('-');\r\n    const subjectId = Number(rawId);\r\n    if (!Number.isFinite(subjectId)) return null;\r\n    return subjects.find(subject => Number(subject.id) === subjectId) || null;\r\n  }, [openHierarchyActionId, subjects]);\r\n\r\n  const usedMokIdsInScope = useMemo(() => {\r\n    if (!selectedScopeOrgId || !version?.year) return new Set();\r\n    const used = new Set();\r\n    entries.forEach((entry) => {\r\n      if (Number(entry.organization) !== Number(selectedScopeOrgId)) return;\r\n      if (Number(entry.year) !== Number(version.year)) return;\r\n      if (Number(entry.supplemental_round ?? 0) !== Number(version.round ?? 0)) return;\r\n      if (Number(entry.entrusted_project || 0) !== Number(projectId || 0)) return;\r\n      used.add(Number(entry.subject));\r\n    });\r\n    return used;\r\n  }, [entries, selectedScopeOrgId, version?.year, version?.round, projectId]);\r\n\r\n  const hierarchyStepOptions = useMemo(() => {\r\n    if (!openHierarchyParentSubject) {\r\n      return { level: 0, gwanOptions: [], hangOptions: [], mokOptions: [] };\r\n    }\r\n    const level = Number(openHierarchyParentSubject.level || 0);\r\n    const parentId = Number(openHierarchyParentSubject.id);\r\n    const subjectType = openHierarchyParentSubject.subject_type;\r\n    const filtered = subjects.filter(subject => subject.subject_type === subjectType);\r\n    const gwanOptions = level === 1\r\n      ? filtered.filter(subject => Number(subject.parent) === parentId && Number(subject.level) === 2)\r\n      : [];\r\n    const hangParentId = level === 2 ? parentId : Number(hierarchySelectedGwanId || 0);\r\n    const hangOptions = (level <= 2 && hangParentId)\r\n      ? filtered.filter(subject => Number(subject.parent) === hangParentId && Number(subject.level) === 3)\r\n      : [];\r\n    const mokParentId = level === 3 ? parentId : Number(hierarchySelectedHangId || 0);\r\n    const mokOptions = (level <= 3 && mokParentId)\r\n      ? filtered.filter(subject => Number(subject.parent) === mokParentId && Number(subject.level) === 4)\r\n      : [];\r\n    return { level, gwanOptions, hangOptions, mokOptions };\r\n  }, [openHierarchyParentSubject, subjects, hierarchySelectedGwanId, hierarchySelectedHangId]);\r\n\r\n  useEffect(() => {\r\n    hasLogBaselineRef.current = false;\r\n    logMarkersRef.current = {};\r\n    setNewLogEntries({});\r\n    setOpenLogEntry(null);\r\n    setLogAnchor(null);\r\n  }, [selectedScopeOrgId, version?.id]);\r\n\r\n  useEffect(() => {\r\n    if (!selectableDepartments.length) return;\r\n    const exists = selectableDepartments.some(d => Number(d.id) === Number(selectedDeptId));\r\n    if (!exists) setSelectedDeptId(selectableDepartments[0].id);\r\n  }, [selectableDepartments, selectedDeptId]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedDeptId || selectedTeamId) return;\r\n    if (!myOrg || isAdminUser) return;\r\n    if (Number(myOrg.parent) === Number(selectedDeptId)) {\r\n      setSelectedTeamId(Number(myOrg.id));\r\n    }\r\n  }, [selectedDeptId, selectedTeamId, myOrg, isAdminUser]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedTeamId) return;\r\n    const stillExists = selectableTeams.some(t => Number(t.id) === Number(selectedTeamId));\r\n    if (!stillExists) setSelectedTeamId(null);\r\n  }, [selectedTeamId, selectableTeams]);\r\n\r\n  const pEntries = useMemo(() => entries.filter(e =>\r\n    Number(e.year) === Number(version?.year) &&\r\n    (!selectedScopeOrgIds.length || selectedScopeOrgIds.includes(Number(e.organization))) &&\r\n    (!focusEntryId || Number(e.id) === Number(focusEntryId)) &&\r\n    (!(Array.isArray(focusEntryIds) && focusEntryIds.length) || focusEntryIds.includes(Number(e.id)))\r\n  ), [entries, selectedScopeOrgIds, version, focusEntryId, focusEntryIds]);\r\n\r\n  const subjectTypeById = useMemo(() => {\r\n    const map = {};\r\n    subjects.forEach((subject) => {\r\n      map[Number(subject.id)] = subject.subject_type;\r\n    });\r\n    return map;\r\n  }, [subjects]);\r\n\r\n  const calcEntryAmount = useCallback((entry) => {\r\n    const details = Array.isArray(entry?.details) ? entry.details : [];\r\n    if (details.length > 0) {\r\n      return details.reduce((sum, d) => {\r\n        const p = Number(localDetails[d.id]?.price ?? d.price ?? 0);\r\n        const q = Number(localDetails[d.id]?.qty ?? d.qty ?? 0);\r\n        const f = Number(localDetails[d.id]?.freq ?? d.freq ?? 0);\r\n        return sum + (p * q * f);\r\n      }, 0);\r\n    }\r\n    return Number(entry?.total_amount || 0);\r\n  }, [localDetails]);\r\n\r\n  const activeEntries = useMemo(() => {\r\n    if (showCombinedTypeView) return pEntries;\r\n    return pEntries.filter(e => subjectTypeById[Number(e.subject)] === viewType);\r\n  }, [pEntries, subjectTypeById, viewType, showCombinedTypeView]);\r\n  const inputAvailableVersions = useMemo(() => (\r\n    [...versions]\r\n      .filter(v => v.status === 'PENDING')\r\n      .sort((a, b) => b.year - a.year || b.round - a.round)\r\n  ), [versions]);\r\n  const editableEntries = useMemo(() => (\r\n    activeEntries.filter(e => (e.status || 'DRAFT') === 'DRAFT')\r\n  ), [activeEntries]);\r\n  const enteredCount = useMemo(() => editableEntries.filter(e => (e.details || []).length > 0).length, [editableEntries]);\r\n  const totalEditableCount = editableEntries.length;\r\n  const inputProgressRatio = totalEditableCount ? Math.round((enteredCount / totalEditableCount) * 100) : 0;\r\n  const selectedVersionPeriod = useMemo(() => {\r\n    const start = toDateOnly(version?.start_date);\r\n    const end = toDateOnly(version?.end_date);\r\n    const today = toDateOnly(new Date());\r\n    if (!start && !end) return { periodText: '미지정', deadlineText: '입력기간 미지정' };\r\n    if (!today) return { periodText: `${formatDate(start)} ~ ${formatDate(end)}`, deadlineText: '-' };\r\n\r\n    const periodText = `${formatDate(start)} ~ ${formatDate(end)}`;\r\n    if (start && today < start) return { periodText, deadlineText: `시작 전 D-${dayDiff(start, today)}` };\r\n    if (end && today > end) return { periodText, deadlineText: `마감 +${dayDiff(today, end)}일` };\r\n    if (end && dayDiff(end, today) === 0) return { periodText, deadlineText: '오늘 마감 (D-Day)' };\r\n    if (end) return { periodText, deadlineText: `마감 D-${dayDiff(end, today)}` };\r\n    return { periodText, deadlineText: '진행중' };\r\n  }, [version?.start_date, version?.end_date]);\r\n  const selectedDeptName = useMemo(() => {\r\n    const target = departments.find(d => Number(d.id) === Number(selectedDeptId));\r\n    return target?.name || '-';\r\n  }, [departments, selectedDeptId]);\r\n  const _guidePreview = useMemo(() => {\r\n    const text = String(version?.guidelines || '').trim();\r\n    if (!text) return '입력 지침이 아직 등록되지 않았습니다.';\r\n    if (text.length <= 80) return text;\r\n    return `${text.slice(0, 80)}...`;\r\n  }, [version?.guidelines]);\r\n\r\n  const { incTotal, expTotal } = useMemo(() => (\r\n    pEntries.reduce((acc, entry) => {\r\n      const subjectType = subjectTypeById[Number(entry.subject)];\r\n      if (!subjectType) return acc;\r\n      const amount = calcEntryAmount(entry);\r\n      if (subjectType === 'income') acc.incTotal += amount;\r\n      if (subjectType === 'expense') acc.expTotal += amount;\r\n      return acc;\r\n    }, { incTotal: 0, expTotal: 0 })\r\n  ), [pEntries, subjectTypeById, calcEntryAmount]);\r\n  const diffTotal = incTotal - expTotal;\r\n  const maxCompare = Math.max(incTotal, expTotal, 1);\r\n  const _incRatio = (incTotal / maxCompare) * 100;\r\n  const _expRatio = (expTotal / maxCompare) * 100;\r\n  const isBalanced = incTotal === expTotal;\r\n  const isVersionEditable = Boolean(version && version.status === 'PENDING');\r\n  const versionStatusLabel = { DRAFT: '준비중', PENDING: '대기', CONFIRMED: '확정', CLOSED: '마감됨' };\r\n  const versionLockMessage = '현재 회차는 잠금 상태입니다. 대기 상태 회차에서만 입력할 수 있습니다.';\r\n  const EDIT_BLOCKED_MSG = '현재 상태에서는 산출내역을 추가할 수 없습니다. 부서 상태를 작성중(DRAFT)으로 되돌린 뒤 다시 시도하세요.';\r\n  const statusLabel = useMemo(() => ({ DRAFT: '작성중', PENDING: '제출', REVIEWING: '검토중', FINALIZED: '확정', MIXED: '혼합상태' }), []);\r\n\r\n  const deptEntries = useMemo(() => entries.filter(e =>\r\n    (!selectedScopeOrgIds.length || selectedScopeOrgIds.includes(Number(e.organization))) &&\r\n    Number(e.year) === Number(version?.year) &&\r\n    Number(e.supplemental_round ?? 0) === Number(version?.round ?? 0)\r\n  ), [entries, selectedScopeOrgIds, version]);\r\n  const deptEntryIds = useMemo(\r\n    () => deptEntries.map(entry => Number(entry.id)).filter(id => Number.isFinite(id)),\r\n    [deptEntries]\r\n  );\r\n  const deptStatus = useMemo(() => {\r\n    if (!deptEntries.length) return 'DRAFT';\r\n    const uniq = [...new Set(deptEntries.map(e => e.status || 'DRAFT'))];\r\n    return uniq.length === 1 ? uniq[0] : 'MIXED';\r\n  }, [deptEntries]);\r\n\r\n  const detailToEntryId = useMemo(() => {\r\n    const map = {};\r\n    entries.forEach(e => (e.details || []).forEach(d => { map[d.id] = e.id; }));\r\n    return map;\r\n  }, [entries]);\r\n\r\n  const canEditEntry = useCallback((entryId) => {\r\n    if (!isVersionEditable) return false;\r\n    const target = activeEntries.find(e => e.id === entryId) || entries.find(e => e.id === entryId);\r\n    if (!target) return false;\r\n    if (user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'REVIEWER') return true;\r\n    return target.status === 'DRAFT';\r\n  }, [isVersionEditable, activeEntries, entries, user?.role]);\r\n\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    const loadLogs = async () => {\r\n      if (!authAxios || !deptEntryIds.length) {\r\n        setEntryLogsById({});\r\n        return;\r\n      }\r\n      try {\r\n        const res = await authAxios.get('/api/logs/', {\r\n          params: {\r\n            entry_ids: deptEntryIds.join(','),\r\n            year: version?.year,\r\n            round: version?.round,\r\n          },\r\n        });\r\n        const raw = Array.isArray(res.data) ? res.data : (res.data?.results || []);\r\n        const filtered = raw\r\n          .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));\r\n        const map = {};\r\n        filtered.forEach((log) => {\r\n          const key = Number(log.entry);\r\n          if (!map[key]) map[key] = [];\r\n          map[key].push(log);\r\n        });\r\n        if (!cancelled) setEntryLogsById(map);\r\n      } catch {\r\n        if (!cancelled) setEntryLogsById({});\r\n      }\r\n    };\r\n    loadLogs();\r\n    return () => { cancelled = true; };\r\n  }, [authAxios, deptEntryIds, version?.year, version?.round]);\r\n\r\n  useEffect(() => {\r\n    const currentMarkers = {};\r\n    Object.entries(entryLogsById).forEach(([entryId, logs]) => {\r\n      const marker = toLogMarker(logs[0]);\r\n      if (marker) currentMarkers[String(entryId)] = marker;\r\n    });\r\n\r\n    if (!hasLogBaselineRef.current) {\r\n      logMarkersRef.current = currentMarkers;\r\n      hasLogBaselineRef.current = true;\r\n      return;\r\n    }\r\n\r\n    const changed = {};\r\n    Object.entries(currentMarkers).forEach(([entryId, marker]) => {\r\n      const prevMarker = logMarkersRef.current[entryId];\r\n      if (!prevMarker || prevMarker !== marker) {\r\n        changed[entryId] = true;\r\n      }\r\n    });\r\n\r\n    if (Object.keys(changed).length > 0) {\r\n      setNewLogEntries(prev => ({ ...prev, ...changed }));\r\n    }\r\n\r\n    logMarkersRef.current = currentMarkers;\r\n  }, [entryLogsById]);\r\n\r\n  useEffect(() => {\r\n    if (embeddedMode) return;\r\n    if (initialVersionGuideRef.current) return;\r\n    if (!versions.length) return;\r\n    const firstVersionId = String(version?.id || inputAvailableVersions[0]?.id || versions[0]?.id || '');\r\n    const firstDeptId = String(selectedDeptId || selectableDepartments[0]?.id || '');\r\n    setModalVersionId(firstVersionId);\r\n    setModalDeptId(firstDeptId);\r\n    setModalTeamId(selectedTeamId ? String(selectedTeamId) : '');\r\n    setIsRoundSelectModalOpen(true);\r\n    initialVersionGuideRef.current = true;\r\n  }, [versions, version?.id, inputAvailableVersions, selectedDeptId, selectableDepartments, selectedTeamId, embeddedMode]);\r\n\r\n  useEffect(() => {\r\n    if (!modalTeamId) return;\r\n    const exists = modalSelectableTeams.some(t => Number(t.id) === Number(modalTeamId));\r\n    if (!exists) setModalTeamId('');\r\n  }, [modalTeamId, modalSelectableTeams]);\r\n\r\n  const versionRelatedInfo = useCallback((targetVersion) => {\r\n    const start = toDateOnly(targetVersion?.start_date);\r\n    const end = toDateOnly(targetVersion?.end_date);\r\n    const today = toDateOnly(new Date());\r\n    const periodText = `${formatDate(start)} ~ ${formatDate(end)}`;\r\n    if (!start && !end) return { periodText: '미지정', deadlineText: '입력기간 미지정' };\r\n    if (!today) return { periodText, deadlineText: '-' };\r\n    if (start && today < start) return { periodText, deadlineText: `시작 전 D-${dayDiff(start, today)}` };\r\n    if (end && today > end) return { periodText, deadlineText: `마감 +${dayDiff(today, end)}일` };\r\n    if (end && dayDiff(end, today) === 0) return { periodText, deadlineText: '오늘 마감 (D-Day)' };\r\n    if (end) return { periodText, deadlineText: `마감 D-${dayDiff(end, today)}` };\r\n    return { periodText, deadlineText: '진행중' };\r\n  }, []);\r\n\r\n  const openRoundSelectModal = useCallback(() => {\r\n    if (embeddedMode) return;\r\n    setModalVersionId(String(version?.id || inputAvailableVersions[0]?.id || versions[0]?.id || ''));\r\n    setModalDeptId(String(selectedDeptId || selectableDepartments[0]?.id || ''));\r\n    setModalTeamId(selectedTeamId ? String(selectedTeamId) : '');\r\n    setIsRoundSelectModalOpen(true);\r\n  }, [version?.id, inputAvailableVersions, versions, selectedDeptId, selectableDepartments, selectedTeamId, embeddedMode]);\r\n\r\n  const applyRoundSelection = useCallback(() => {\r\n    if (!modalVersionId) {\r\n      pushToast('입력 회차를 선택해 주세요.', 'error');\r\n      return;\r\n    }\r\n    const nextVersion = versions.find(v => Number(v.id) === Number(modalVersionId));\r\n    if (nextVersion) setVersion(nextVersion);\r\n\r\n    const nextDeptId = Number(modalDeptId || selectableDepartments[0]?.id || 0);\r\n    if (nextDeptId) setSelectedDeptId(nextDeptId);\r\n    setSelectedTeamId(modalTeamId ? Number(modalTeamId) : null);\r\n    setProjectId(null);\r\n    setIsRoundSelectModalOpen(false);\r\n  }, [modalVersionId, modalDeptId, modalTeamId, versions, setVersion, selectableDepartments, pushToast]);\r\n\r\n  const tree = useMemo(() => {\r\n    const map = {};\r\n    activeEntries.forEach(e => {\r\n      const mok = subjects.find(s => s.id === e.subject);\r\n      if (!mok) return;\r\n\r\n      // Keep tree and top summary totals aligned with the same amount calculation.\r\n      const eAmount = calcEntryAmount(e);\r\n\r\n      const entryWithCalc = { ...e, total_amount_calc: eAmount };\r\n\r\n      const hang = subjects.find(s => s.id === mok.parent);\r\n      const gwan = hang ? subjects.find(s => s.id === hang.parent) : null;\r\n      const jangSub = gwan ? subjects.find(s => s.id === gwan.parent) : null;\r\n\r\n      const currOrg = orgs.find(o => o.id === (e.organization || selectedScopeOrgId));\r\n      const entryProject = projects.find(p => p.id === e.entrusted_project);\r\n\r\n      // 장(Jang) 명칭 결정: 프로젝트가 있으면 프로젝트명, 없으면 부서명 또는 본점\r\n      const jangName = entryProject ? entryProject.name : (currOrg?.name || '본점');\r\n      const jangKey = entryProject ? `p-${entryProject.id}` : `non-project`;\r\n\r\n      const eLastYear = Number(e.last_year_amount || 0);\r\n\r\n      if (!map[jangKey]) map[jangKey] = { name: jangName, obj: jangSub, children: {}, total: 0, lastTotal: 0 };\r\n      const gId = gwan?.id || 'none';\r\n      if (!map[jangKey].children[gId]) map[jangKey].children[gId] = { obj: gwan, children: {}, total: 0, lastTotal: 0 };\r\n      const hId = hang?.id || 'none';\r\n      if (!map[jangKey].children[gId].children[hId]) map[jangKey].children[gId].children[hId] = { obj: hang, moks: [], total: 0, lastTotal: 0 };\r\n\r\n      map[jangKey].children[gId].children[hId].moks.push({ mok, entry: entryWithCalc });\r\n      map[jangKey].total += eAmount;\r\n      map[jangKey].lastTotal += eLastYear;\r\n      map[jangKey].children[gId].total += eAmount;\r\n      map[jangKey].children[gId].lastTotal += eLastYear;\r\n      map[jangKey].children[gId].children[hId].total += eAmount;\r\n      map[jangKey].children[gId].children[hId].lastTotal += eLastYear;\r\n    });\r\n    return map;\r\n  }, [activeEntries, subjects, projects, selectedScopeOrgId, orgs, calcEntryAmount]);\r\n\r\n  const saveDetail = useCallback(async (id, data, { source = 'manual', refreshMode = 'debounced' } = {}) => {\r\n    const entryId = detailToEntryId[id];\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return false;\r\n    }\r\n    if (entryId && !canEditEntry(entryId)) {\r\n      pushToast(EDIT_BLOCKED_MSG, 'error');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      if (autoSaveAbortRef.current[id]) {\r\n        autoSaveAbortRef.current[id].abort();\r\n      }\r\n      const controller = new AbortController();\r\n      autoSaveAbortRef.current[id] = controller;\r\n      await authAxios.patch(`/api/details/${id}/`, data, { signal: controller.signal });\r\n      if (autoSaveAbortRef.current[id] === controller) {\r\n        delete autoSaveAbortRef.current[id];\r\n      }\r\n\r\n      if (refreshMode === 'immediate') {\r\n        onRefresh();\r\n      } else if (refreshMode === 'debounced') {\r\n        if (autoSaveTimersRef.current.__refresh) clearTimeout(autoSaveTimersRef.current.__refresh);\r\n        autoSaveTimersRef.current.__refresh = setTimeout(() => onRefresh(), 500);\r\n      }\r\n      return true;\r\n    } catch (e) {\r\n      if (e?.code === 'ERR_CANCELED' || e?.name === 'CanceledError') return false;\r\n      console.error(e);\r\n      pushToast(apiErrorMessage(e, source === 'auto' ? '자동저장에 실패했습니다.' : '저장에 실패했습니다.'), 'error');\r\n      return false;\r\n    }\r\n  }, [authAxios, onRefresh, detailToEntryId, canEditEntry, isVersionEditable, versionLockMessage, pushToast, EDIT_BLOCKED_MSG]);\r\n\r\n  const flushAutoSave = useCallback(async (id, patch = null) => {\r\n    if (autoSaveTimersRef.current[id]) {\r\n      clearTimeout(autoSaveTimersRef.current[id]);\r\n      delete autoSaveTimersRef.current[id];\r\n    }\r\n    const merged = { ...(autoSavePendingRef.current[id] || {}), ...(patch || {}) };\r\n    delete autoSavePendingRef.current[id];\r\n    if (Object.keys(merged).length === 0) return;\r\n    const ok = await saveDetail(id, merged, { source: 'manual', refreshMode: 'immediate' });\r\n    if (ok) pushToast('자동저장 완료', 'success');\r\n  }, [saveDetail, pushToast]);\r\n\r\n  const scheduleAutoSave = useCallback((id, patch) => {\r\n    autoSavePendingRef.current[id] = { ...(autoSavePendingRef.current[id] || {}), ...(patch || {}) };\r\n    if (autoSaveTimersRef.current[id]) clearTimeout(autoSaveTimersRef.current[id]);\r\n    autoSaveTimersRef.current[id] = setTimeout(async () => {\r\n      const merged = autoSavePendingRef.current[id] || {};\r\n      delete autoSavePendingRef.current[id];\r\n      delete autoSaveTimersRef.current[id];\r\n      if (Object.keys(merged).length === 0) return;\r\n      const ok = await saveDetail(id, merged, { source: 'auto', refreshMode: 'debounced' });\r\n      if (ok) {\r\n        const now = Date.now();\r\n        if (now - autoSaveSuccessAtRef.current > 1400) {\r\n          autoSaveSuccessAtRef.current = now;\r\n          pushToast('자동저장 완료', 'success');\r\n        }\r\n      }\r\n    }, 900);\r\n  }, [saveDetail, pushToast]);\r\n\r\n  const updateLocalDetail = useCallback((id, data) => {\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    setLocalDetails(prev => ({ ...prev, [id]: { ...(prev[id] || {}), ...data } }));\r\n    scheduleAutoSave(id, data);\r\n  }, [isVersionEditable, scheduleAutoSave, pushToast, versionLockMessage]);\r\n\r\n  const addDetailRow = async (entryId) => {\r\n    if (!entryId) return;\r\n    if (addingEntryId === entryId) return;\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    const knownEntry = activeEntries.find(e => e.id === entryId) || entries.find(e => e.id === entryId);\r\n    const nextSortOrder = ((knownEntry?.details || []).reduce((max, d) => {\r\n      const order = Number(d?.sort_order ?? -1);\r\n      return Number.isFinite(order) ? Math.max(max, order) : max;\r\n    }, -1)) + 1;\r\n    if (knownEntry && knownEntry.status !== 'DRAFT') {\r\n      alert(EDIT_BLOCKED_MSG);\r\n      return;\r\n    }\r\n    try {\r\n      setAddingEntryId(entryId);\r\n      const created = await authAxios.post('/api/details/', {\r\n        entry: entryId,\r\n        name: '새 산출내역',\r\n        price: 0,\r\n        qty: 1,\r\n        freq: 1,\r\n        sort_order: nextSortOrder,\r\n        currency_unit: '원',\r\n        unit: '식',\r\n        freq_unit: '회',\r\n        source: '자체',\r\n        organization: knownEntry?.organization || null,\r\n      });\r\n      setFocusDetailId(created?.data?.id || null);\r\n      onRefresh();\r\n    } catch (e) {\r\n      console.groupCollapsed('[BudgetDetail] create failed');\r\n      console.error('request', {\r\n        entry: entryId,\r\n        name: '새 산출내역',\r\n        price: 0,\r\n        qty: 1,\r\n        freq: 1,\r\n        sort_order: nextSortOrder,\r\n        currency_unit: '원',\r\n        unit: '식',\r\n        freq_unit: '회',\r\n        source: '자체',\r\n        organization: knownEntry?.organization || null,\r\n      });\r\n      console.error('response_status', e?.response?.status);\r\n      console.error('response_data', e?.response?.data);\r\n      console.error('axios_message', e?.message);\r\n      console.groupEnd();\r\n      const text = apiErrorMessage(e, '산출내역 추가 작업 중 오류가 발생했습니다.');\r\n      console.error('AddDetailRow Error:', e);\r\n      if (text.includes('non_field_errors') && text.includes('수정할 수 없습니다')) {\r\n        onRefresh();\r\n        alert(EDIT_BLOCKED_MSG);\r\n      } else {\r\n        const detailInfo = e.response?.data ? `\\n상세: ${JSON.stringify(e.response.data)}` : (e.message ? `\\n메시지: ${e.message}` : '');\r\n        alert(`${text}${detailInfo}`);\r\n      }\r\n    }\r\n    finally { setAddingEntryId(null); }\r\n  };\r\n\r\n  const deleteDetail = async (id) => {\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    const entryId = detailToEntryId[id];\r\n    if (entryId && !canEditEntry(entryId)) {\r\n      alert(EDIT_BLOCKED_MSG);\r\n      return;\r\n    }\r\n    if (deletingDetailId === id) return;\r\n    if (!(await modalApi.confirm('이 산출근거를 삭제하시겠습니까?'))) return;\r\n    try {\r\n      setDeletingDetailId(id);\r\n      await authAxios.delete(`/api/details/${id}/`);\r\n      onRefresh();\r\n    } catch (e) {\r\n      alert(apiErrorMessage(e, '삭제 실패'));\r\n    } finally {\r\n      setDeletingDetailId(null);\r\n    }\r\n  };\r\n\r\n  const deleteEntry = async (id) => {\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    if (!canEditEntry(id)) {\r\n      alert(EDIT_BLOCKED_MSG);\r\n      return;\r\n    }\r\n    if (!(await modalApi.confirm('이 예산 항목을 삭제하시겠습니까?'))) return;\r\n    try { await authAxios.delete(`/api/entries/${id}/`); onRefresh(); } catch { alert('삭제 실패'); }\r\n  };\r\n\r\n  const addEntryFromHierarchyMenu = async () => {\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    if (!selectedScopeOrgId || !version?.year) {\r\n      pushToast('선택된 부서 또는 회차 정보가 없습니다.', 'error');\r\n      return;\r\n    }\r\n    const mokId = Number(hierarchySelectedMokId || 0);\r\n    if (!mokId) {\r\n      pushToast('목 항목을 선택하세요.', 'error');\r\n      return;\r\n    }\r\n    if (usedMokIdsInScope.has(mokId)) {\r\n      pushToast('이미 추가된 목 항목입니다.', 'error');\r\n      return;\r\n    }\r\n    try {\r\n      setHierarchyAddLoading(true);\r\n      await authAxios.post('/api/entries/', {\r\n        subject: mokId,\r\n        organization: Number(selectedScopeOrgId),\r\n        entrusted_project: projectId ? Number(projectId) : null,\r\n        year: Number(version.year),\r\n        supplemental_round: Number(version?.round ?? 0),\r\n        budget_category: 'ORIGINAL',\r\n        carryover_type: 'NONE',\r\n      });\r\n      onRefresh();\r\n      pushToast('예산 항목이 추가되었습니다.');\r\n      closeHierarchyAction();\r\n    } catch (e) {\r\n      alert(apiErrorMessage(e, '항목 추가 중 오류가 발생했습니다.'));\r\n    } finally {\r\n      setHierarchyAddLoading(false);\r\n    }\r\n  };\r\n\r\n  const renderMokActions = (entryId) => (\r\n    <div\r\n      style={mokActionPopoverWrap}\r\n      ref={(node) => {\r\n        if (node) mokActionRefs.current[entryId] = node;\r\n        else delete mokActionRefs.current[entryId];\r\n      }}\r\n    >\r\n      <button\r\n        type=\"button\"\r\n        style={mokActionTrigger}\r\n        title=\"항목 작업\"\r\n        aria-expanded={openMokActionEntryId === entryId}\r\n        onClick={(event) => {\r\n          if (openMokActionEntryId === entryId) {\r\n            closeMokAction();\r\n            return;\r\n          }\r\n          openMokAction(entryId, event.currentTarget);\r\n        }}\r\n      >\r\n        <MoreHorizontal size={9} />\r\n      </button>\r\n    </div>\r\n  );\r\n\r\n  const onDragEnd = async (result) => {\r\n    if (!result.destination) return;\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    const entryIdStr = result.type.replace('entry-', '');\r\n    if (!entryIdStr) return;\r\n    const entryId = Number(entryIdStr);\r\n    const entry = activeEntries.find(e => e.id === entryId);\r\n    if (!entry) return;\r\n    if (!canEditEntry(entryId)) {\r\n      alert(EDIT_BLOCKED_MSG);\r\n      return;\r\n    }\r\n\r\n    const items = [...(entry.details || [])].sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));\r\n    const [reorderedItem] = items.splice(result.source.index, 1);\r\n    items.splice(result.destination.index, 0, reorderedItem);\r\n\r\n    try {\r\n      await Promise.all(items.map((it, idx) => authAxios.patch(`/api/details/${it.id}/`, { sort_order: idx })));\r\n      onRefresh();\r\n    } catch { alert('순서 저장 실패'); }\r\n  };\r\n\r\n  /* Hook Integration */\r\n  const { exportToExcel } = useExcelExport({\r\n    orgs,\r\n    selectedScopeOrgId,\r\n    version,\r\n    pEntries,\r\n    subjects,\r\n    projects,\r\n    localDetails\r\n  });\r\n\r\n  const {\r\n    wfModal,\r\n    setWfModal,\r\n    openWorkflowModal,\r\n    executeWorkflow\r\n  } = useWorkflow({\r\n    isVersionEditable,\r\n    versionLockMessage,\r\n    selectedScopeOrgId,\r\n    version,\r\n    orgs,\r\n    deptStatus,\r\n    deptEntries,\r\n    localDetails,\r\n    subjects,\r\n    authAxios,\r\n    onRefresh,\r\n    modalApi,\r\n    pushToast\r\n  });\r\n\r\n  const runDeptWorkflow = openWorkflowModal;\r\n\r\n  const _recallEntry = async (entryId) => {\r\n    if (!isVersionEditable) {\r\n      pushToast(versionLockMessage, 'error');\r\n      return;\r\n    }\r\n    const entry = activeEntries.find(e => e.id === entryId);\r\n    if (!entry) return;\r\n\r\n    // 권한 체크: 요청자 또는 관리자만 가능\r\n    if (user?.role !== 'REQUESTOR' && user?.role !== 'ADMIN') {\r\n      await modalApi.alert('회수 권한이 없습니다.');\r\n      return;\r\n    }\r\n\r\n    // 상태 체크\r\n    if (entry.status === 'DRAFT') {\r\n      await modalApi.alert('이미 작성중 상태입니다.');\r\n      return;\r\n    }\r\n\r\n    if (!['PENDING', 'REVIEWING', 'FINALIZED'].includes(entry.status)) {\r\n      await modalApi.alert('회수할 수 없는 상태입니다.');\r\n      return;\r\n    }\r\n\r\n    const statusLabel = { PENDING: '상신', REVIEWING: '검토중', FINALIZED: '확정' };\r\n    const confirmMsg = `${statusLabel[entry.status]} 상태의 예산을 회수하시겠습니까?\\n작성중 상태로 되돌아갑니다.`;\r\n    if (!(await modalApi.confirm(confirmMsg))) return;\r\n\r\n    try {\r\n      await authAxios.post(`/api/entries/${entryId}/recall/`, { reason: '사용자 요청에 의한 회수' });\r\n      onRefresh();\r\n      modalApi.alert('예산이 성공적으로 회수되었습니다.');\r\n    } catch (e) {\r\n      await modalApi.alert(apiErrorMessage(e, '회수 처리 중 오류가 발생했습니다.'));\r\n    }\r\n  };\r\n\r\n  const isAdmin = user?.role === 'ADMIN';\r\n  // 새 역할: MANAGER = 총무팀(구 REVIEWER), STAFF = 부서담당자(구 MANAGER)\r\n  const isManager = user?.role === 'MANAGER' || user?.role === 'REVIEWER'; // 하위 호환\r\n  const isStaff = user?.role === 'STAFF' || user?.role === 'REQUESTOR';    // 하위 호환\r\n  const hasDraftEntries = deptEntries.some(e => (e.status || 'DRAFT') === 'DRAFT');\r\n  const canSubmitDept = isVersionEditable && hasDraftEntries && (isAdmin || isStaff);\r\n  const canApproveDept = isVersionEditable && ((deptStatus === 'PENDING' && (isAdmin || isManager)) || (deptStatus === 'REVIEWING' && (isAdmin || isManager)));\r\n  const canRejectDept = isVersionEditable && ((deptStatus === 'PENDING' && (isAdmin || isManager)) || (deptStatus === 'REVIEWING' && (isAdmin || isManager)));\r\n  const canReopenDept = isVersionEditable && deptStatus === 'FINALIZED' && isAdmin;\r\n  const _canRecallEntry = (status) => isVersionEditable && (isAdmin || isStaff) && ['PENDING', 'REVIEWING', 'FINALIZED'].includes(status);\r\n  const workflowStages = ['DRAFT', 'PENDING', 'REVIEWING', 'FINALIZED'];\r\n  const _workflowProgress = deptStatus === 'MIXED'\r\n    ? 0\r\n    : (Math.max(0, workflowStages.indexOf(deptStatus)) / (workflowStages.length - 1)) * 100;\r\n  const _workflowHint = deptStatus === 'MIXED'\r\n    ? '부서 내 항목 상태가 혼합되어 있습니다. 상태를 정리한 뒤 다음 단계를 진행하세요.'\r\n    : `현재 단계: ${statusLabel[deptStatus] || deptStatus}`;\r\n  const progressCounts = useMemo(() => {\r\n    const submitted = deptEntries.filter(e => (e.status || 'DRAFT') === 'PENDING').length;\r\n    const approved = deptEntries.filter(e => ['REVIEWING', 'FINALIZED'].includes(e.status || 'DRAFT')).length;\r\n    const rejected = deptEntries.filter(e => {\r\n      const logs = entryLogsById[Number(e.id)] || [];\r\n      return logs.some(log => log.to_status === 'DRAFT' && String(log.reason || '').trim());\r\n    }).length;\r\n    return { submitted, approved, rejected };\r\n  }, [deptEntries, entryLogsById]);\r\n\r\n  const clearEntryLogHighlight = useCallback((entryId) => {\r\n    const key = String(entryId);\r\n    setNewLogEntries((prev) => {\r\n      if (!prev[key]) return prev;\r\n      const next = { ...prev };\r\n      delete next[key];\r\n      return next;\r\n    });\r\n  }, []);\r\n\r\n  const openEntryHistoryLog = useCallback(async (entry, mode = 'change') => {\r\n    const allLogs = entryLogsById[Number(entry.id)] || [];\r\n    const logs = mode === 'reject'\r\n      ? allLogs.filter(log => isRejectLog(log))\r\n      : allLogs.filter(log => !isRejectLog(log));\r\n    if (!logs.length) return;\r\n\r\n    const lines = logs.slice(0, 12).map((log, idx) => {\r\n      const actor = log.actor_name || log.actor || '시스템';\r\n      const from = statusLabel[log.from_status] || log.from_status || '-';\r\n      const to = statusLabel[log.to_status] || log.to_status || '-';\r\n      const reason = String(log.reason || '').trim();\r\n      const base = `${idx + 1}. ${formatLogDateTime(log.created_at)} | ${actor} | ${from} -> ${to}`;\r\n      return reason ? `${base} | ${reason}` : base;\r\n    });\r\n    const moreLine = logs.length > 12 ? `\\n... 총 ${logs.length}건` : '';\r\n    const title = entry.subject_name || entry.subject_code || entry.id;\r\n    const heading = mode === 'reject' ? '반려 의견 로그' : '변경 로그';\r\n    const message = `[${title}] ${heading}\\n\\n${lines.join('\\n')}${moreLine}`;\r\n\r\n    if (modalApi?.alert) {\r\n      await modalApi.alert(message);\r\n    } else {\r\n      alert(message);\r\n    }\r\n    clearEntryLogHighlight(entry.id);\r\n  }, [entryLogsById, statusLabel, modalApi, clearEntryLogHighlight]);\r\n\r\n  // 그룹(관/항) 단위 팝오버용: 각 entry의 로그를 { entryId, subjectName, logs } 형태로 집계\r\n  const openLogGroupItems = useMemo(() => {\r\n    if (!openLogEntry?.groupKey || !openLogEntry?.entryIds) return null;\r\n    const result = [];\r\n    openLogEntry.entryIds.forEach(eid => {\r\n      const allLogs = entryLogsById[Number(eid)] || [];\r\n      const logs = openLogEntry.mode === 'reject'\r\n        ? allLogs.filter(log => isRejectLog(log))\r\n        : allLogs.filter(log => !isRejectLog(log));\r\n      if (!logs.length) return;\r\n      // subject 이름 찾기\r\n      const entry = entries.find(e => Number(e.id) === Number(eid));\r\n      const subjectName = entry?.subject_name || entry?.subject_code || `항목 ${eid}`;\r\n      result.push({ entryId: eid, subjectName, logs });\r\n    });\r\n    // 최신 로그 기준으로 정렬\r\n    result.sort((a, b) => {\r\n      const aTime = a.logs[0]?.created_at ? new Date(a.logs[0].created_at).getTime() : 0;\r\n      const bTime = b.logs[0]?.created_at ? new Date(b.logs[0].created_at).getTime() : 0;\r\n      return bTime - aTime;\r\n    });\r\n    return result;\r\n  }, [openLogEntry, entryLogsById, entries]);\r\n\r\n  const openLogEntryLogs = useMemo(\r\n    () => {\r\n      if (openLogEntry?.groupKey) {\r\n        // 그룹 모드: 모든 entry 로그를 flat하게 합침\r\n        if (!openLogEntry?.entryIds) return [];\r\n        const allLogs = [];\r\n        openLogEntry.entryIds.forEach(eid => {\r\n          const logs = entryLogsById[Number(eid)] || [];\r\n          const filtered = openLogEntry.mode === 'reject'\r\n            ? logs.filter(log => isRejectLog(log))\r\n            : logs.filter(log => !isRejectLog(log));\r\n          filtered.forEach(log => {\r\n            const entry = entries.find(e => Number(e.id) === Number(eid));\r\n            allLogs.push({ ...log, _subjectName: entry?.subject_name || entry?.subject_code || `항목 ${eid}` });\r\n          });\r\n        });\r\n        allLogs.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));\r\n        return allLogs;\r\n      }\r\n      if (!openLogEntry?.id) return [];\r\n      const logs = entryLogsById[Number(openLogEntry.id)] || [];\r\n      return openLogEntry.mode === 'reject'\r\n        ? logs.filter(log => isRejectLog(log))\r\n        : logs.filter(log => !isRejectLog(log));\r\n    },\r\n    [openLogEntry, entryLogsById, entries]\r\n  );\r\n  const openLogEntryRecent = useMemo(\r\n    () => openLogEntryLogs.slice(0, 5),\r\n    [openLogEntryLogs]\r\n  );\r\n\r\n  // subject 하위의 모든 entry ID 목록 반환 (장/관/항 단위 일괄 적용용)\r\n  const getEntriesUnderSubject = useCallback((subjectId) => {\r\n    // subjects 트리에서 subjectId의 모든 하위 subject ID 수집\r\n    const collectDescendants = (id) => {\r\n      const ids = new Set([id]);\r\n      const queue = [id];\r\n      while (queue.length > 0) {\r\n        const cur = queue.shift();\r\n        subjects.filter(s => Number(s.parent) === Number(cur)).forEach(s => {\r\n          ids.add(s.id);\r\n          queue.push(s.id);\r\n        });\r\n      }\r\n      return ids;\r\n    };\r\n    const subjectIds = collectDescendants(subjectId);\r\n    return activeEntries.filter(e => subjectIds.has(Number(e.subject)));\r\n  }, [subjects, activeEntries]);\r\n\r\n  const executeBulkComment = useCallback(async (commentType, targetEntries, versionId, orgId) => {\r\n    setBulkPosting(true);\r\n    try {\r\n      await Promise.all(targetEntries.map(e =>\r\n        authAxios.post('/api/comments/', {\r\n          version: versionId,\r\n          comment_type: commentType,\r\n          body: `[일괄] ${{ DONE: '작성완료', REQUEST: '수정요청', QUESTION: '질문', ANSWER: '답변' }[commentType] || commentType}`,\r\n          entry: e.id,\r\n        }).catch(() => {})\r\n      ));\r\n      onRefresh?.();\r\n    } finally {\r\n      setBulkPosting(false);\r\n      setBulkCommentDialog(null);\r\n    }\r\n  }, [authAxios, onRefresh]);\r\n\r\n  // 의견 유형별 머릿말 색상 (CommentThread TYPE_COLORS와 동일)\r\n  const COMMENT_TYPE_BADGE = {\r\n    DONE:     { label: '작성완료', bg: '#dcfce7', color: '#166534', border: '#86efac' },\r\n    REQUEST:  { label: '수정요청', bg: '#fee2e2', color: '#b91c1c', border: '#fca5a5' },\r\n    QUESTION: { label: '질문',     bg: '#fef9c3', color: '#854d0e', border: '#fde047' },\r\n    ANSWER:   { label: '답변',     bg: '#f3e8ff', color: '#6b21a8', border: '#d8b4fe' },\r\n  };\r\n\r\n  const renderEntryFlowInfo = useCallback((entry) => {\r\n    const commentBadge = entry.latest_comment_type ? COMMENT_TYPE_BADGE[entry.latest_comment_type] : null;\r\n    const unresolved = Array.isArray(entry.unresolved_types) ? entry.unresolved_types : [];\r\n    const hasUnresolvedRequest = unresolved.includes('REQUEST');\r\n    const hasUnresolvedQuestion = unresolved.includes('QUESTION');\r\n    return (\r\n      <div style={{ display: 'inline-flex', alignItems: 'center', gap: 4, marginTop: 2, flexWrap: 'wrap' }}>\r\n        {/* 의견 기반 상태 머릿말 */}\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setCommentEntryId(prev => prev === entry.id ? null : entry.id)}\r\n          style={commentBadge ? {\r\n            fontSize: 10, fontWeight: 700, padding: '1px 7px',\r\n            borderRadius: 999, background: commentBadge.bg,\r\n            border: `1px solid ${commentBadge.border}`, color: commentBadge.color,\r\n            cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: 3,\r\n          } : {\r\n            fontSize: 10, fontWeight: 600, padding: '1px 7px',\r\n            borderRadius: 999, background: '#f1f5f9',\r\n            border: '1px solid #e2e8f0', color: '#64748b',\r\n            cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: 3,\r\n          }}\r\n          title={commentBadge ? '의견 패널 열기' : '의견 등록'}\r\n        >\r\n          <MessageSquare size={9} />\r\n          {commentBadge ? commentBadge.label : '의견'}\r\n          {entry.comment_count > 0 && <span style={{ fontWeight: 900 }}>{entry.comment_count}</span>}\r\n        </button>\r\n        {/* 미해소 수정요청 아이콘 */}\r\n        {hasUnresolvedRequest && (\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setCommentEntryId(prev => prev === entry.id ? null : entry.id)}\r\n            style={{\r\n              width: 16, height: 16, borderRadius: 999, border: '1px solid #fca5a5',\r\n              background: '#fee2e2', color: '#b91c1c', display: 'inline-flex',\r\n              alignItems: 'center', justifyContent: 'center', cursor: 'pointer', padding: 0,\r\n            }}\r\n            title=\"미해소 수정요청이 있습니다\"\r\n          >\r\n            <AlertCircle size={9} />\r\n          </button>\r\n        )}\r\n        {/* 미해소 질문 아이콘 */}\r\n        {hasUnresolvedQuestion && (\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setCommentEntryId(prev => prev === entry.id ? null : entry.id)}\r\n            style={{\r\n              width: 16, height: 16, borderRadius: 999, border: '1px solid #fde047',\r\n              background: '#fef9c3', color: '#854d0e', display: 'inline-flex',\r\n              alignItems: 'center', justifyContent: 'center', cursor: 'pointer', padding: 0,\r\n            }}\r\n            title=\"미답변 질문이 있습니다\"\r\n          >\r\n            <HelpCircle size={9} />\r\n          </button>\r\n        )}\r\n      </div>\r\n    );\r\n  }, [setCommentEntryId]);\r\n\r\n  useEffect(() => {\r\n    if (!focusDetailId) return;\r\n    const el = document.querySelector(`[data-detail-name-id=\"${focusDetailId}\"]`);\r\n    if (el) {\r\n      el.focus();\r\n      el.select?.();\r\n      setFocusDetailId(null);\r\n    }\r\n  }, [focusDetailId, entries]);\r\n\r\n\r\n\r\n\r\n  return (\r\n    <div style={ledgerLayout}>\r\n      {/* ── 통합 컨트롤 패널 ── */}\r\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\r\n\r\n        {/* 메인 컨트롤 카드 */}\r\n        <div style={{ background: '#fff', border: '1px solid #e2e8f0', borderRadius: 14, overflow: 'hidden', boxShadow: '0 1px 4px rgba(15, 23, 42, 0.06)' }}>\r\n          {/* 상단 바: 회차명 + 상태 + 변경 버튼 */}\r\n          <div style={{ padding: '12px 16px', borderBottom: '1px solid #f1f5f9', display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12, flexWrap: 'wrap', background: '#fafbfc' }}>\r\n            <div style={{ display: 'flex', alignItems: 'center', gap: 10, flexWrap: 'wrap' }}>\r\n              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\r\n                <span style={{ fontSize: '15px', fontWeight: 800, color: '#0f172a' }}>\r\n                  {version ? `${version.year}년 ${version.name}` : '회차 미선택'}\r\n                </span>\r\n                <span style={{\r\n                  fontSize: '11px', fontWeight: 700, padding: '2px 8px', borderRadius: 4,\r\n                  background: isVersionEditable ? '#dcfce7' : '#fef3c7',\r\n                  color: isVersionEditable ? '#166534' : '#92400e',\r\n                  border: `1px solid ${isVersionEditable ? '#bbf7d0' : '#fde68a'}`\r\n                }}>\r\n                  {isVersionEditable ? '● 입력 가능' : '🔒 입력 잠금'}\r\n                </span>\r\n              </div>\r\n              <div style={{ display: 'flex', alignItems: 'center', gap: 6, flexWrap: 'wrap' }}>\r\n                <span style={{ fontSize: '11px', color: '#64748b' }}>\r\n                  <span style={{ color: '#94a3b8' }}>부서</span> <span style={{ fontWeight: 700, color: '#334155' }}>{selectedDeptName}</span>\r\n                </span>\r\n                <span style={{ color: '#e2e8f0' }}>|</span>\r\n                <span style={{ fontSize: '11px', color: '#64748b' }}>\r\n                  <span style={{ color: '#94a3b8' }}>입력기간</span> <span style={{ fontWeight: 600, color: '#334155' }}>{selectedVersionPeriod.periodText}</span>\r\n                </span>\r\n                <span style={{ color: '#e2e8f0' }}>|</span>\r\n                <span style={{\r\n                  fontSize: '11px', fontWeight: 700, padding: '1px 6px', borderRadius: 4,\r\n                  background: selectedVersionPeriod.deadlineText.includes('D-Day') ? '#fef2f2' : selectedVersionPeriod.deadlineText.includes('마감 +') ? '#f1f5f9' : '#fffbeb',\r\n                  color: selectedVersionPeriod.deadlineText.includes('D-Day') ? '#b91c1c' : selectedVersionPeriod.deadlineText.includes('마감 +') ? '#64748b' : '#b45309',\r\n                }}>\r\n                  {selectedVersionPeriod.deadlineText}\r\n                </span>\r\n              </div>\r\n            </div>\r\n            {!embeddedMode && (\r\n              <button style={{ ...btnWhite, padding: '6px 12px', fontSize: '12px', gap: 6, alignItems: 'center', display: 'flex' }} onClick={openRoundSelectModal}>\r\n                ⇄ 회차/범위 변경\r\n              </button>\r\n            )}\r\n          </div>\r\n\r\n          {/* 하단: 수지 현황 + 진행률 + 액션 버튼 */}\r\n          <div style={{ padding: '10px 16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12, flexWrap: 'wrap' }}>\r\n            {/* 수지 현황 */}\r\n            <div style={{ display: 'flex', alignItems: 'center', gap: 0, flexWrap: 'wrap' }}>\r\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 1, padding: '4px 16px 4px 0', borderRight: '1px solid #e2e8f0' }}>\r\n                <span style={{ fontSize: '10px', fontWeight: 600, color: '#94a3b8', letterSpacing: '0.05em' }}>수입</span>\r\n                <span style={{ fontSize: '14px', fontWeight: 800, color: COLORS.income, fontVariantNumeric: 'tabular-nums' }}>{num(incTotal)}</span>\r\n              </div>\r\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 1, padding: '4px 16px', borderRight: '1px solid #e2e8f0' }}>\r\n                <span style={{ fontSize: '10px', fontWeight: 600, color: '#94a3b8', letterSpacing: '0.05em' }}>지출</span>\r\n                <span style={{ fontSize: '14px', fontWeight: 800, color: COLORS.expense, fontVariantNumeric: 'tabular-nums' }}>{num(expTotal)}</span>\r\n              </div>\r\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 1, padding: '4px 16px 4px 16px', borderRight: '1px solid #e2e8f0' }}>\r\n                <span style={{ fontSize: '10px', fontWeight: 600, color: '#94a3b8', letterSpacing: '0.05em' }}>차액</span>\r\n                <span style={{ fontSize: '14px', fontWeight: 800, color: isBalanced ? '#059669' : '#dc2626', fontVariantNumeric: 'tabular-nums' }}>\r\n                  {isBalanced ? '균형' : num(diffTotal)}\r\n                </span>\r\n              </div>\r\n              {/* 입력 진행률 */}\r\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 3, padding: '4px 0 4px 16px', minWidth: 120 }}>\r\n                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 8 }}>\r\n                  <span style={{ fontSize: '10px', fontWeight: 600, color: '#94a3b8', letterSpacing: '0.05em' }}>입력 진행률</span>\r\n                  <span style={{ fontSize: '11px', fontWeight: 800, color: '#0f172a' }}>{inputProgressRatio}% <span style={{ fontWeight: 500, color: '#94a3b8', fontSize: '10px' }}>({enteredCount}/{totalEditableCount})</span></span>\r\n                </div>\r\n                <div style={{ height: 5, borderRadius: 999, background: '#e2e8f0', overflow: 'hidden' }}>\r\n                  <div style={{ height: '100%', borderRadius: 999, background: inputProgressRatio === 100 ? '#10b981' : '#3b82f6', width: `${inputProgressRatio}%`, transition: 'width 0.3s ease' }} />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* 액션 버튼 */}\r\n            <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', alignItems: 'center' }}>\r\n              <button style={{ ...btnWhite, padding: '7px 12px', fontSize: '12px', gap: 6, alignItems: 'center', display: 'flex' }} onClick={() => { onRefresh(); modalApi.alert('저장 완료'); }}>\r\n                <Save size={13} /> 저장\r\n              </button>\r\n              <button style={{ ...btnWhite, padding: '7px 12px', fontSize: '12px', gap: 6, alignItems: 'center', display: 'flex' }} onClick={exportToExcel}>\r\n                <Download size={13} /> 엑셀\r\n              </button>\r\n              <button\r\n                style={{ ...btnPlus, padding: '7px 14px', fontSize: '12px', gap: 6, alignItems: 'center', display: 'flex', opacity: isVersionEditable ? 1 : 0.45, cursor: isVersionEditable ? 'pointer' : 'not-allowed' }}\r\n                disabled={!isVersionEditable}\r\n                onClick={() => {\r\n                  if (!isVersionEditable) { pushToast(versionLockMessage, 'error'); return; }\r\n                  setIsAddOpen(true);\r\n                }}\r\n              >\r\n                <Plus size={13} /> 항목 추가\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n\r\n\r\n        {!isVersionEditable && (\r\n          <div style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #fde68a', background: '#fffbeb', color: '#92400e', fontSize: '11px', fontWeight: 600, display: 'flex', alignItems: 'center', gap: 6 }}>\r\n            <span>🔒</span>\r\n            <span>회차 잠금 — 현재 상태: <strong>{versionStatusLabel[version?.status] || version?.status || '-'}</strong>. 대기(PENDING) 상태 회차에서만 입력·수정·삭제할 수 있습니다.</span>\r\n          </div>\r\n        )}\r\n        {version && (user?.role === 'MANAGER' || user?.role === 'REVIEWER' || user?.role === 'ADMIN') && (\r\n          <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\r\n            {version.status !== 'CLOSED' ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={async () => {\r\n                  if (!window.confirm(`\"${version.name}\" 회차를 마감합니까?\\n마감 후에는 모든 편집이 잠깁니다.`)) return;\r\n                  try {\r\n                    await authAxios.post(`/api/versions/${version.id}/close/`);\r\n                    onRefresh?.();\r\n                  } catch { alert('마감 처리 중 오류가 발생했습니다.'); }\r\n                }}\r\n                style={{ padding: '5px 12px', borderRadius: 6, border: '1px solid #fca5a5', background: '#fff1f2', color: '#b91c1c', fontSize: 12, fontWeight: 700, cursor: 'pointer' }}\r\n              >\r\n                🔒 회차 마감\r\n              </button>\r\n            ) : (\r\n              <button\r\n                type=\"button\"\r\n                onClick={async () => {\r\n                  if (!window.confirm(`\"${version.name}\" 회차의 마감을 해제합니까?`)) return;\r\n                  try {\r\n                    await authAxios.post(`/api/versions/${version.id}/reopen/`);\r\n                    onRefresh?.();\r\n                  } catch { alert('마감 해제 중 오류가 발생했습니다.'); }\r\n                }}\r\n                style={{ padding: '5px 12px', borderRadius: 6, border: '1px solid #86efac', background: '#f0fdf4', color: '#166534', fontSize: 12, fontWeight: 700, cursor: 'pointer' }}\r\n              >\r\n                🔓 마감 해제\r\n              </button>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {\r\n        isRoundSelectModalOpen && createPortal(\r\n          <div style={{ ...plannerModalBackdrop, zIndex: roundSelectZIndex }} onClick={() => setIsRoundSelectModalOpen(false)}>\r\n            <div style={plannerModalCard} onClick={e => e.stopPropagation()}>\r\n              <div style={plannerModalHead}>\r\n                <div>\r\n                  <div style={plannerModalTitle}>입력 회차 선택</div>\r\n                  <div style={plannerModalSubTitle}>입력 가능한 회차와 범위를 선택해 주세요.</div>\r\n                </div>\r\n                <X size={18} style={{ cursor: 'pointer', color: '#94a3b8' }} onClick={() => setIsRoundSelectModalOpen(false)} />\r\n              </div>\r\n\r\n              <div style={plannerModalBody}>\r\n                <div style={plannerVersionList}>\r\n                  {inputAvailableVersions.length === 0 && (\r\n                    <div style={plannerModalEmpty}>\r\n                      현재 입력 가능한 회차(PENDING)가 없습니다.\r\n                    </div>\r\n                  )}\r\n                  {inputAvailableVersions.map(v => {\r\n                    const info = versionRelatedInfo(v);\r\n                    const active = Number(modalVersionId) === Number(v.id);\r\n                    return (\r\n                      <button\r\n                        key={v.id}\r\n                        type=\"button\"\r\n                        style={{ ...plannerVersionItem, ...(active ? plannerVersionItemActive : null) }}\r\n                        onClick={() => setModalVersionId(String(v.id))}\r\n                      >\r\n                        <div style={plannerVersionTop}>\r\n                          <span style={plannerVersionName}>{v.year}년 {v.name}</span>\r\n                          <span style={{ ...plannerStatusPill, ...plannerStatusPillOpen }}>입력 가능</span>\r\n                        </div>\r\n                        <div style={plannerVersionMeta}>기간: {info.periodText}</div>\r\n                        <div style={plannerVersionMeta}>일정: {info.deadlineText}</div>\r\n                        <div style={plannerVersionMeta} title={v.guidelines || ''}>\r\n                          안내: {String(v.guidelines || '').trim() ? String(v.guidelines).slice(0, 60) : '입력 지침 미등록'}\r\n                        </div>\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n\r\n                <div style={plannerModalScope}>\r\n                  <div style={plannerSectionTitle}>입력 범위 선택</div>\r\n                  <div style={plannerSelectGrid}>\r\n                    <label style={plannerFieldBlock}>\r\n                      <span style={plannerFieldLabel}>부서</span>\r\n                      <select\r\n                        style={plannerSelect}\r\n                        value={modalDeptId}\r\n                        onChange={e => setModalDeptId(e.target.value)}\r\n                        disabled={!isAdminUser}\r\n                      >\r\n                        {selectableDepartments.map(o => <option key={o.id} value={o.id}>{o.name}</option>)}\r\n                      </select>\r\n                    </label>\r\n                    <label style={plannerFieldBlock}>\r\n                      <span style={plannerFieldLabel}>팀 범위</span>\r\n                      <select\r\n                        style={plannerSelect}\r\n                        value={modalTeamId}\r\n                        onChange={e => setModalTeamId(e.target.value)}\r\n                      >\r\n                        <option value=\"\">부서 전체</option>\r\n                        {modalSelectableTeams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}\r\n                      </select>\r\n                    </label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div style={plannerModalFooter}>\r\n                <button style={btnG} onClick={() => setIsRoundSelectModalOpen(false)}>취소</button>\r\n                <button style={{ ...btnP, padding: '10px 18px', fontSize: '12px' }} onClick={applyRoundSelection}>\r\n                  선택 적용\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>,\r\n          document.body\r\n        )\r\n      }\r\n\r\n      {/* ── 워크플로우 확인 모달 ── */}\r\n      {\r\n        wfModal && createPortal(\r\n          <div style={{ position: 'fixed', inset: 0, background: 'rgba(15,23,42,0.45)', zIndex: workflowModalZIndex, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16 }}\r\n            onClick={() => setWfModal(null)}>\r\n            <div style={{ background: '#fff', borderRadius: 14, width: 'min(560px, 96vw)', maxHeight: '85vh', overflow: 'hidden', display: 'flex', flexDirection: 'column', boxShadow: '0 25px 50px -12px rgba(0,0,0,.3)' }}\r\n              onClick={e => e.stopPropagation()}>\r\n              {/* 헤더 */}\r\n              <div style={{ padding: '14px 20px', borderBottom: '1px solid #e2e8f0', display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: '#fafbfc' }}>\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: 3 }}>\r\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\r\n                    <h3 style={{ margin: 0, fontSize: '15px', fontWeight: 800, color: '#1e293b' }}>{wfModal.actionLabel}</h3>\r\n                    <span style={{ fontSize: '10px', fontWeight: 700, padding: '2px 7px', borderRadius: 4, background: '#f1f5f9', color: '#475569' }}>\r\n                      {statusLabel[deptStatus]} → {statusLabel[wfModal.targetStatus]}\r\n                    </span>\r\n                  </div>\r\n                  <span style={{ fontSize: '11px', color: '#64748b' }}>{wfModal.orgName} · {version?.year}년 {version?.name}</span>\r\n                </div>\r\n                <button type=\"button\" onClick={() => setWfModal(null)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#94a3b8', padding: 4, display: 'flex', alignItems: 'center', borderRadius: 6 }}>\r\n                  <X size={18} />\r\n                </button>\r\n              </div>\r\n\r\n              {/* 설명 */}\r\n              <div style={{ padding: '10px 20px', background: '#f8fafc', borderBottom: '1px solid #f1f5f9' }}>\r\n                <p style={{ margin: 0, fontSize: '12px', color: '#475569', lineHeight: 1.6 }}>{wfModal.description}</p>\r\n              </div>\r\n\r\n              {/* 경고 */}\r\n              {wfModal.warnings.length > 0 && (\r\n                <div style={{ padding: '8px 20px', background: '#fffbeb', borderBottom: '1px solid #fde68a' }}>\r\n                  {wfModal.warnings.map((w, i) => (\r\n                    <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 6, fontSize: '11px', color: w.type === 'error' ? '#b91c1c' : '#92400e', padding: '3px 0', lineHeight: 1.5 }}>\r\n                      <span style={{ fontSize: '13px', flexShrink: 0, marginTop: 1 }}>{w.type === 'error' ? '🚫' : '⚠️'}</span>\r\n                      <span style={{ whiteSpace: 'pre-wrap' }}>{w.msg}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n\r\n              {/* 대상 항목 리스트 */}\r\n              <div style={{ padding: '12px 20px', maxHeight: 200, overflowY: 'auto', borderBottom: '1px solid #e2e8f0' }}>\r\n                <div style={{ fontSize: '11px', fontWeight: 700, color: '#64748b', marginBottom: 6 }}>\r\n                  처리 대상 항목 ({wfModal.entrySummaries.length}건)\r\n                  {wfModal.ineligible.length > 0 && (\r\n                    <span style={{ color: '#94a3b8', fontWeight: 500, marginLeft: 8 }}>\r\n                      제외 {wfModal.ineligible.length}건 (상태 불일치)\r\n                    </span>\r\n                  )}\r\n                </div>\r\n                {wfModal.entrySummaries.length === 0 ? (\r\n                  <div style={{ padding: 16, textAlign: 'center', color: '#94a3b8', fontSize: '12px' }}>처리 가능한 항목이 없습니다.</div>\r\n                ) : (\r\n                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '11px' }}>\r\n                    <thead>\r\n                      <tr style={{ borderBottom: '1px solid #e2e8f0' }}>\r\n                        <th style={{ textAlign: 'left', padding: '4px 6px', color: '#94a3b8', fontWeight: 600 }}>항</th>\r\n                        <th style={{ textAlign: 'left', padding: '4px 6px', color: '#94a3b8', fontWeight: 600 }}>목</th>\r\n                        <th style={{ textAlign: 'right', padding: '4px 6px', color: '#94a3b8', fontWeight: 600 }}>예산액</th>\r\n                        <th style={{ textAlign: 'center', padding: '4px 6px', color: '#94a3b8', fontWeight: 600 }}>내역</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {wfModal.entrySummaries.map(es => (\r\n                        <tr key={es.id} style={{ borderBottom: '1px solid #f8fafc' }}>\r\n                          <td style={{ padding: '4px 6px', color: '#64748b' }}>{es.hangName}</td>\r\n                          <td style={{ padding: '4px 6px', color: '#1e293b', fontWeight: 500 }}>{es.mokName}</td>\r\n                          <td style={{ padding: '4px 6px', textAlign: 'right', fontWeight: 600, fontFamily: 'monospace', color: es.amount === 0 ? '#ef4444' : '#1e293b' }}>\r\n                            {num(es.amount)}\r\n                          </td>\r\n                          <td style={{ padding: '4px 6px', textAlign: 'center', color: '#94a3b8' }}>\r\n                            {es.detailCount === 0 ? <span style={{ color: '#ef4444' }}>없음</span> : `${es.detailCount}건`}\r\n                          </td>\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                )}\r\n              </div>\r\n\r\n              {/* 반려 사유 입력 */}\r\n              {wfModal.action === 'reject' && (\r\n                <div style={{ padding: '12px 20px', borderBottom: '1px solid #e2e8f0' }}>\r\n                  <label style={{ display: 'block', fontSize: '11px', fontWeight: 700, color: '#64748b', marginBottom: 4 }}>반려 사유 <span style={{ color: '#ef4444' }}>*</span></label>\r\n                  <textarea\r\n                    value={wfModal.reason}\r\n                    onChange={e => setWfModal(p => ({ ...p, reason: e.target.value }))}\r\n                    placeholder=\"반려 사유를 입력하세요...\"\r\n                    style={{ width: '100%', border: '1px solid #e2e8f0', borderRadius: 8, padding: '8px 10px', fontSize: '12px', resize: 'vertical', minHeight: 60, outline: 'none', fontFamily: 'inherit', boxSizing: 'border-box' }}\r\n                  />\r\n                </div>\r\n              )}\r\n\r\n              {/* 하단 버튼 */}\r\n              <div style={{ padding: '12px 20px', display: 'flex', alignItems: 'center', justifyContent: 'flex-end', gap: 8, borderTop: '1px solid #f1f5f9' }}>\r\n                <button onClick={() => setWfModal(null)}\r\n                  style={{ padding: '8px 18px', border: '1px solid #e2e8f0', borderRadius: 8, background: '#fff', fontSize: '12px', fontWeight: 600, cursor: 'pointer', color: '#64748b' }}>\r\n                  취소\r\n                </button>\r\n                <button onClick={executeWorkflow} disabled={!wfModal.eligible.length || (wfModal.action === 'submit' && wfModal.submitBlocked)}\r\n                  style={{\r\n                    padding: '8px 22px', border: 'none', borderRadius: 8, fontSize: '12px', fontWeight: 700, cursor: (!wfModal.eligible.length || (wfModal.action === 'submit' && wfModal.submitBlocked)) ? 'not-allowed' : 'pointer',\r\n                    background: wfModal.action === 'reject' ? '#ef4444' : wfModal.action === 'reopen' ? '#f59e0b' : '#2563eb',\r\n                    color: '#fff', opacity: (wfModal.eligible.length && !(wfModal.action === 'submit' && wfModal.submitBlocked)) ? 1 : 0.45\r\n                  }}>\r\n                  {wfModal.actionLabel} 실행\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>,\r\n          document.body\r\n        )\r\n      }\r\n\r\n      {/* ── 수입/지출 탭(또는 동시보기 요약) ── */}\r\n      <div style={{ display: 'flex', alignItems: 'flex-end', paddingLeft: 2, marginBottom: -1, zIndex: 1, gap: 2, flexWrap: 'wrap' }}>\r\n        {!showCombinedTypeView ? (\r\n          <>\r\n            <button\r\n              onClick={() => setViewType('income')}\r\n              style={{\r\n                padding: '10px 28px 9px',\r\n                borderRadius: '10px 10px 0 0',\r\n                border: '1px solid #e2e8f0',\r\n                borderBottom: viewType === 'income' ? '2px solid #fff' : '1px solid #e2e8f0',\r\n                background: viewType === 'income' ? '#fff' : '#f1f5f9',\r\n                color: viewType === 'income' ? COLORS.income : '#94a3b8',\r\n                fontSize: '13px',\r\n                fontWeight: 800,\r\n                cursor: 'pointer',\r\n                zIndex: viewType === 'income' ? 2 : 1,\r\n                position: 'relative',\r\n                transition: 'background 0.15s',\r\n                display: 'flex', alignItems: 'center', gap: 6,\r\n              }}\r\n            >\r\n              <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: viewType === 'income' ? COLORS.income : '#cbd5e1' }} />\r\n              수입예산\r\n              <span style={{ fontSize: '11px', fontWeight: 600, color: viewType === 'income' ? COLORS.income : '#94a3b8', marginLeft: 2 }}>{num(incTotal)}</span>\r\n            </button>\r\n            <button\r\n              onClick={() => setViewType('expense')}\r\n              style={{\r\n                padding: '10px 28px 9px',\r\n                borderRadius: '10px 10px 0 0',\r\n                border: '1px solid #e2e8f0',\r\n                borderBottom: viewType === 'expense' ? '2px solid #fff' : '1px solid #e2e8f0',\r\n                background: viewType === 'expense' ? '#fff' : '#f1f5f9',\r\n                color: viewType === 'expense' ? COLORS.expense : '#94a3b8',\r\n                fontSize: '13px',\r\n                fontWeight: 800,\r\n                cursor: 'pointer',\r\n                zIndex: viewType === 'expense' ? 2 : 1,\r\n                position: 'relative',\r\n                transition: 'background 0.15s',\r\n                display: 'flex', alignItems: 'center', gap: 6,\r\n              }}\r\n            >\r\n              <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: viewType === 'expense' ? COLORS.expense : '#cbd5e1' }} />\r\n              지출예산\r\n              <span style={{ fontSize: '11px', fontWeight: 600, color: viewType === 'expense' ? COLORS.expense : '#94a3b8', marginLeft: 2 }}>{num(expTotal)}</span>\r\n            </button>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <div\r\n              style={{\r\n                padding: '10px 18px 9px',\r\n                borderRadius: '10px 10px 0 0',\r\n                border: '1px solid #bfdbfe',\r\n                borderBottom: `2px solid ${COLORS.income}`,\r\n                background: '#eff6ff',\r\n                color: COLORS.income,\r\n                fontSize: '13px',\r\n                fontWeight: 800,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 6,\r\n                cursor: 'default',\r\n              }}\r\n            >\r\n              <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: COLORS.income }} />\r\n              수입예산\r\n              <span style={{ fontSize: '11px', fontWeight: 600, marginLeft: 2 }}>{num(incTotal)}</span>\r\n            </div>\r\n            <div\r\n              style={{\r\n                padding: '10px 18px 9px',\r\n                borderRadius: '10px 10px 0 0',\r\n                border: '1px solid #fecaca',\r\n                borderBottom: `2px solid ${COLORS.expense}`,\r\n                background: '#fef2f2',\r\n                color: COLORS.expense,\r\n                fontSize: '13px',\r\n                fontWeight: 800,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 6,\r\n                cursor: 'default',\r\n              }}\r\n            >\r\n              <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: COLORS.expense }} />\r\n              지출예산\r\n              <span style={{ fontSize: '11px', fontWeight: 600, marginLeft: 2 }}>{num(expTotal)}</span>\r\n            </div>\r\n          </>\r\n        )}\r\n        {/* ── 로그 요약 배너 ── */}\r\n        {(() => {\r\n          const targetEntryIds = activeEntries.map(e => Number(e.id));\r\n          const changeLogs = targetEntryIds.filter(eid => {\r\n            const logs = entryLogsById[eid] || [];\r\n            return logs.some(l => !isRejectLog(l));\r\n          });\r\n          const rejectLogs = targetEntryIds.filter(eid => {\r\n            const logs = entryLogsById[eid] || [];\r\n            return logs.some(l => isRejectLog(l));\r\n          });\r\n          const hasNewLog = targetEntryIds.some(eid => newLogEntries[String(eid)]);\r\n          if (!changeLogs.length && !rejectLogs.length) return null;\r\n\r\n          const tabLabel = showCombinedTypeView ? '전체예산' : (viewType === 'income' ? '수입예산' : '지출예산');\r\n          const modeKey = showCombinedTypeView ? 'combined' : viewType;\r\n\r\n          return (\r\n            <div style={tabLogBanner}>\r\n              <span style={tabLogBannerLabel}>{tabLabel} 로그</span>\r\n              <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\r\n                {changeLogs.length > 0 && (\r\n                  <button\r\n                    type=\"button\"\r\n                    data-log-entry-btn={`tab-change-${modeKey}`}\r\n                    onClick={(event) => { openGroupLogPopover(`tab-change-${modeKey}`, tabLabel, targetEntryIds, event.currentTarget, 'change'); }}\r\n                    style={{ ...wfLogBtn, ...(hasNewLog ? { color: '#1d4ed8', borderColor: '#93c5fd', background: '#eff6ff' } : {}), position: 'relative', gap: 4, padding: '2px 8px', width: 'auto', height: 'auto', borderRadius: 8 }}\r\n                    title={hasNewLog ? '새 변경 로그 확인' : '변경 로그 보기'}\r\n                  >\r\n                    <History size={10} />\r\n                    <span style={{ fontSize: 10, fontWeight: 600 }}>변경 {changeLogs.length}항목</span>\r\n                    {hasNewLog && <span style={wfLogSparkle}><Sparkles size={7} /></span>}\r\n                  </button>\r\n                )}\r\n                {rejectLogs.length > 0 && (\r\n                  <button\r\n                    type=\"button\"\r\n                    data-log-entry-btn={`tab-reject-${modeKey}`}\r\n                    onClick={(event) => { openGroupLogPopover(`tab-reject-${modeKey}`, tabLabel, targetEntryIds, event.currentTarget, 'reject'); }}\r\n                    style={{ ...wfRejectLogBtn, gap: 4, padding: '2px 8px', width: 'auto', height: 'auto', borderRadius: 8 }}\r\n                    title=\"검토 의견 로그 보기\"\r\n                  >\r\n                    <AlertCircle size={10} />\r\n                    <span style={{ fontSize: 10, fontWeight: 600 }}>의견 {rejectLogs.length}항목</span>\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          );\r\n        })()}\r\n      </div>\r\n      <div style={{ ...sheetContainer, borderTopLeftRadius: 0 }}>\r\n        {/* 빈 상태 안내 */}\r\n        {Object.keys(tree).length === 0 && (\r\n          <div style={{ padding: '48px 24px', textAlign: 'center', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12 }}>\r\n            <div style={{ width: 48, height: 48, borderRadius: '50%', background: '#f1f5f9', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 22 }}>\r\n              {showCombinedTypeView ? '📊' : (viewType === 'income' ? '📥' : '📤')}\r\n            </div>\r\n            <div>\r\n              <p style={{ margin: 0, fontSize: '14px', fontWeight: 700, color: '#334155' }}>\r\n                {showCombinedTypeView ? '수입/지출 예산 항목이 없습니다' : `${viewType === 'income' ? '수입' : '지출'} 예산 항목이 없습니다`}\r\n              </p>\r\n              <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#94a3b8' }}>\r\n                상단의 <strong>항목 추가</strong> 버튼으로 예산 목을 추가해 주세요.\r\n              </p>\r\n            </div>\r\n            {isVersionEditable && (\r\n              <button\r\n                style={{ ...btnPlus, padding: '8px 18px', fontSize: '12px', gap: 6, alignItems: 'center', display: 'flex', marginTop: 4 }}\r\n                onClick={() => setIsAddOpen(true)}\r\n              >\r\n                <Plus size={13} /> 항목 추가\r\n              </button>\r\n            )}\r\n          </div>\r\n        )}\r\n        {Object.keys(tree).length > 0 && (\r\n          <DragDropContext onDragEnd={onDragEnd}>\r\n            <table style={sheetTable}>\r\n              <colgroup>\r\n                <col style={{ width: '8%' }} />\r\n                <col style={{ width: '8%' }} />\r\n                <col style={{ width: '8%' }} />\r\n                <col style={{ width: '12%' }} />\r\n                <col style={{ width: '7%' }} />\r\n                <col style={{ width: '25%' }} />\r\n                <col style={{ width: '6%' }} />\r\n                <col style={{ width: '2.4%' }} />\r\n                <col style={{ width: '3%' }} />\r\n                <col style={{ width: '2.4%' }} />\r\n                <col style={{ width: '3%' }} />\r\n                <col style={{ width: '2.6%' }} />\r\n                <col style={{ width: '7%' }} />\r\n                <col style={{ width: '1.6%' }} />\r\n              </colgroup>\r\n              <thead>\r\n                <tr style={{ height: 40 }}>\r\n                  <th style={{ ...thStyle, background: '#f0f4fa' }}>장 (사업명)</th>\r\n                  <th style={{ ...thStyle, background: '#f0f4fa' }}>관</th>\r\n                  <th style={{ ...thStyle, background: '#f0f4fa' }}>항</th>\r\n                  <th style={{ ...thStyle, background: '#f0f4fa' }}>목</th>\r\n                  <th style={{ ...thNum, background: '#f0f4fa' }}>예산액</th>\r\n                  <th style={{ ...thCalcMerged, background: '#f0f4fa', borderRight: 'none' }} colSpan={9}>\r\n                    산출내역 및 근거 &nbsp;\r\n                    <span style={{ fontSize: '10px', fontWeight: 500, color: '#94a3b8' }}>( 항목명 · 단가 × 수량 × 빈도 = 소계 )</span>\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              {Object.values(tree).map((jang, ji, jangArr) => {\r\n                const gwanList = Object.values(jang.children);\r\n                const isLastJangInList = ji === jangArr.length - 1;\r\n                const b = (base, hide) => hide ? { ...base, borderBottom: 'none' } : base;\r\n                const t = (base, show) => show ? { ...base, borderTop: '1px solid #e2e8f0' } : base;\r\n\r\n                return (\r\n                  <React.Fragment key={jang.name}>\r\n                    {gwanList.map((gwan, gi) => {\r\n                      const hangList = Object.values(gwan.children);\r\n                      const isLastGwanInList = gi === gwanList.length - 1;\r\n\r\n                      return (\r\n                        <React.Fragment key={gi}>\r\n                          <tbody>\r\n                            <tr style={rowGwan}>\r\n                              {/* Jang column: only top border if it's the very first row of Jang */}\r\n                              <td style={t(b(tdSpanned, !(isLastJangInList && isLastGwanInList && hangList.length === 0)), gi === 0)}>\r\n                                {gi === 0 ? (\r\n                                  <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n                                    <span>{jang.name}</span>\r\n                                    {jang.obj && (\r\n                                      <button\r\n                                        type=\"button\"\r\n                                        onClick={() => setCommentSubjectTarget(prev =>\r\n                                          prev?.subjectId === jang.obj.id ? null : { subjectId: jang.obj.id, orgId: selectedScopeOrgId, label: `장 — ${jang.name}` }\r\n                                        )}\r\n                                        style={{\r\n                                          fontSize: 9, fontWeight: 700, padding: '1px 5px',\r\n                                          borderRadius: 5, border: '1px solid #bae6fd',\r\n                                          background: commentSubjectTarget?.subjectId === jang.obj.id ? '#bfdbfe' : '#f0f9ff',\r\n                                          color: '#0369a1', cursor: 'pointer',\r\n                                          display: 'inline-flex', alignItems: 'center', gap: 2,\r\n                                        }}\r\n                                        title=\"장 단위 의견\"\r\n                                      >\r\n                                        <MessageSquare size={8} />의견\r\n                                      </button>\r\n                                    )}\r\n                                    {jang.obj && (\r\n                                      <div\r\n                                        ref={el => { if (el) hierarchyActionRefs.current[`jang-${jang.obj.id}`] = el; }}\r\n                                        style={{ display: 'inline-block' }}\r\n                                      >\r\n                                        <button\r\n                                          type=\"button\"\r\n                                          style={{ ...mokActionTrigger, opacity: 0.5, transition: 'opacity .2s' }}\r\n                                          title=\"항목 작업\"\r\n                                          onClick={(event) => {\r\n                                            if (openHierarchyActionId === `jang-${jang.obj.id}`) {\r\n                                              closeHierarchyAction();\r\n                                              return;\r\n                                            }\r\n                                            openHierarchyAction(`jang-${jang.obj.id}`, event.currentTarget);\r\n                                          }}\r\n                                        >\r\n                                          <MoreHorizontal size={9} />\r\n                                        </button>\r\n                                      </div>\r\n                                    )}\r\n                                  </div>\r\n                                ) : ''}\r\n                              </td>\r\n                              {/* Gwan: Always top-border since this IS rowGwan */}\r\n                              <td style={t(b(tdBase, hangList.length > 0), true)}>\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n                                  <span>{gwan.obj?.name || '관 미지정'}</span>\r\n                                  {gwan.obj && (\r\n                                    <div\r\n                                      ref={el => { if (el) hierarchyActionRefs.current[`gwan-${gwan.obj.id}`] = el; }}\r\n                                      style={{ display: 'inline-block' }}\r\n                                    >\r\n                                      <button\r\n                                        type=\"button\"\r\n                                        style={{ ...mokActionTrigger, opacity: 0.5, transition: 'opacity .2s' }}\r\n                                        title=\"항목 작업\"\r\n                                        onClick={(event) => {\r\n                                          if (openHierarchyActionId === `gwan-${gwan.obj.id}`) {\r\n                                            closeHierarchyAction();\r\n                                            return;\r\n                                          }\r\n                                          openHierarchyAction(`gwan-${gwan.obj.id}`, event.currentTarget);\r\n                                        }}\r\n                                      >\r\n                                        <MoreHorizontal size={9} />\r\n                                      </button>\r\n                                    </div>\r\n                                  )}\r\n                                </div>\r\n                              </td>\r\n                              <td style={t(b({ ...tdBase, color: '#94a3b8', fontSize: '11px' }, true), true)}>\r\n                                {(() => {\r\n                                  const gwanEntryIds = hangList.flatMap(h => h.moks.map(({ entry: e }) => Number(e.id)));\r\n                                  const gwanChangeLogs = gwanEntryIds.filter(eid => {\r\n                                    const logs = entryLogsById[eid] || [];\r\n                                    return logs.some(l => !isRejectLog(l));\r\n                                  });\r\n                                  const gwanRejectLogs = gwanEntryIds.filter(eid => {\r\n                                    const logs = entryLogsById[eid] || [];\r\n                                    return logs.some(l => isRejectLog(l));\r\n                                  });\r\n                                  const hasNewLog = gwanEntryIds.some(eid => newLogEntries[String(eid)]);\r\n                                  const gwanName = gwan.obj?.name || '관';\r\n                                  return (\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n                                      <span>관 소계</span>\r\n                                      {gwan.obj && (\r\n                                        <button\r\n                                          type=\"button\"\r\n                                          onClick={() => setCommentSubjectTarget(prev =>\r\n                                            prev?.subjectId === gwan.obj.id ? null : { subjectId: gwan.obj.id, orgId: selectedScopeOrgId, label: `관 — ${gwanName}` }\r\n                                          )}\r\n                                          style={{\r\n                                            fontSize: 9, fontWeight: 700, padding: '1px 5px',\r\n                                            borderRadius: 5, border: '1px solid #bae6fd',\r\n                                            background: commentSubjectTarget?.subjectId === gwan.obj.id ? '#bfdbfe' : '#f0f9ff',\r\n                                            color: '#0369a1', cursor: 'pointer',\r\n                                            display: 'inline-flex', alignItems: 'center', gap: 2,\r\n                                          }}\r\n                                          title=\"관 단위 의견\"\r\n                                        >\r\n                                          <MessageSquare size={8} />의견\r\n                                        </button>\r\n                                      )}\r\n                                      {gwanChangeLogs.length > 0 && (\r\n                                        <button\r\n                                          type=\"button\"\r\n                                          data-log-entry-btn={`gwan-${gwan.obj?.id}`}\r\n                                          onClick={(event) => { openGroupLogPopover(`gwan-${gwan.obj?.id}`, gwanName, gwanEntryIds, event.currentTarget, 'change'); }}\r\n                                          style={{ ...wfLogBtn, ...(hasNewLog ? { color: '#1d4ed8', borderColor: '#93c5fd', background: '#eff6ff' } : {}), position: 'relative' }}\r\n                                          title={hasNewLog ? '새 변경 로그 확인' : '변경 로그 보기'}\r\n                                        >\r\n                                          <History size={10} />\r\n                                          {hasNewLog && <span style={wfLogSparkle}><Sparkles size={7} /></span>}\r\n                                        </button>\r\n                                      )}\r\n                                      {gwanRejectLogs.length > 0 && (\r\n                                        <button\r\n                                          type=\"button\"\r\n                                          data-log-entry-btn={`gwan-reject-${gwan.obj?.id}`}\r\n                                          onClick={(event) => { openGroupLogPopover(`gwan-reject-${gwan.obj?.id}`, gwanName, gwanEntryIds, event.currentTarget, 'reject'); }}\r\n                                          style={wfRejectLogBtn}\r\n                                          title=\"검토 의견 로그 보기\"\r\n                                        >\r\n                                          <AlertCircle size={10} />\r\n                                        </button>\r\n                                      )}\r\n                                    </div>\r\n                                  );\r\n                                })()}\r\n                              </td>\r\n                              <td style={t(b(tdBase, true), true)} />\r\n                              <td style={t(b({ ...tdAmtSum, fontWeight: 700 }, true), true)}>{num(gwan.total)}</td>\r\n                              <td style={t(tdCalcBase, true)} />\r\n                              <td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} />\r\n                              <td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} />\r\n                            </tr>\r\n                          </tbody>\r\n                          {hangList.map((hang, hi) => {\r\n                            const moks = hang.moks;\r\n                            const isLastHangInList = hi === hangList.length - 1;\r\n\r\n                            return (\r\n                              <React.Fragment key={hi}>\r\n                                <tbody>\r\n                                  <tr style={rowHang}>\r\n                                    {/* Jang, Gwan: Continuing, so no top border */}\r\n                                    <td style={t(b(tdEmpty, !(isLastJangInList && isLastGwanInList && isLastHangInList && moks.length === 0)), false)} />\r\n                                    <td style={t(b(tdBase, !(isLastGwanInList && isLastHangInList && moks.length === 0)), false)} />\r\n                                    {/* Hang: Starts here, top-border true */}\r\n                                    <td style={t(b(tdBase, moks.length > 0), true)}>\r\n                                      <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n                                        <span>{hang.obj?.name || '항 미지정'}</span>\r\n                                        {hang.obj && (\r\n                                          <div\r\n                                            ref={el => { if (el) hierarchyActionRefs.current[`hang-${hang.obj.id}`] = el; }}\r\n                                            style={{ display: 'inline-block' }}\r\n                                          >\r\n                                            <button\r\n                                              type=\"button\"\r\n                                              style={{ ...mokActionTrigger, opacity: 0.5, transition: 'opacity .2s' }}\r\n                                              title=\"항목 작업\"\r\n                                              onClick={(event) => {\r\n                                                if (openHierarchyActionId === `hang-${hang.obj.id}`) {\r\n                                                  closeHierarchyAction();\r\n                                                  return;\r\n                                                }\r\n                                                openHierarchyAction(`hang-${hang.obj.id}`, event.currentTarget);\r\n                                              }}\r\n                                            >\r\n                                              <MoreHorizontal size={9} />\r\n                                            </button>\r\n                                          </div>\r\n                                        )}\r\n                                      </div>\r\n                                    </td>\r\n                                    <td style={t(b({ ...tdBase, color: '#94a3b8', fontSize: '11px' }, true), true)}>\r\n                                      {(() => {\r\n                                        const hangEntryIds = moks.map(({ entry: e }) => Number(e.id));\r\n                                        const hangChangeLogs = hangEntryIds.filter(eid => {\r\n                                          const logs = entryLogsById[eid] || [];\r\n                                          return logs.some(l => !isRejectLog(l));\r\n                                        });\r\n                                        const hangRejectLogs = hangEntryIds.filter(eid => {\r\n                                          const logs = entryLogsById[eid] || [];\r\n                                          return logs.some(l => isRejectLog(l));\r\n                                        });\r\n                                        const hasNewLog = hangEntryIds.some(eid => newLogEntries[String(eid)]);\r\n                                        const hangName = hang.obj?.name || '항';\r\n                                        return (\r\n                                          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n                                            <span>항 소계</span>\r\n                                            {hang.obj && (\r\n                                              <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setCommentSubjectTarget(prev =>\r\n                                                  prev?.subjectId === hang.obj.id ? null : { subjectId: hang.obj.id, orgId: selectedScopeOrgId, label: `항 — ${hangName}` }\r\n                                                )}\r\n                                                style={{\r\n                                                  fontSize: 9, fontWeight: 700, padding: '1px 5px',\r\n                                                  borderRadius: 5, border: '1px solid #bae6fd',\r\n                                                  background: commentSubjectTarget?.subjectId === hang.obj.id ? '#bfdbfe' : '#f0f9ff',\r\n                                                  color: '#0369a1', cursor: 'pointer',\r\n                                                  display: 'inline-flex', alignItems: 'center', gap: 2,\r\n                                                }}\r\n                                                title=\"항 단위 의견\"\r\n                                              >\r\n                                                <MessageSquare size={8} />의견\r\n                                              </button>\r\n                                            )}\r\n                                            {hangChangeLogs.length > 0 && (\r\n                                              <button\r\n                                                type=\"button\"\r\n                                                data-log-entry-btn={`hang-${hang.obj?.id}`}\r\n                                                onClick={(event) => { openGroupLogPopover(`hang-${hang.obj?.id}`, hangName, hangEntryIds, event.currentTarget, 'change'); }}\r\n                                                style={{ ...wfLogBtn, ...(hasNewLog ? { color: '#1d4ed8', borderColor: '#93c5fd', background: '#eff6ff' } : {}), position: 'relative' }}\r\n                                                title={hasNewLog ? '새 변경 로그 확인' : '변경 로그 보기'}\r\n                                              >\r\n                                                <History size={10} />\r\n                                                {hasNewLog && <span style={wfLogSparkle}><Sparkles size={7} /></span>}\r\n                                              </button>\r\n                                            )}\r\n                                            {hangRejectLogs.length > 0 && (\r\n                                              <button\r\n                                                type=\"button\"\r\n                                                data-log-entry-btn={`hang-reject-${hang.obj?.id}`}\r\n                                                onClick={(event) => { openGroupLogPopover(`hang-reject-${hang.obj?.id}`, hangName, hangEntryIds, event.currentTarget, 'reject'); }}\r\n                                                style={wfRejectLogBtn}\r\n                                                title=\"검토 의견 로그 보기\"\r\n                                              >\r\n                                                <AlertCircle size={10} />\r\n                                              </button>\r\n                                            )}\r\n                                          </div>\r\n                                        );\r\n                                      })()}\r\n                                    </td>\r\n                                    <td style={t(b({ ...tdAmtSum, fontWeight: 700 }, true), true)}>{num(hang.total)}</td>\r\n                                    <td style={t(tdCalcBase, true)} />\r\n                                    <td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} />\r\n                                    <td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} /><td style={t(tdBlank, true)} />\r\n                                  </tr>\r\n                                </tbody>\r\n                                {moks.map(({ mok, entry: e }, mi) => {\r\n                                  const ds = [...(e.details || [])].sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));\r\n                                  const editable = e.status === 'DRAFT';\r\n                                  const isLastMokInList = mi === moks.length - 1;\r\n\r\n                                  if (ds.length === 0) {\r\n                                    const isVeryLastOfHang = isLastHangInList && isLastMokInList;\r\n                                    const isVeryLastOfGwan = isLastGwanInList && isVeryLastOfHang;\r\n                                    const isVeryLastOfJang = isLastJangInList && isVeryLastOfGwan;\r\n\r\n                                    return (\r\n                                      <tbody key={e.id}>\r\n                                        <tr style={rowMok}>\r\n                                          <td style={t(b(tdEmpty, !isVeryLastOfJang), false)} />\r\n                                          <td style={t(b(tdEmpty, !isVeryLastOfGwan), false)} />\r\n                                          <td style={t(b(tdEmpty, !isVeryLastOfHang), false)} />\r\n                                          <td style={t(tdMokLabelAction, true)}>\r\n                                            <div style={mokCellWrap}>\r\n                                              <div style={mokInlineHead}>\r\n                                                <span style={mokNameText} title={mok.name}>{mok.name}</span>\r\n                                                {renderMokActions(e.id)}\r\n                                              </div>\r\n                                              {renderEntryFlowInfo(e)}\r\n                                            </div>\r\n                                          </td>\r\n                                          <td style={t({ ...tdAmtMok, color: '#94a3b8' }, true)}>—</td>\r\n                                          <td style={t({ ...tdCalcBase, borderRight: 'none' }, true)} colSpan={9}>\r\n                                            {editable ? (\r\n                                              <button\r\n                                                type=\"button\"\r\n                                                onClick={() => addDetailRow(e.id)}\r\n                                                style={{ display: 'inline-flex', alignItems: 'center', gap: 4, fontSize: '10px', color: '#3b82f6', background: 'none', border: '1px dashed #bfdbfe', borderRadius: 6, padding: '2px 8px', cursor: 'pointer', fontWeight: 600 }}\r\n                                              >\r\n                                                <Plus size={10} /> 산출근거 추가\r\n                                              </button>\r\n                                            ) : (\r\n                                              <span style={{ fontSize: '11px', color: '#cbd5e1' }}>산출근거 없음</span>\r\n                                            )}\r\n                                          </td>\r\n                                        </tr>\r\n                                      </tbody>\r\n                                    );\r\n                                  } else {\r\n                                    return (\r\n                                      <Droppable key={e.id} droppableId={`drop-entry-${e.id}`} type={`entry-${e.id}`}>\r\n                                        {(provided) => (\r\n                                          <tbody ref={provided.innerRef} {...provided.droppableProps}>\r\n                                            {ds.map((d, di) => {\r\n                                              const isLastDetail = di === ds.length - 1;\r\n                                              const isVeryLastOfMok = isLastDetail;\r\n                                              const isVeryLastOfHang = isLastMokInList && isVeryLastOfMok;\r\n                                              const isVeryLastOfGwan = isLastGwanInList && isVeryLastOfHang;\r\n                                              const isVeryLastOfJang = isLastJangInList && isVeryLastOfGwan;\r\n\r\n                                              return (\r\n                                                <Draggable key={d.id} draggableId={`detail-${d.id}`} index={di} isDragDisabled={!editable}>\r\n                                                  {(dragProp) => (\r\n                                                    <tr ref={dragProp.innerRef} {...dragProp.draggableProps} style={{ ...dragProp.draggableProps.style, ...rowDetail, display: 'table-row' }}>\r\n                                                      <td style={t(b(tdEmpty, !isVeryLastOfJang), false)} />\r\n                                                      <td style={t(b(tdEmpty, !isVeryLastOfGwan), false)} />\r\n                                                      <td style={t(b(tdEmpty, !isVeryLastOfHang), false)} />\r\n                                                      <td style={t(b(di === 0 ? tdMokLabelActionCompact : tdBase, !isVeryLastOfMok), di === 0)}>\r\n                                                        {di === 0 && (\r\n                                                          <div style={mokCellWrap}>\r\n                                                            <div style={mokInlineHead}>\r\n                                                              <span style={mokNameText} title={mok.name}>{mok.name}</span>\r\n                                                              {renderMokActions(e.id)}\r\n                                                            </div>\r\n                                                            {renderEntryFlowInfo(e)}\r\n                                                          </div>\r\n                                                        )}\r\n                                                      </td>\r\n                                                      <td style={t(b(di === 0 ? tdAmtMokCompact : tdBudgetBlank, !isVeryLastOfMok), di === 0)}>\r\n                                                        {di === 0 ? num(e.total_amount_calc) : ''}\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcNameCell, di === 0)}>\r\n                                                        <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n                                                          <div {...dragProp.dragHandleProps} title=\"드래그로 순서 변경\" style={{ display: 'flex', alignItems: 'center', padding: '1px', borderRadius: 4, color: '#cbd5e1', cursor: editable ? 'grab' : 'default', flexShrink: 0 }}>\r\n                                                            <GripVertical size={11} />\r\n                                                          </div>\r\n                                                          <button\r\n                                                            type=\"button\"\r\n                                                            title=\"이 산출근거 삭제\"\r\n                                                            onClick={() => deleteDetail(d.id)}\r\n                                                            style={{ flexShrink: 0, width: 16, height: 16, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'none', border: 'none', cursor: 'pointer', color: '#fca5a5', padding: 0, borderRadius: 4, opacity: deletingDetailId === d.id ? 0.3 : 0.7 }}\r\n                                                          >\r\n                                                            <X size={10} />\r\n                                                          </button>\r\n                                                          <input\r\n                                                            name={`detail_name_${d.id}`}\r\n                                                            data-detail-name-id={d.id}\r\n                                                            style={fName}\r\n                                                            value={localDetails[d.id]?.name ?? d.name}\r\n                                                            disabled={!editable}\r\n                                                            placeholder=\"항목명 입력\"\r\n                                                            onChange={v => updateLocalDetail(d.id, { name: v.target.value })}\r\n                                                            onBlur={v => flushAutoSave(d.id, { name: v.target.value })}\r\n                                                            onKeyDown={evt => {\r\n                                                              if (evt.key === 'Enter' && editable) {\r\n                                                                evt.preventDefault();\r\n                                                                addDetailRow(e.id);\r\n                                                              }\r\n                                                            }}\r\n                                                          />\r\n                                                        </div>\r\n                                                      </td>\r\n                                                      <td style={t({ ...tdCalcPriceCell }, di === 0)}>\r\n                                                        <AutoResizeInput name={`detail_price_${d.id}`} style={fPrice} isNumber={true} value={localDetails[d.id]?.price ?? d.price}\r\n                                                          disabled={!editable}\r\n                                                          onChange={val => updateLocalDetail(d.id, { price: val })}\r\n                                                          onBlur={val => flushAutoSave(d.id, { price: val })}\r\n                                                        />\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcUnitOpCell, di === 0)}>\r\n                                                        <div style={formulaUnitOpWrap}>\r\n                                                          <AutoResizeInput\r\n                                                            name={`detail_currency_unit_${d.id}`}\r\n                                                            style={{ ...fUnit, color: '#94a3b8' }}\r\n                                                            value={localDetails[d.id]?.currency_unit ?? d.currency_unit ?? '원'}\r\n                                                            disabled={!editable}\r\n                                                            onChange={val => updateLocalDetail(d.id, { currency_unit: val })}\r\n                                                            onBlur={val => flushAutoSave(d.id, { currency_unit: val || '원' })}\r\n                                                          />\r\n                                                          <span style={formulaOperator}>×</span>\r\n                                                        </div>\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcQtyCell, di === 0)}>\r\n                                                        <AutoResizeInput name={`detail_qty_${d.id}`} style={fQty} isNumber={true} value={localDetails[d.id]?.qty ?? d.qty}\r\n                                                          disabled={!editable}\r\n                                                          onChange={val => updateLocalDetail(d.id, { qty: val })}\r\n                                                          onBlur={val => flushAutoSave(d.id, { qty: val })}\r\n                                                        />\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcUnitOpCell, di === 0)}>\r\n                                                        <div style={formulaUnitOpWrap}>\r\n                                                          <AutoResizeInput\r\n                                                            name={`detail_unit_${d.id}`}\r\n                                                            style={{ ...fUnit, color: '#94a3b8' }}\r\n                                                            value={localDetails[d.id]?.unit ?? d.unit ?? '식'}\r\n                                                            disabled={!editable}\r\n                                                            onChange={val => updateLocalDetail(d.id, { unit: val })}\r\n                                                            onBlur={val => flushAutoSave(d.id, { unit: val || '식' })}\r\n                                                          />\r\n                                                          <span style={formulaOperator}>×</span>\r\n                                                        </div>\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcQtyCell, di === 0)}>\r\n                                                        <AutoResizeInput name={`detail_freq_${d.id}`} style={fFreq} isNumber={true} value={localDetails[d.id]?.freq ?? d.freq}\r\n                                                          disabled={!editable}\r\n                                                          onChange={val => updateLocalDetail(d.id, { freq: val })}\r\n                                                          onBlur={val => flushAutoSave(d.id, { freq: val })}\r\n                                                        />\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcUnitOpCell, di === 0)}>\r\n                                                        <div style={formulaUnitOpWrap}>\r\n                                                          <AutoResizeInput\r\n                                                            name={`detail_freq_unit_${d.id}`}\r\n                                                            style={{ ...fUnit, color: '#94a3b8' }}\r\n                                                            value={localDetails[d.id]?.freq_unit ?? d.freq_unit ?? '회'}\r\n                                                            disabled={!editable}\r\n                                                            onChange={val => updateLocalDetail(d.id, { freq_unit: val })}\r\n                                                            onBlur={val => flushAutoSave(d.id, { freq_unit: val || '회' })}\r\n                                                          />\r\n                                                          <span style={{ ...formulaOperator, color: '#0f172a', fontWeight: 800 }}>=</span>\r\n                                                        </div>\r\n                                                      </td>\r\n                                                      <td style={t(tdCalcAmountCell, di === 0)}>\r\n                                                        <span style={{ fontWeight: 800 }}>{num((localDetails[d.id]?.price ?? d.price) * (localDetails[d.id]?.qty ?? d.qty) * (localDetails[d.id]?.freq ?? d.freq))}</span>\r\n                                                        <span style={{ fontSize: '10px', color: '#94a3b8', marginLeft: 2 }}>원</span>\r\n                                                      </td>\r\n                                                      <td style={t(tdBlank, di === 0)} />\r\n                                                    </tr>\r\n                                                  )}\r\n                                                </Draggable>\r\n                                              );\r\n                                            })}\r\n                                            {provided.placeholder}\r\n                                          </tbody>\r\n                                        )}\r\n                                      </Droppable>\r\n                                    );\r\n                                  }\r\n                                })}\r\n                              </React.Fragment>\r\n                            );\r\n                          })}\r\n                        </React.Fragment>\r\n                      );\r\n                    })}\r\n                  </React.Fragment>\r\n                );\r\n              })}\r\n            </table>\r\n          </DragDropContext>\r\n        )}\r\n        <style>\r\n          {`\r\n            input[type=number]::-webkit-inner-spin-button,\r\n            input[type=number]::-webkit-outer-spin-button {\r\n              -webkit-appearance: none;\r\n              margin: 0;\r\n            }\r\n          `}\r\n        </style>\r\n        <div style={tableBottomPad} />\r\n      </div>\r\n      {\r\n        openLogEntry && logAnchor && createPortal(\r\n          <div\r\n            ref={logPopoverRef}\r\n            style={{ ...logPopoverCard, zIndex: logPopoverZIndex, top: logAnchor.top, left: logAnchor.left }}\r\n          >\r\n            <div style={logPopoverHead}>\r\n              <div style={logPopoverHeadText}>\r\n                <strong style={logPopoverTitle}>\r\n                  {openLogEntry.mode === 'reject' ? '최근 검토 의견 로그' : '최근 변경 로그'}\r\n                </strong>\r\n                <span style={logPopoverSubtitle} title={openLogEntry.title}>{openLogEntry.title}</span>\r\n              </div>\r\n              <button type=\"button\" style={logPopoverCloseBtn} onClick={closeLogPopover} title=\"닫기\">\r\n                <X size={12} />\r\n              </button>\r\n            </div>\r\n            <div style={logPopoverList}>\r\n              {openLogEntry.groupKey && openLogGroupItems ? (\r\n                // 관/항 그룹 모드: 목(목 이름) 단위로 구분 표시\r\n                openLogGroupItems.length ? openLogGroupItems.map((item) => (\r\n                  <div key={item.entryId} style={logGroupSection}>\r\n                    <div style={logGroupSectionTitle}>{item.subjectName}</div>\r\n                    {item.logs.slice(0, 2).map((log, idx) => {\r\n                      const actor = log.actor_name || log.actor || '시스템';\r\n                      const from = statusLabel[log.from_status] || log.from_status || '-';\r\n                      const to = statusLabel[log.to_status] || log.to_status || '-';\r\n                      const reason = String(log.reason || '').trim();\r\n                      return (\r\n                        <div key={log.id || `${log.created_at}-${idx}`} style={logItemRow}>\r\n                          <div style={logItemMeta}>\r\n                            <span>{formatLogDateTime(log.created_at)}</span>\r\n                          </div>\r\n                          <div style={logItemFlow}>{actor} | {from} {'->'} {to}</div>\r\n                          {reason ? <div style={logItemReason}>{reason}</div> : null}\r\n                        </div>\r\n                      );\r\n                    })}\r\n                    {item.logs.length > 2 && (\r\n                      <div style={logGroupMore}>+{item.logs.length - 2}건 더</div>\r\n                    )}\r\n                  </div>\r\n                )) : (\r\n                  <div style={logItemEmpty}>표시할 로그가 없습니다.</div>\r\n                )\r\n              ) : (\r\n                // 목(mok) 단위 모드\r\n                openLogEntryRecent.length ? openLogEntryRecent.map((log, idx) => {\r\n                  const actor = log.actor_name || log.actor || '시스템';\r\n                  const from = statusLabel[log.from_status] || log.from_status || '-';\r\n                  const to = statusLabel[log.to_status] || log.to_status || '-';\r\n                  const reason = String(log.reason || '').trim();\r\n                  return (\r\n                    <div key={log.id || `${log.created_at}-${idx}`} style={logItemRow}>\r\n                      <div style={logItemMeta}>\r\n                        <span>{idx + 1}</span>\r\n                        <span>{formatLogDateTime(log.created_at)}</span>\r\n                      </div>\r\n                      <div style={logItemFlow}>{actor} | {from} {'->'} {to}</div>\r\n                      {reason ? <div style={logItemReason}>{reason}</div> : null}\r\n                    </div>\r\n                  );\r\n                }) : (\r\n                  <div style={logItemEmpty}>표시할 로그가 없습니다.</div>\r\n                )\r\n              )}\r\n            </div>\r\n            <div style={logPopoverFoot}>\r\n              <span style={logPopoverCount}>\r\n                {openLogEntryLogs.length > 5 ? `+${openLogEntryLogs.length - 5}건 더 있음` : `${openLogEntryLogs.length}건`}\r\n              </span>\r\n              {!openLogEntry.groupKey && (\r\n                <button\r\n                  type=\"button\"\r\n                  style={logPopoverMoreBtn}\r\n                  onClick={async () => {\r\n                    const modalEntry = { id: openLogEntry.id, subject_name: openLogEntry.title };\r\n                    const logMode = openLogEntry.mode || 'change';\r\n                    closeLogPopover();\r\n                    await openEntryHistoryLog(modalEntry, logMode);\r\n                  }}\r\n                >\r\n                  전체보기\r\n                </button>\r\n              )}\r\n            </div>\r\n          </div>,\r\n          document.body\r\n        )\r\n      }\r\n      {\r\n        openMokActionEntryId != null && mokActionAnchor && createPortal(\r\n          <div\r\n            ref={mokActionPopoverRef}\r\n            style={{ ...mokActionPopover, zIndex: actionPopoverZIndex, top: mokActionAnchor.top, left: mokActionAnchor.left }}\r\n          >\r\n            <button\r\n              type=\"button\"\r\n              style={{\r\n                ...bubbleActionBtn,\r\n                opacity: canEditEntry(openMokActionEntryId) ? 1 : 0.6,\r\n                cursor: canEditEntry(openMokActionEntryId) ? 'pointer' : 'not-allowed'\r\n              }}\r\n              onClick={() => {\r\n                const targetId = openMokActionEntryId;\r\n                closeMokAction();\r\n                addDetailRow(targetId);\r\n              }}\r\n              disabled={!canEditEntry(openMokActionEntryId) || addingEntryId === openMokActionEntryId}\r\n              title={canEditEntry(openMokActionEntryId) ? '산출근거 추가' : (isVersionEditable ? '작성중(DRAFT) 상태에서만 추가 가능' : '대기 상태 회차에서만 수정 가능')}\r\n            >\r\n              <Plus size={12} />\r\n              <span>{addingEntryId === openMokActionEntryId ? '추가 중...' : '산출근거 추가'}</span>\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              style={{\r\n                ...bubbleActionBtnDanger,\r\n                opacity: canEditEntry(openMokActionEntryId) ? 1 : 0.6,\r\n                cursor: canEditEntry(openMokActionEntryId) ? 'pointer' : 'not-allowed'\r\n              }}\r\n              onClick={() => {\r\n                const targetId = openMokActionEntryId;\r\n                closeMokAction();\r\n                deleteEntry(targetId);\r\n              }}\r\n              disabled={!canEditEntry(openMokActionEntryId)}\r\n              title={canEditEntry(openMokActionEntryId) ? '예산 항목 삭제' : (isVersionEditable ? '작성중(DRAFT) 상태에서만 삭제 가능' : '대기 상태 회차에서만 수정 가능')}\r\n            >\r\n              <Trash2 size={12} />\r\n              <span>예산 항목 삭제</span>\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              style={bubbleActionBtn}\r\n              onClick={() => {\r\n                const targetId = openMokActionEntryId;\r\n                closeMokAction();\r\n                setCommentEntryId(prev => prev === targetId ? null : targetId);\r\n              }}\r\n              title=\"의견 보기 / 등록\"\r\n            >\r\n              <MessageSquare size={12} />\r\n              <span>의견 보기</span>\r\n            </button>\r\n          </div>,\r\n          document.body\r\n        )\r\n      }\r\n      {\r\n        openHierarchyActionId != null && hierarchyActionAnchor && createPortal(\r\n          <div\r\n            ref={hierarchyActionPopoverRef}\r\n            style={{\r\n              position: 'fixed',\r\n              zIndex: actionPopoverZIndex,\r\n              top: hierarchyActionAnchor.top,\r\n              left: hierarchyActionAnchor.left,\r\n              display: 'flex',\r\n              alignItems: 'flex-start',\r\n              gap: 8,\r\n            }}\r\n          >\r\n            <div style={mokActionPopover}>\r\n              <button\r\n                type=\"button\"\r\n                style={{ ...bubbleActionBtn, opacity: isVersionEditable ? 1 : 0.6, cursor: isVersionEditable ? 'pointer' : 'not-allowed' }}\r\n                disabled={!isVersionEditable}\r\n                onClick={() => {\r\n                  if (!isVersionEditable) {\r\n                    pushToast(versionLockMessage, 'error');\r\n                    return;\r\n                  }\r\n                  if (Number(openHierarchyParentSubject?.level || 0) >= 4) {\r\n                    pushToast('목 항목에서는 하위 항목을 추가할 수 없습니다.', 'error');\r\n                    return;\r\n                  }\r\n                  setHierarchySelectedGwanId('');\r\n                  setHierarchySelectedHangId('');\r\n                  setHierarchySelectedMokId('');\r\n                  setIsHierarchyAddMenuOpen(prev => !prev);\r\n                }}\r\n                title=\"하위 항목 추가\"\r\n              >\r\n                <Plus size={12} />\r\n                <span>{isHierarchyAddMenuOpen ? '하위 항목 선택 닫기' : '하위 항목 추가'}</span>\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                style={{ ...bubbleActionBtnDanger, opacity: isVersionEditable ? 1 : 0.6, cursor: isVersionEditable ? 'pointer' : 'not-allowed' }}\r\n                disabled={!isVersionEditable}\r\n                onClick={async () => {\r\n                  if (!isVersionEditable) {\r\n                    pushToast(versionLockMessage, 'error');\r\n                    return;\r\n                  }\r\n                  closeHierarchyAction();\r\n                  const [_type, id] = openHierarchyActionId.split('-');\r\n                  const subject = subjects.find(s => s.id === Number(id));\r\n                  if (!subject) return;\r\n                  if (!confirm('이 항목과 하위 항목이 모두 삭제됩니다. 계속하시겠습니까?')) return;\r\n                  try {\r\n                    await authAxios.delete(`/api/subjects/${subject.id}/`);\r\n                    onRefresh();\r\n                  } catch (e) {\r\n                    alert(apiErrorMessage(e, '삭제 실패 (사용 중인 항목)'));\r\n                  }\r\n                }}\r\n                title=\"항목 삭제\"\r\n              >\r\n                <Trash2 size={12} />\r\n                <span>항목 삭제</span>\r\n              </button>\r\n            </div>\r\n            {isHierarchyAddMenuOpen && openHierarchyParentSubject && (\r\n              <div style={{ ...mokActionPopover, minWidth: 280, maxWidth: 340, padding: 8 }}>\r\n                <div style={{ fontSize: 11, fontWeight: 700, color: '#334155', padding: '2px 2px 6px' }}>\r\n                  단계별 추가 · {openHierarchyParentSubject.name}\r\n                </div>\r\n\r\n                {Number(openHierarchyParentSubject.level) >= 4 ? (\r\n                  <div style={{ fontSize: 11, color: '#94a3b8', padding: '4px 6px' }}>\r\n                    목 단계에서는 하위 항목이 없습니다.\r\n                  </div>\r\n                ) : (\r\n                  <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\r\n                    {Number(hierarchyStepOptions.level) === 1 && (\r\n                      <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\r\n                        <div style={{ fontSize: 10, fontWeight: 700, color: '#64748b', paddingLeft: 2 }}>1단계 관 선택</div>\r\n                        {hierarchyStepOptions.gwanOptions.length ? hierarchyStepOptions.gwanOptions.map((subject) => (\r\n                          <button\r\n                            key={`gwan-${subject.id}`}\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setHierarchySelectedGwanId(String(subject.id));\r\n                              setHierarchySelectedHangId('');\r\n                              setHierarchySelectedMokId('');\r\n                            }}\r\n                            style={{\r\n                              ...bubbleActionBtn,\r\n                              background: String(hierarchySelectedGwanId) === String(subject.id) ? '#dbeafe' : '#f8fafc',\r\n                              color: String(hierarchySelectedGwanId) === String(subject.id) ? '#1d4ed8' : '#334155',\r\n                              justifyContent: 'flex-start',\r\n                            }}\r\n                          >\r\n                            <span>[{subject.code}] {subject.name}</span>\r\n                          </button>\r\n                        )) : <div style={{ fontSize: 11, color: '#94a3b8', padding: '2px 6px' }}>추가 가능한 관이 없습니다.</div>}\r\n                      </div>\r\n                    )}\r\n\r\n                    {(Number(hierarchyStepOptions.level) === 2 || hierarchySelectedGwanId) && (\r\n                      <div style={{ display: 'flex', flexDirection: 'column', gap: 4, paddingLeft: 12 }}>\r\n                        <div style={{ fontSize: 10, fontWeight: 700, color: '#64748b', paddingLeft: 2 }}>2단계 항 선택</div>\r\n                        {hierarchyStepOptions.hangOptions.length ? hierarchyStepOptions.hangOptions.map((subject) => (\r\n                          <button\r\n                            key={`hang-${subject.id}`}\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setHierarchySelectedHangId(String(subject.id));\r\n                              setHierarchySelectedMokId('');\r\n                            }}\r\n                            style={{\r\n                              ...bubbleActionBtn,\r\n                              background: String(hierarchySelectedHangId) === String(subject.id) ? '#dbeafe' : '#f8fafc',\r\n                              color: String(hierarchySelectedHangId) === String(subject.id) ? '#1d4ed8' : '#334155',\r\n                              justifyContent: 'flex-start',\r\n                            }}\r\n                          >\r\n                            <span>[{subject.code}] {subject.name}</span>\r\n                          </button>\r\n                        )) : <div style={{ fontSize: 11, color: '#94a3b8', padding: '2px 6px' }}>선택 가능한 항이 없습니다.</div>}\r\n                      </div>\r\n                    )}\r\n\r\n                    {(Number(hierarchyStepOptions.level) === 3 || hierarchySelectedHangId) && (\r\n                      <div style={{ display: 'flex', flexDirection: 'column', gap: 4, paddingLeft: 24 }}>\r\n                        <div style={{ fontSize: 10, fontWeight: 700, color: '#64748b', paddingLeft: 2 }}>3단계 목 선택</div>\r\n                        {hierarchyStepOptions.mokOptions.length ? hierarchyStepOptions.mokOptions.map((subject) => {\r\n                          const isUsed = usedMokIdsInScope.has(Number(subject.id));\r\n                          const isSelected = String(hierarchySelectedMokId) === String(subject.id);\r\n                          return (\r\n                            <button\r\n                              key={`mok-${subject.id}`}\r\n                              type=\"button\"\r\n                              onClick={() => { if (!isUsed) setHierarchySelectedMokId(String(subject.id)); }}\r\n                              disabled={isUsed}\r\n                              style={{\r\n                                ...bubbleActionBtn,\r\n                                background: isSelected ? '#dbeafe' : (isUsed ? '#f1f5f9' : '#f8fafc'),\r\n                                color: isUsed ? '#94a3b8' : (isSelected ? '#1d4ed8' : '#334155'),\r\n                                justifyContent: 'flex-start',\r\n                                cursor: isUsed ? 'not-allowed' : 'pointer',\r\n                                opacity: isUsed ? 0.7 : 1,\r\n                              }}\r\n                            >\r\n                              <span>[{subject.code}] {subject.name}{isUsed ? ' (이미 추가됨)' : ''}</span>\r\n                            </button>\r\n                          );\r\n                        }) : <div style={{ fontSize: 11, color: '#94a3b8', padding: '2px 6px' }}>선택 가능한 목이 없습니다.</div>}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                )}\r\n\r\n                <div style={{ borderTop: '1px solid #e2e8f0', marginTop: 8, paddingTop: 8 }}>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={addEntryFromHierarchyMenu}\r\n                    disabled={!isVersionEditable || hierarchyAddLoading || !hierarchySelectedMokId}\r\n                    style={{\r\n                      ...bubbleActionBtn,\r\n                      background: '#eff6ff',\r\n                      color: '#1d4ed8',\r\n                      border: '1px solid #bfdbfe',\r\n                      justifyContent: 'center',\r\n                      cursor: (!isVersionEditable || hierarchyAddLoading || !hierarchySelectedMokId) ? 'not-allowed' : 'pointer',\r\n                      opacity: (!isVersionEditable || hierarchyAddLoading || !hierarchySelectedMokId) ? 0.6 : 1,\r\n                    }}\r\n                  >\r\n                    <Plus size={12} />\r\n                    <span>{hierarchyAddLoading ? '추가 중...' : '선택 항목 추가'}</span>\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>,\r\n          document.body\r\n        )\r\n      }\r\n      {\r\n        isAddOpen && (\r\n          <QuickAddModal\r\n            subjects={subjects}\r\n            entries={entries}\r\n            projects={projects}\r\n            orgs={orgs}\r\n            projectId={projectId}\r\n            orgId={selectedScopeOrgId}\r\n            year={version?.year}\r\n            viewType={viewType}\r\n            authAxios={authAxios}\r\n            version={version}\r\n            isVersionEditable={isVersionEditable}\r\n            versionLockMessage={versionLockMessage}\r\n            overlayZIndex={nestedOverlayZIndex}\r\n            onClose={() => setIsAddOpen(false)}\r\n            onRefresh={onRefresh}\r\n          />\r\n        )\r\n      }\r\n      {commentEntryId != null && version?.id && (() => {\r\n        const targetEntry = entries.find(e => e.id === commentEntryId) || activeEntries.find(e => e.id === commentEntryId);\r\n        const label = targetEntry?.subject_name || targetEntry?.subject_code || `#${commentEntryId}`;\r\n        return (\r\n          <div style={{\r\n            position: 'fixed', top: 0, right: 0, bottom: 0,\r\n            width: 'min(400px, 100vw)',\r\n            zIndex: commentPanelZIndex,\r\n            boxShadow: '-4px 0 20px rgba(15,23,42,0.15)',\r\n            display: 'flex', flexDirection: 'column',\r\n          }}>\r\n            <CommentThread\r\n              authAxios={authAxios}\r\n              versionId={version.id}\r\n              entryId={commentEntryId}\r\n              title={`의견 — ${label}`}\r\n              onClose={() => setCommentEntryId(null)}\r\n              user={user}\r\n            />\r\n          </div>\r\n        );\r\n      })()}\r\n      {commentSubjectTarget != null && version?.id && (\r\n        <div style={{\r\n          position: 'fixed', top: 0, right: 0, bottom: 0,\r\n          width: 'min(400px, 100vw)',\r\n          zIndex: commentPanelZIndex,\r\n          boxShadow: '-4px 0 20px rgba(15,23,42,0.15)',\r\n          display: 'flex', flexDirection: 'column',\r\n        }}>\r\n          <CommentThread\r\n            authAxios={authAxios}\r\n            versionId={version.id}\r\n            subjectId={commentSubjectTarget.subjectId}\r\n            orgId={commentSubjectTarget.orgId}\r\n            title={commentSubjectTarget.label}\r\n            onClose={() => setCommentSubjectTarget(null)}\r\n            user={user}\r\n            onCommentAdded={(commentType) => {\r\n              const childEntries = getEntriesUnderSubject(commentSubjectTarget.subjectId);\r\n              if (childEntries.length > 0) {\r\n                setBulkCommentDialog({\r\n                  commentType,\r\n                  subjectId: commentSubjectTarget.subjectId,\r\n                  orgId: commentSubjectTarget.orgId,\r\n                  label: commentSubjectTarget.label,\r\n                  versionId: version.id,\r\n                  childEntries,\r\n                });\r\n              }\r\n            }}\r\n          />\r\n        </div>\r\n      )}\r\n      {bulkCommentDialog && (\r\n        <div style={{\r\n          position: 'fixed', inset: 0, background: 'rgba(15,23,42,0.45)',\r\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n          zIndex: commentPanelZIndex + 10,\r\n        }}>\r\n          <div style={{\r\n            background: '#fff', borderRadius: 12, padding: '24px 28px',\r\n            width: 380, boxShadow: '0 8px 32px rgba(15,23,42,0.18)',\r\n            display: 'flex', flexDirection: 'column', gap: 16,\r\n          }}>\r\n            <div style={{ fontSize: 15, fontWeight: 700, color: '#0f172a' }}>\r\n              하위 항목에도 적용하시겠습니까?\r\n            </div>\r\n            <div style={{ fontSize: 13, color: '#475569', lineHeight: 1.6 }}>\r\n              <b>{bulkCommentDialog.label}</b> 하위의{' '}\r\n              <b>{bulkCommentDialog.childEntries.length}개</b> 목(mok)에\r\n              <br />\r\n              <span style={{\r\n                display: 'inline-block', marginTop: 4,\r\n                padding: '2px 8px', borderRadius: 999, fontSize: 12, fontWeight: 700,\r\n                background: { DONE: '#dcfce7', REQUEST: '#fee2e2', QUESTION: '#fef9c3', ANSWER: '#f3e8ff' }[bulkCommentDialog.commentType] || '#f1f5f9',\r\n                color: { DONE: '#166534', REQUEST: '#b91c1c', QUESTION: '#854d0e', ANSWER: '#6b21a8' }[bulkCommentDialog.commentType] || '#475569',\r\n              }}>\r\n                {{ DONE: '작성완료', REQUEST: '수정요청', QUESTION: '질문', ANSWER: '답변' }[bulkCommentDialog.commentType]}\r\n              </span>\r\n              {' '}의견을 일괄 등록합니다.\r\n            </div>\r\n            <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', flexWrap: 'wrap' }}>\r\n              <button\r\n                type=\"button\"\r\n                disabled={bulkPosting}\r\n                onClick={() => setBulkCommentDialog(null)}\r\n                style={{ padding: '8px 16px', borderRadius: 7, border: '1px solid #e2e8f0', background: '#fff', fontSize: 13, fontWeight: 600, color: '#64748b', cursor: 'pointer' }}\r\n              >\r\n                취소\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                disabled={bulkPosting}\r\n                onClick={() => {\r\n                  const targets = bulkCommentDialog.childEntries.filter(e => e.latest_comment_type !== 'DONE');\r\n                  executeBulkComment(bulkCommentDialog.commentType, targets, bulkCommentDialog.versionId, bulkCommentDialog.orgId);\r\n                }}\r\n                style={{ padding: '8px 16px', borderRadius: 7, border: 'none', background: '#64748b', fontSize: 13, fontWeight: 600, color: '#fff', cursor: 'pointer' }}\r\n              >\r\n                {bulkPosting ? '처리 중…' : '미완료만 적용'}\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                disabled={bulkPosting}\r\n                onClick={() => executeBulkComment(bulkCommentDialog.commentType, bulkCommentDialog.childEntries, bulkCommentDialog.versionId, bulkCommentDialog.orgId)}\r\n                style={{ padding: '8px 16px', borderRadius: 7, border: 'none', background: '#3b82f6', fontSize: 13, fontWeight: 700, color: '#fff', cursor: 'pointer' }}\r\n              >\r\n                {bulkPosting ? '처리 중…' : '전체 적용'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      <div style={{ ...toastViewport, zIndex: toastZIndex }}>\r\n        {toastItems.map(item => (\r\n          <div key={item.id} style={{ ...toastItem, ...(item.type === 'error' ? toastItemError : toastItemSuccess) }}>\r\n            {item.message}\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div >\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\components\\ActionBtn.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\components\\AddSubjectModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\components\\OrgAddModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\components\\ProjCloneModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\components\\SnapshotPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\components\\SubjectRow.jsx","messages":[{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  37 |     return (\n  38 |         <tr\n> 39 |             ref={dragProvided.innerRef}\n     |                  ^^^^^^^^^^^^^^^^^^^^^ Cannot access ref value during render\n  40 |             {...dragProvided.draggableProps}\n  41 |             className=\"srow\"\n  42 |             style={{","line":39,"column":18,"nodeType":null,"endLine":39,"endColumn":39},{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  38 |         <tr\n  39 |             ref={dragProvided.innerRef}\n> 40 |             {...dragProvided.draggableProps}\n     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^ Cannot access ref value during render\n  41 |             className=\"srow\"\n  42 |             style={{\n  43 |                 ...dragProvided.draggableProps.style,","line":40,"column":17,"nodeType":null,"endLine":40,"endColumn":44},{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  40 |             {...dragProvided.draggableProps}\n  41 |             className=\"srow\"\n> 42 |             style={{\n     |                    ^\n> 43 |                 ...dragProvided.draggableProps.style,\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 44 |                 display: 'table-row',\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 45 |                 '--srow-hov': LVL_ROW_HOV[lvlIdx],\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 46 |                 background: rowBg,\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 47 |                 opacity: isBusy ? 0.65 : 1,\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 48 |                 borderTop: LVL_TOP_BORDER[lvlIdx],\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 49 |                 borderBottom: 'none',\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 50 |             }}\n     | ^^^^^^^^^^^^^^ Cannot access ref value during render\n  51 |         >\n  52 |             {/* accent bar */}\n  53 |             <td style={{ padding: 0, width: accentW || 1, verticalAlign: 'stretch' }}>","line":42,"column":20,"nodeType":null,"endLine":50,"endColumn":14},{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  41 |             className=\"srow\"\n  42 |             style={{\n> 43 |                 ...dragProvided.draggableProps.style,\n     |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Cannot access ref value during render\n  44 |                 display: 'table-row',\n  45 |                 '--srow-hov': LVL_ROW_HOV[lvlIdx],\n  46 |                 background: rowBg,","line":43,"column":20,"nodeType":null,"endLine":43,"endColumn":53},{"ruleId":"react-hooks/refs","severity":2,"message":"Error: Cannot access refs during render\n\nReact refs are values that are not needed for rendering. Refs should only be accessed outside of render, such as in event handlers or effects. Accessing a ref value (the `current` property) during render can cause your component not to update as expected (https://react.dev/reference/react/useRef).\n\n  59 |             <td style={{ padding: 0, width: 20, verticalAlign: 'middle' }}>\n  60 |                 <div\n> 61 |                     {...dragProvided.dragHandleProps}\n     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Cannot access ref value during render\n  62 |                     style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: 28, cursor: 'grab', color: '#cbd5e1' }}\n  63 |                 >\n  64 |                     <GripVertical size={13} />","line":61,"column":25,"nodeType":null,"endLine":61,"endColumn":53}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport {\r\n    ArrowRightLeft, Check, ChevronDown, ChevronRight, Copy, Edit3,\r\n    FileText, GripVertical, Plus, Trash2\r\n} from 'lucide-react';\r\nimport { ActionBtn } from './ActionBtn';\r\nimport {\r\n    LVL_COLORS, LVL_BG, LVL_BORDER, LVL_NAMES, INDENT, LVL_ROW_BG, LVL_ROW_HOV, LVL_TOP_BORDER\r\n} from '../styles';\r\n\r\nexport default function SubjectRow({\n    s, depth, isLastChild, dragProvided, isDragging,\n    editingId, editData, setEditData, saveEdit, cancelEdit,\n    subjectBusyId, expanded, toggle, countDescendants,\n    onAddChild, onStartEdit, onCopy, onCut, onDelete,\n    canPaste, clipboardMode, onPaste,\n}) {\n    const isEditing = editingId === s.id;\r\n    const hasChildren = s.children.length > 0;\r\n    const isExpanded = expanded[s.id];\r\n    const lvlIdx = s.level - 1;\r\n    const isBusy = subjectBusyId === s.id;\r\n\r\n    const lvlColor = LVL_COLORS[lvlIdx];\r\n    const lvlBgCol = LVL_BG[lvlIdx];\r\n    const lvlBorder = LVL_BORDER[lvlIdx];\r\n\r\n    const accentW = [4, 3, 2, 0][lvlIdx];\r\n    const accentOpacity = [1, 0.7, 0.5, 0][lvlIdx];\r\n    const indentPx = depth * INDENT;\r\n\r\n    const rowBg = isEditing ? '#fefce8'\r\n        : isDragging ? '#e0e7ff'\r\n            : isBusy ? '#f8fafc'\r\n                : LVL_ROW_BG[lvlIdx];\r\n\r\n    return (\r\n        <tr\n            ref={dragProvided.innerRef}\n            {...dragProvided.draggableProps}\n            className=\"srow\"\n            style={{\n                ...dragProvided.draggableProps.style,\n                display: 'table-row',\n                '--srow-hov': LVL_ROW_HOV[lvlIdx],\n                background: rowBg,\n                opacity: isBusy ? 0.65 : 1,\n                borderTop: LVL_TOP_BORDER[lvlIdx],\n                borderBottom: 'none',\n            }}\r\n        >\r\n            {/* accent bar */}\r\n            <td style={{ padding: 0, width: accentW || 1, verticalAlign: 'stretch' }}>\r\n                {accentW > 0 && (\r\n                    <div style={{ width: accentW, minHeight: '100%', background: lvlColor, opacity: accentOpacity }} />\r\n                )}\r\n            </td>\r\n            {/* drag grip */}\r\n            <td style={{ padding: 0, width: 20, verticalAlign: 'middle' }}>\r\n                <div\r\n                    {...dragProvided.dragHandleProps}\r\n                    style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: 28, cursor: 'grab', color: '#cbd5e1' }}\r\n                >\r\n                    <GripVertical size={13} />\r\n                </div>\r\n            </td>\r\n\r\n            <td style={{ padding: `5px 8px 5px ${8 + indentPx}px`, verticalAlign: 'middle', position: 'relative' }}>\r\n                {Array.from({ length: depth }).map((_, i) => {\r\n                    const lineX = 8 + i * INDENT + 9;\r\n                    return (\r\n                        <div key={i} style={{ position: 'absolute', left: lineX, top: 0, bottom: 0, width: 1, background: '#c8d5e8', pointerEvents: 'none' }}>\r\n                            {i === depth - 1 && isLastChild && (\r\n                                <div style={{ position: 'absolute', top: '50%', left: 0, bottom: 0, width: 1, background: rowBg === 'transparent' ? '#fff' : rowBg, zIndex: 1 }} />\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n                {depth > 0 && (\r\n                    <div style={{ position: 'absolute', left: 8 + (depth - 1) * INDENT + 9, top: '50%', width: INDENT - 9, height: 1, background: '#c8d5e8', pointerEvents: 'none' }} />\r\n                )}\r\n\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: 6, position: 'relative' }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 6, minWidth: 0 }}>\r\n                        {hasChildren ? (\r\n                            <span onClick={() => toggle(s.id)} style={{\r\n                                cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                                width: 15, height: 15, borderRadius: 3, flexShrink: 0,\r\n                                background: lvlBgCol, border: `1px solid ${lvlBorder}`, color: lvlColor,\r\n                            }}>\r\n                                {isExpanded ? <ChevronDown size={8} /> : <ChevronRight size={8} />}\r\n                            </span>\r\n                        ) : (\r\n                            <span style={{ width: 15, flexShrink: 0 }} />\r\n                        )}\r\n\r\n                        <span style={{\r\n                            display: 'inline-flex', alignItems: 'center', justifyContent: 'center',\r\n                            width: 22, height: 18, borderRadius: 4, fontSize: '10px', fontWeight: 800,\r\n                            background: lvlBgCol, color: lvlColor, border: `1px solid ${lvlBorder}`,\r\n                            flexShrink: 0,\r\n                        }}>\r\n                            {LVL_NAMES[lvlIdx]}\r\n                        </span>\r\n\r\n                        {isEditing ? (\r\n                            <input\r\n                                autoFocus\r\n                                style={{\r\n                                    border: `1.5px solid ${lvlColor}`, borderRadius: 5,\r\n                                    padding: '3px 8px', fontSize: '12px', flex: 1, minWidth: 0,\r\n                                    outline: 'none', fontWeight: 700,\r\n                                    boxShadow: `0 0 0 2px ${lvlColor}22`,\r\n                                }}\r\n                                value={editData.name}\r\n                                onChange={e => setEditData(p => ({ ...p, name: e.target.value }))}\r\n                                onKeyDown={e => { if (e.key === 'Enter') saveEdit(s.id); if (e.key === 'Escape') cancelEdit(); }}\r\n                            />\r\n                        ) : (\r\n                            <span style={{\r\n                                fontSize: lvlIdx === 0 ? '13px' : '12px',\r\n                                fontWeight: lvlIdx === 0 ? 800 : lvlIdx === 1 ? 700 : lvlIdx === 2 ? 600 : 500,\r\n                                color: lvlIdx === 0 ? '#0f172a' : lvlIdx === 1 ? '#1e293b' : lvlIdx === 2 ? '#334155' : '#475569',\r\n                                letterSpacing: lvlIdx === 0 ? '-0.01em' : 'normal',\r\n                                whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis',\r\n                            }}>\r\n                                {s.name}\r\n                            </span>\r\n                        )}\r\n\r\n                        {hasChildren && !isEditing && (\r\n                            <span style={{ fontSize: '10px', color: '#94a3b8', background: '#f1f5f9', borderRadius: 8, padding: '1px 6px', whiteSpace: 'nowrap', flexShrink: 0 }}>\r\n                                {countDescendants(s)}\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n\r\n                    {isEditing ? (\r\n                        <div style={{ display: 'inline-flex', gap: 4, flexShrink: 0 }}>\r\n                            <button onClick={() => saveEdit(s.id)}\r\n                                style={{ background: '#2563eb', color: '#fff', border: 'none', borderRadius: 5, padding: '3px 10px', fontSize: '11px', fontWeight: 700, cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: 3 }}>\r\n                                <Check size={10} /> 저장\r\n                            </button>\r\n                            <button onClick={cancelEdit}\r\n                                style={{ background: '#f1f5f9', color: '#64748b', border: '1px solid #e2e8f0', borderRadius: 5, padding: '3px 8px', fontSize: '11px', cursor: 'pointer' }}>\r\n                                취소\r\n                            </button>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"srow-actions\" style={{ display: 'inline-flex', gap: 3, flexShrink: 0 }}>\r\n                            <ActionBtn icon={<Edit3 size={10} />} label=\"수정\" color=\"#2563eb\" bg=\"#eff6ff\" border=\"#bfdbfe\"\r\n                                onClick={() => onStartEdit(s)} disabled={isBusy} />\r\n                            {s.level < 4 && (\r\n                                <ActionBtn icon={<Plus size={10} />} label={`${LVL_NAMES[s.level]} 추가`} color=\"#059669\" bg=\"#ecfdf5\" border=\"#6ee7b7\"\r\n                                    onClick={() => onAddChild(s)} disabled={isBusy} />\r\n                            )}\r\n                            <ActionBtn icon={<Copy size={10} />} label=\"복사\" color=\"#7c3aed\" bg=\"#f5f3ff\" border=\"#c4b5fd\"\r\n                                onClick={() => onCopy(s)} disabled={isBusy} />\r\n                            <ActionBtn icon={<ArrowRightLeft size={10} />} label=\"잘라내기\" color=\"#d97706\" bg=\"#fffbeb\" border=\"#fde68a\"\r\n                                onClick={() => onCut(s)} disabled={isBusy} />\r\n                            {canPaste && (\r\n                                <ActionBtn\r\n                                    icon={<FileText size={10} />}\r\n                                    label={clipboardMode === 'cut' ? '여기로 이동' : '붙여넣기'}\r\n                                    color={clipboardMode === 'cut' ? '#d97706' : '#0891b2'}\r\n                                    bg={clipboardMode === 'cut' ? '#fffbeb' : '#ecfeff'}\r\n                                    border={clipboardMode === 'cut' ? '#fde68a' : '#a5f3fc'}\r\n                                    onClick={() => onPaste(s)} disabled={isBusy} />\r\n                            )}\r\n                            <ActionBtn icon={<Trash2 size={10} />} label=\"삭제\" color=\"#dc2626\" bg=\"#fef2f2\" border=\"#fecaca\"\r\n                                onClick={() => onDelete(s.id)} disabled={isBusy} />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </td>\r\n        </tr>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\hooks\\useOrgManagement.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\hooks\\useProjectManagement.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\hooks\\useSubjectManagement.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\subjectManagement\\styles.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\components\\AutoResizeInput.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\components\\HierarchyEntrySelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\components\\QuickAddModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\hooks\\useExcelExport.js","messages":[],"suppressedMessages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\[.","line":19,"column":57,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":19,"endColumn":58,"suggestions":[{"messageId":"removeEscape","fix":{"range":[653,654],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[653,653],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\hooks\\useWorkflow.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\shared.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\styles.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\core\\traditionalLedger\\uiStyles.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":5,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":5,"endColumn":18},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":6,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":6,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":7,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":7,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":8,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":8,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":10,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":10,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":11,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":11,"endColumn":18},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":12,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":12,"endColumn":18},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":13,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":13,"endColumn":18},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":15,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":15,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":16,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":16,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":18,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":18,"endColumn":16}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\n\nexport const Label = ({ children }) => <span style={{ fontSize: '12pt', fontWeight: 800, color: '#64748b', letterSpacing: '0.02em', textTransform: 'uppercase' }}>{children}</span>;\n\nexport const over = { position: 'fixed', inset: 0, background: 'rgba(15, 23, 42, 0.4)', zIndex: 3000, display: 'flex', justifyContent: 'flex-end', backdropFilter: 'blur(4px)' };\nexport const drw = { width: 440, background: '#fff', display: 'flex', flexDirection: 'column', boxShadow: '-20px 0 25px -5px rgb(0 0 0 / 0.1)' };\nexport const drH = { padding: '24px 32px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' };\nexport const drB = { padding: '32px', display: 'flex', flexDirection: 'column', gap: 24 };\n\nexport const fld = { display: 'flex', flexDirection: 'column', gap: 8 };\nexport const selF = { padding: '12px 16px', borderRadius: 10, border: '1px solid #cbd5e1', background: '#f8fafc', fontSize: '0.9rem' };\nexport const btnP = { background: '#0059b3', color: '#fff', border: 'none', padding: '16px', borderRadius: 12, fontWeight: 800, cursor: 'pointer', fontSize: '1rem' };\nexport const btnG = { padding: '12px 24px', border: '1px solid #e2e8f0', background: '#fff', borderRadius: 12, fontWeight: 700, cursor: 'pointer', color: '#64748b' };\n\nexport const mOv = { position: 'fixed', inset: 0, background: 'rgba(15, 23, 42, 0.5)', zIndex: 10000, display: 'flex', alignItems: 'center', justifyContent: 'center', backdropFilter: 'blur(4px)' };\nexport const mCd = { background: '#fff', padding: '40px', borderRadius: 24, width: 440, boxShadow: '0 25px 50px -12px rgb(0 0 0 / 0.25)' };\n\nexport const cp = { cursor: 'pointer' };\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\MenuPageRouter.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\components\\AnomalyPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\components\\LogFilter.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\components\\LogTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\components\\StatusBadge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\index.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'menuStyles' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"menuStyles"},"fix":{"range":[126,138],"text":""},"desc":"Remove unused variable 'menuStyles'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport * as XLSX from 'xlsx';\r\nimport { MenuShell, menuStyles } from '../../shared/menuUi.jsx';\nimport { apiErrorMessage, toList, formatDatetime } from '../../shared/utils';\nimport { STATUS_KO } from './constants';\r\nimport { detectAnomalies } from './utils';\r\n\r\nimport AnomalyPanel from './components/AnomalyPanel';\r\nimport LogFilter from './components/LogFilter';\r\nimport LogTable from './components/LogTable';\r\n\r\nexport default function AuditLogPage({ menuId, authAxios, user, modalApi }) {\r\n    const [logs, setLogs] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Filters\r\n    const [keyword, setKeyword] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState('');\r\n    const [actorFilter, setActorFilter] = useState('');\r\n    const [entryFilter, setEntryFilter] = useState('');\r\n    const [fromDate, setFromDate] = useState('');\r\n    const [toDate, setToDate] = useState('');\r\n\r\n    // Highlight (Anomalies)\r\n    const [highlighted, setHighlighted] = useState(null);\r\n\r\n    const loadLogs = useCallback(async () => {\r\n        setLoading(true);\r\n        try {\r\n            const res = await authAxios.get('/api/logs/');\r\n            setLogs(toList(res.data));\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, '감사로그 조회에 실패했습니다.'));\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [authAxios, modalApi]);\r\n\r\n    useEffect(() => { loadLogs(); }, [loadLogs]);\r\n\r\n    // Filtering Logic\r\n    const filtered = useMemo(() => {\r\n        let result = logs;\r\n        if (keyword) {\r\n            const kw = keyword.toLowerCase();\r\n            result = result.filter(l =>\r\n                (l.actor_name || '').toLowerCase().includes(kw) ||\r\n                (l.reason || '').toLowerCase().includes(kw) ||\r\n                String(l.entry).includes(kw)\r\n            );\r\n        }\r\n        if (statusFilter) {\r\n            result = result.filter(l => l.to_status === statusFilter || l.from_status === statusFilter);\r\n        }\r\n        if (actorFilter) {\r\n            result = result.filter(l => (l.actor_name || '').toLowerCase().includes(actorFilter.toLowerCase()));\r\n        }\r\n        if (entryFilter) {\r\n            result = result.filter(l => String(l.entry) === entryFilter.trim());\r\n        }\r\n        if (fromDate) result = result.filter(l => new Date(l.created_at) >= new Date(fromDate));\r\n        if (toDate) {\r\n            const d = new Date(toDate); d.setDate(d.getDate() + 1);\r\n            result = result.filter(l => new Date(l.created_at) < d);\r\n        }\r\n        return result;\r\n    }, [logs, keyword, statusFilter, actorFilter, entryFilter, fromDate, toDate]);\r\n\r\n    const anomalies = useMemo(() => detectAnomalies(logs), [logs]);\r\n\r\n    const resetFilters = () => {\r\n        setKeyword(''); setStatusFilter(''); setActorFilter('');\r\n        setEntryFilter(''); setFromDate(''); setToDate('');\r\n        setHighlighted(null);\r\n    };\r\n\r\n    const exportLogs = async () => {\r\n        if (filtered.length === 0) {\r\n            await modalApi.alert('내보낼 로그가 없습니다. 검색 조건을 확인해주세요.');\r\n            return;\r\n        }\r\n        try {\r\n            const rows = filtered.map(l => ({\r\n                일시: formatDatetime(l.created_at),\r\n                Entry_ID: l.entry,\r\n                이전_상태: STATUS_KO[l.from_status] || l.from_status || '-',\r\n                변경_상태: STATUS_KO[l.to_status] || l.to_status || '-',\r\n                처리자: l.actor_name || l.actor || '-',\r\n                사유: l.reason || '-',\r\n            }));\r\n            const wb = XLSX.utils.book_new();\r\n            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), '감사로그');\r\n            XLSX.writeFile(wb, `audit_logs_${new Date().toISOString().slice(0, 10)}.xlsx`);\r\n            await modalApi.alert('Excel 파일이 저장되었습니다.');\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, '내보내기에 실패했습니다.'));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <MenuShell\r\n            menuId={menuId}\r\n            user={user}\r\n            actions={[\r\n                { label: '새로고침', onClick: loadLogs, disabled: loading },\r\n                { label: 'Excel 내보내기', onClick: exportLogs, disabled: filtered.length === 0 },\r\n            ]}\r\n            stats={[\r\n                { label: '전체 로그', value: `${logs.length}건` },\r\n                { label: '검색 결과', value: `${filtered.length}건` },\r\n                { label: '이상징후', value: `${anomalies.length}건` },\r\n                { label: '조회 기간', value: fromDate && toDate ? `${fromDate} ~ ${toDate}` : '전체' },\r\n            ]}\r\n        >\r\n            <AnomalyPanel anomalies={anomalies} highlighted={highlighted} setHighlighted={setHighlighted} />\r\n\r\n            <LogFilter\r\n                keyword={keyword} setKeyword={setKeyword}\r\n                statusFilter={statusFilter} setStatusFilter={setStatusFilter}\r\n                actorFilter={actorFilter} setActorFilter={setActorFilter}\r\n                entryFilter={entryFilter} setEntryFilter={setEntryFilter}\r\n                fromDate={fromDate} setFromDate={setFromDate}\r\n                toDate={toDate} setToDate={setToDate}\r\n                resetFilters={resetFilters}\r\n            />\r\n\r\n            {/* Optional: Summary Badges can be re-added here if needed, or integrated into LogTable/Filter */}\r\n\r\n            <LogTable logs={filtered} loading={loading} highlighted={highlighted} />\r\n        </MenuShell>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\AuditLog\\utils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\ClosingStatusPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\Dashboard\\DashboardGuide.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\Dashboard\\DashboardVersionList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\Dashboard\\index.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'orgs' is defined but never used.","line":10,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":59,"suggestions":[{"messageId":"removeVar","data":{"varName":"orgs"},"fix":{"range":[420,426],"text":""},"desc":"Remove unused variable 'orgs'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'notices' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":13,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"notices"},"fix":{"range":[518,525],"text":""},"desc":"Remove unused variable 'notices'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'loadingNotices' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"loadingNotices"},"fix":{"range":[567,581],"text":""},"desc":"Remove unused variable 'loadingNotices'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { RefreshCcw } from 'lucide-react';\r\nimport { MenuShell } from '../../shared/menuUi';\r\nimport { toList } from '../../shared/utils';\r\nimport DashboardGuide from './DashboardGuide';\r\nimport DashboardVersionList from './DashboardVersionList';\r\n\r\nexport default function DashboardPage({\r\n    menuId, authAxios, version, versions, setVersion, orgs, entries, user,\r\n    onRefreshEntries, onBootstrap, modalApi, onNavigate\r\n}) {\r\n    const [notices, setNotices] = useState([]);\r\n    const [loadingNotices, setLoadingNotices] = useState(false);\r\n    const [lastUpdated, setLastUpdated] = useState(new Date());\r\n\r\n    const canManage = user?.role === 'ADMIN';\r\n\r\n    const loadNotices = useCallback(async () => {\r\n        if (!authAxios) return;\r\n        setLoadingNotices(true);\r\n        try {\r\n            const res = await authAxios.get('/api/notifications/');\r\n            setNotices(toList(res.data).filter(item => Number(item.user) === Number(user?.id)).slice(0, 2));\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            setLoadingNotices(false);\r\n        }\r\n    }, [authAxios, user?.id]);\r\n\r\n    useEffect(() => { loadNotices(); }, [loadNotices]);\r\n\r\n    const statusCounts = useMemo(() => {\r\n        const map = { DRAFT: 0, PENDING: 0, REVIEWING: 0, FINALIZED: 0 };\r\n        entries.forEach(entry => { if (map[entry.status] != null) map[entry.status] += 1; });\r\n        return map;\r\n    }, [entries]);\r\n\r\n    return (\r\n        <MenuShell\r\n            menuId={menuId}\r\n            user={user}\r\n            actions={[{ label: '현황 새로고침', onClick: () => { onRefreshEntries(); setLastUpdated(new Date()); }, icon: <RefreshCcw size={16} /> }]}\r\n            stats={[\r\n                { label: '선택된 버전', value: version ? `${version.year} ${version.name}` : '미선택' },\r\n                { label: '제출대기', value: `${statusCounts.PENDING}` },\r\n                { label: '검토중', value: `${statusCounts.REVIEWING}` },\r\n                { label: '최종확정', value: `${statusCounts.FINALIZED}` },\r\n            ]}\r\n        >\r\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>\r\n                <DashboardGuide statusCounts={statusCounts} user={user} onNavigate={onNavigate} />\r\n\r\n                <DashboardVersionList\r\n                    versions={versions}\r\n                    canManage={canManage}\r\n                    setVersion={setVersion}\r\n                    onNavigate={onNavigate}\r\n                    authAxios={authAxios}\r\n                    onBootstrap={onBootstrap}\r\n                    modalApi={modalApi}\r\n                    lastUpdated={lastUpdated}\r\n                />\r\n            </div>\r\n        </MenuShell>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\ApprovalFilters.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\ApprovalTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\CommentThread.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":5,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":5,"endColumn":34},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":12,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":12,"endColumn":25},{"ruleId":"no-unused-vars","severity":2,"message":"'currentUserId' is defined but never used.","line":41,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"currentUserId"},"fix":{"range":[1498,1513],"text":""},"desc":"Remove unused variable 'currentUserId'."}]},{"ruleId":"no-undef","severity":2,"message":"'availableTypes' is not defined.","line":105,"column":14,"nodeType":"Identifier","messageId":"undef","endLine":105,"endColumn":28}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { MessageSquare, Reply, Send, Trash2, X } from 'lucide-react';\r\n\r\n// ─── 의견 유형 ───────────────────────────────────────────────────\r\nexport const COMMENT_TYPE_OPTIONS = [\r\n  { value: 'DONE',     label: '작성완료' },\r\n  { value: 'REQUEST',  label: '수정요청' },\r\n  { value: 'QUESTION', label: '질문' },\r\n  { value: 'ANSWER',   label: '답변' },\r\n];\r\n\r\nexport const TYPE_COLORS = {\r\n  DONE:     { bg: '#dcfce7', border: '#86efac', text: '#166534' },\r\n  REQUEST:  { bg: '#fee2e2', border: '#fca5a5', text: '#b91c1c' },\r\n  QUESTION: { bg: '#fef9c3', border: '#fde047', text: '#854d0e' },\r\n  ANSWER:   { bg: '#f3e8ff', border: '#d8b4fe', text: '#6b21a8' },\r\n};\r\n\r\nfunction TypeBadge({ type }) {\r\n  const opt = COMMENT_TYPE_OPTIONS.find(o => o.value === type);\r\n  const color = TYPE_COLORS[type] || { bg: '#f1f5f9', border: '#cbd5e1', text: '#475569' };\r\n  return (\r\n    <span style={{\r\n      fontSize: 10, fontWeight: 700, padding: '2px 7px',\r\n      borderRadius: 999, background: color.bg, border: `1px solid ${color.border}`,\r\n      color: color.text, whiteSpace: 'nowrap',\r\n    }}>\r\n      {opt?.label || type}\r\n    </span>\r\n  );\r\n}\r\n\r\nfunction formatDt(value) {\r\n  if (!value) return '';\r\n  const d = new Date(value);\r\n  if (Number.isNaN(d.getTime())) return String(value);\r\n  return d.toLocaleString('ko-KR', { hour12: false });\r\n}\r\n\r\n// ─── 단일 댓글 ────────────────────────────────────────────────────\r\nfunction CommentItem({ comment, currentUserId, onReply, onDelete }) {\r\n  const canEdit = comment.can_edit;\r\n  const [showReplyBox, setShowReplyBox] = useState(false);\r\n  const [replyBody, setReplyBody] = useState('');\r\n  const [replyType, setReplyType] = useState('ANSWER');\r\n  const [replying, setReplying] = useState(false);\r\n\r\n  const handleReplySubmit = async () => {\r\n    if (!replyBody.trim()) return;\r\n    setReplying(true);\r\n    await onReply(comment.id, replyBody.trim(), replyType);\r\n    setReplyBody('');\r\n    setShowReplyBox(false);\r\n    setReplying(false);\r\n  };\r\n\r\n  return (\r\n    <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\r\n      {/* 본문 */}\r\n      <div style={{\r\n        background: '#f8fafc', border: '1px solid #e2e8f0', borderRadius: 8,\r\n        padding: '8px 12px',\r\n      }}>\r\n        <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 4, flexWrap: 'wrap' }}>\r\n          <TypeBadge type={comment.comment_type} />\r\n          <span style={{ fontSize: 12, fontWeight: 700, color: '#0f172a' }}>\r\n            {comment.author_display || comment.author_name}\r\n          </span>\r\n          <span style={{ fontSize: 11, color: '#94a3b8' }}>{formatDt(comment.created_at)}</span>\r\n          {comment.updated_at !== comment.created_at && (\r\n            <span style={{ fontSize: 10, color: '#cbd5e1' }}>(수정됨)</span>\r\n          )}\r\n        </div>\r\n        <p style={{ margin: 0, fontSize: 13, color: '#334155', lineHeight: 1.6, whiteSpace: 'pre-wrap' }}>\r\n          {comment.body}\r\n        </p>\r\n        <div style={{ display: 'flex', gap: 6, marginTop: 6, alignItems: 'center' }}>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => setShowReplyBox(v => !v)}\r\n            style={{ fontSize: 11, color: '#3b82f6', background: 'none', border: 'none', cursor: 'pointer', padding: 0, display: 'flex', alignItems: 'center', gap: 3 }}\r\n          >\r\n            <Reply size={12} /> 답글\r\n          </button>\r\n          {canEdit && (\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => onDelete(comment.id)}\r\n              style={{ fontSize: 11, color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer', padding: 0, display: 'flex', alignItems: 'center', gap: 3, marginLeft: 4 }}\r\n            >\r\n              <Trash2 size={12} /> 삭제\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* 답글 입력 */}\r\n      {showReplyBox && (\r\n        <div style={{ marginLeft: 20, display: 'flex', flexDirection: 'column', gap: 4 }}>\r\n          <select\r\n            value={replyType}\r\n            onChange={e => setReplyType(e.target.value)}\r\n            style={{ fontSize: 11, border: '1px solid #e2e8f0', borderRadius: 6, padding: '3px 6px', width: 120 }}\r\n          >\r\n            {availableTypes.map(o => (\r\n              <option key={o.value} value={o.value}>{o.label}</option>\r\n            ))}\r\n          </select>\r\n          <div style={{ display: 'flex', gap: 6 }}>\r\n            <textarea\r\n              value={replyBody}\r\n              onChange={e => setReplyBody(e.target.value)}\r\n              placeholder=\"답글을 입력하세요...\"\r\n              rows={2}\r\n              style={{ flex: 1, fontSize: 12, border: '1px solid #e2e8f0', borderRadius: 6, padding: '6px 8px', resize: 'vertical' }}\r\n            />\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleReplySubmit}\r\n              disabled={replying || !replyBody.trim()}\r\n              style={{\r\n                background: replying || !replyBody.trim() ? '#e2e8f0' : '#3b82f6',\r\n                color: replying || !replyBody.trim() ? '#94a3b8' : '#fff',\r\n                border: 'none', borderRadius: 6, padding: '0 10px', cursor: replying || !replyBody.trim() ? 'default' : 'pointer',\r\n                display: 'flex', alignItems: 'center', gap: 4, fontSize: 12,\r\n              }}\r\n            >\r\n              <Send size={12} /> 등록\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* 중첩 답글 */}\r\n      {Array.isArray(comment.replies) && comment.replies.length > 0 && (\r\n        <div style={{ marginLeft: 20, display: 'flex', flexDirection: 'column', gap: 6 }}>\r\n          {comment.replies.map(reply => (\r\n            <div\r\n              key={reply.id}\r\n              style={{ background: '#ffffff', border: '1px solid #e2e8f0', borderRadius: 8, padding: '7px 11px', borderLeft: '3px solid #bfdbfe' }}\r\n            >\r\n              <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 3, flexWrap: 'wrap' }}>\r\n                <TypeBadge type={reply.comment_type} />\r\n                <span style={{ fontSize: 11, fontWeight: 700, color: '#0f172a' }}>\r\n                  {reply.author_display || reply.author_name}\r\n                </span>\r\n                <span style={{ fontSize: 10, color: '#94a3b8' }}>{formatDt(reply.created_at)}</span>\r\n              </div>\r\n              <p style={{ margin: 0, fontSize: 12, color: '#334155', lineHeight: 1.6, whiteSpace: 'pre-wrap' }}>\r\n                {reply.body}\r\n              </p>\r\n              {reply.can_edit && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => onDelete(reply.id)}\r\n                  style={{ fontSize: 11, color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer', padding: 0, marginTop: 4, display: 'flex', alignItems: 'center', gap: 3 }}\r\n                >\r\n                  <Trash2 size={11} /> 삭제\r\n                </button>\r\n              )}\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// ─── 메인 패널 ────────────────────────────────────────────────────\r\n/**\r\n * CommentThread\r\n *\r\n * Props:\r\n *   authAxios     - axios instance\r\n *   versionId     - 현재 예산 회차 ID\r\n *   entryId       - 목(BudgetEntry) ID      | null 시 subject 단위\r\n *   subjectId     - 장·관·항(BudgetSubject) ID | null 시 entry 단위\r\n *   orgId         - 부서 ID (subject 단위 의견 시 필요)\r\n *   title         - 패널 제목 (optional)\r\n *   onClose       - 닫기 콜백\r\n *   onCountChange - (count) => void  뱃지 숫자 업데이트용\r\n *   onCommentAdded - (commentType) => void  새 의견 등록 시 콜백\r\n *   user          - 현재 사용자 (역할 기반 type 필터용)\r\n */\r\nexport default function CommentThread({\r\n  authAxios,\r\n  versionId,\r\n  entryId = null,\r\n  subjectId = null,\r\n  orgId = null,\r\n  title = '의견',\r\n  onClose,\r\n  onCountChange,\r\n  onCommentAdded,\r\n  user,\r\n}) {\r\n  // 역할별 사용 가능한 의견 유형\r\n  const isManager = user?.role === 'MANAGER' || user?.role === 'REVIEWER' || user?.role === 'ADMIN';\r\n  const availableTypes = COMMENT_TYPE_OPTIONS.filter(o =>\r\n    o.value !== 'REQUEST' || isManager\r\n  );\r\n\r\n  const [comments, setComments] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [posting, setPosting] = useState(false);\r\n  const [newBody, setNewBody] = useState('');\r\n  const [newType, setNewType] = useState(isManager ? 'REQUEST' : 'DONE');\r\n  const [currentUserId, setCurrentUserId] = useState(null);\r\n  const bottomRef = useRef(null);\r\n\r\n  const buildParams = useCallback(() => {\r\n    const p = { version: versionId, top_level: 1 };\r\n    if (entryId) p.entry = entryId;\r\n    else if (subjectId) { p.subject = subjectId; if (orgId) p.org = orgId; }\r\n    else if (orgId) p.org = orgId;\r\n    return p;\r\n  }, [versionId, entryId, subjectId, orgId]);\r\n\r\n  const fetchComments = useCallback(async () => {\r\n    if (!versionId) return;\r\n    setLoading(true);\r\n    try {\r\n      const res = await authAxios.get('/api/comments/', { params: buildParams() });\r\n      const data = res.data?.results ?? res.data ?? [];\r\n      setComments(data);\r\n      onCountChange?.(data.length);\r\n    } catch {\r\n      // silent\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [authAxios, buildParams, versionId, onCountChange]);\r\n\r\n  useEffect(() => {\r\n    fetchComments();\r\n  }, [fetchComments]);\r\n\r\n  useEffect(() => {\r\n    // 현재 사용자 ID 파악 (author_id 비교용)\r\n    authAxios.get('/api/auth/me/').then(res => {\r\n      setCurrentUserId(res.data?.id);\r\n    }).catch(() => {});\r\n  }, [authAxios]);\r\n\r\n  const postComment = async () => {\r\n    if (!newBody.trim() || !versionId) return;\r\n    setPosting(true);\r\n    try {\r\n      const payload = { version: versionId, comment_type: newType, body: newBody.trim() };\r\n      if (entryId) payload.entry = entryId;\r\n      else if (subjectId) { payload.subject = subjectId; if (orgId) payload.org = orgId; }\r\n      else if (orgId) payload.org = orgId;\r\n      await authAxios.post('/api/comments/', payload);\r\n      setNewBody('');\r\n      await fetchComments();\r\n      onCommentAdded?.(newType);\r\n      setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);\r\n    } catch {\r\n      // silent\r\n    } finally {\r\n      setPosting(false);\r\n    }\r\n  };\r\n\r\n  const postReply = async (parentId, body, commentType) => {\r\n    const payload = { version: versionId, comment_type: commentType, body, parent: parentId };\r\n    if (entryId) payload.entry = entryId;\r\n    else if (subjectId) { payload.subject = subjectId; if (orgId) payload.org = orgId; }\r\n    else if (orgId) payload.org = orgId;\r\n    await authAxios.post('/api/comments/', payload);\r\n    await fetchComments();\r\n  };\r\n\r\n  const deleteComment = async (id) => {\r\n    try {\r\n      await authAxios.delete(`/api/comments/${id}/`);\r\n      await fetchComments();\r\n    } catch {\r\n      // silent\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div style={{\r\n      display: 'flex', flexDirection: 'column', height: '100%',\r\n      background: '#ffffff', borderLeft: '1px solid #e2e8f0',\r\n    }}>\r\n      {/* 헤더 */}\r\n      <div style={{\r\n        display: 'flex', alignItems: 'center', justifyContent: 'space-between',\r\n        padding: '10px 14px', borderBottom: '1px solid #e2e8f0',\r\n        background: '#f8fafc',\r\n      }}>\r\n        <div style={{ display: 'flex', alignItems: 'center', gap: 7 }}>\r\n          <MessageSquare size={15} color=\"#3b82f6\" />\r\n          <span style={{ fontSize: 14, fontWeight: 700, color: '#0f172a' }}>{title}</span>\r\n          <span style={{\r\n            fontSize: 11, fontWeight: 700, background: '#dbeafe', color: '#1e40af',\r\n            borderRadius: 999, padding: '1px 7px',\r\n          }}>\r\n            {comments.length}\r\n          </span>\r\n        </div>\r\n        {onClose && (\r\n          <button type=\"button\" onClick={onClose} style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#64748b', padding: 4 }}>\r\n            <X size={15} />\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* 댓글 목록 */}\r\n      <div style={{ flex: 1, overflowY: 'auto', padding: '12px 14px', display: 'flex', flexDirection: 'column', gap: 10 }}>\r\n        {loading && (\r\n          <div style={{ textAlign: 'center', color: '#94a3b8', fontSize: 13, padding: 16 }}>불러오는 중...</div>\r\n        )}\r\n        {!loading && comments.length === 0 && (\r\n          <div style={{ textAlign: 'center', color: '#94a3b8', fontSize: 13, padding: 24 }}>\r\n            등록된 의견이 없습니다.\r\n          </div>\r\n        )}\r\n        {comments.map(c => (\r\n          <CommentItem\r\n            key={c.id}\r\n            comment={c}\r\n            currentUserId={currentUserId}\r\n            onReply={postReply}\r\n            onDelete={deleteComment}\r\n          />\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n\r\n      {/* 새 댓글 입력 */}\r\n      <div style={{ padding: '10px 14px', borderTop: '1px solid #e2e8f0', background: '#f8fafc', display: 'flex', flexDirection: 'column', gap: 6 }}>\r\n        <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>\r\n          <select\r\n            value={newType}\r\n            onChange={e => setNewType(e.target.value)}\r\n            style={{ fontSize: 11, border: '1px solid #e2e8f0', borderRadius: 6, padding: '4px 7px', width: 120 }}\r\n          >\r\n            {availableTypes.map(o => (\r\n              <option key={o.value} value={o.value}>{o.label}</option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n        <div style={{ display: 'flex', gap: 6 }}>\r\n          <textarea\r\n            value={newBody}\r\n            onChange={e => setNewBody(e.target.value)}\r\n            onKeyDown={e => {\r\n              if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) postComment();\r\n            }}\r\n            placeholder=\"의견을 입력하세요… (Ctrl+Enter로 등록)\"\r\n            rows={3}\r\n            style={{ flex: 1, fontSize: 12, border: '1px solid #e2e8f0', borderRadius: 7, padding: '7px 9px', resize: 'vertical' }}\r\n          />\r\n          <button\r\n            type=\"button\"\r\n            onClick={postComment}\r\n            disabled={posting || !newBody.trim()}\r\n            style={{\r\n              background: posting || !newBody.trim() ? '#e2e8f0' : '#3b82f6',\r\n              color: posting || !newBody.trim() ? '#94a3b8' : '#ffffff',\r\n              border: 'none', borderRadius: 7, padding: '0 12px',\r\n              cursor: posting || !newBody.trim() ? 'default' : 'pointer',\r\n              display: 'flex', alignItems: 'center', gap: 5, fontSize: 13, fontWeight: 600,\r\n            }}\r\n          >\r\n            <Send size={13} /> 등록\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\EntryDetailEditor.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\RecentWorkflowLogTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\WorkflowPanel.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isReviewer' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":87,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"isReviewer"},"fix":{"range":[3154,3170],"text":""},"desc":"Remove unused variable 'isReviewer'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState } from 'react';\nimport { X } from 'lucide-react';\nimport { menuStyles } from '../../shared/menuUi';\nimport { apiErrorMessage, num } from '../../shared/utils';\nimport { STATUS_LABELS, isRejectLog } from './helpers';\n\nconst { menuPanelCard, menuPanelHead, menuPanelBody } = menuStyles;\n\nconst actionBtn = (color, bg, border, disabled) => ({\n  border: `1px solid ${disabled ? '#e2e8f0' : border}`,\n  borderRadius: 8,\n  padding: '7px 14px',\n  fontSize: 12,\n  fontWeight: 700,\n  cursor: disabled ? 'not-allowed' : 'pointer',\n  background: disabled ? '#f8fafc' : bg,\n  color: disabled ? '#cbd5e1' : color,\n  whiteSpace: 'nowrap',\n});\n\nfunction ReasonModal({\n  title,\n  value,\n  required = true,\n  confirmLabel,\n  onChange,\n  onConfirm,\n  onCancel,\n}) {\n  const [error, setError] = useState('');\n\n  const submit = () => {\n    if (required && !String(value || '').trim()) {\n      setError('사유를 입력해주세요.');\n      return;\n    }\n    setError('');\n    onConfirm();\n  };\n\n  return (\n    <div style={{ position: 'fixed', inset: 0, zIndex: 19000, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'rgba(15,23,42,0.45)' }}>\n      <div style={{ width: 420, maxWidth: 'calc(100vw - 32px)', background: '#fff', borderRadius: 14, boxShadow: '0 20px 40px -12px rgba(15,23,42,0.45)', padding: 24, display: 'flex', flexDirection: 'column', gap: 14 }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n          <strong style={{ fontSize: 14, color: '#0f172a' }}>{title}</strong>\n          <button type=\"button\" onClick={onCancel} style={{ width: 24, height: 24, border: 'none', background: 'none', color: '#64748b', cursor: 'pointer' }}>\n            <X size={15} />\n          </button>\n        </div>\n        <div>\n          <label style={{ display: 'block', marginBottom: 6, fontSize: 11, color: '#64748b', fontWeight: 700 }}>\n            사유 {required ? <span style={{ color: '#dc2626' }}>*</span> : null}\n          </label>\n          <textarea\n            value={value}\n            onChange={(event) => {\n              onChange(event.target.value);\n              if (error) setError('');\n            }}\n            rows={4}\n            placeholder=\"사유를 입력하세요.\"\n            style={{ width: '100%', boxSizing: 'border-box', border: `1px solid ${error ? '#fca5a5' : '#e2e8f0'}`, borderRadius: 8, padding: '8px 10px', fontSize: 12, resize: 'vertical', outline: 'none', fontFamily: 'inherit' }}\n          />\n          {error ? <div style={{ marginTop: 4, fontSize: 11, color: '#b91c1c' }}>{error}</div> : null}\n        </div>\n        <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 8 }}>\n          <button type=\"button\" style={actionBtn('#64748b', '#f8fafc', '#e2e8f0')} onClick={onCancel}>취소</button>\n          <button type=\"button\" style={actionBtn('#ffffff', '#1d4ed8', '#1d4ed8')} onClick={submit}>{confirmLabel}</button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function WorkflowPanel({\n  pageState,\n  pageActions,\n  version,\n  selectedDeptId,\n  selectedTeamId,\n  authAxios,\n  modal,\n  onRefreshEntries,\n}) {\n  const {\n    isAdmin,\n    isReviewer,\n    isManager,\n    isRequestor,\n    isVersionEditable,\n    busyWorkflow,\n    deptStatus,\n    scopeEntries,\n    entryLogsById,\n    subjectById,\n    workflowReasons,\n  } = pageState;\n  const [reasonModalAction, setReasonModalAction] = useState(null);\n\n  const progressCounts = useMemo(() => {\n    const pending = scopeEntries.filter(entry => (entry.status || 'DRAFT') === 'PENDING').length;\n    const forwarded = scopeEntries.filter(entry => ['REVIEWING', 'FINALIZED'].includes(entry.status || 'DRAFT')).length;\n    const rejected = scopeEntries.filter((entry) => {\n      const logs = entryLogsById[Number(entry.id)] || [];\n      return logs.some(log => isRejectLog(log));\n    }).length;\n    return { pending, forwarded, rejected };\n  }, [scopeEntries, entryLogsById]);\n\n  // 매니저 확인 메뉴: STAFF(팀원)가 제출, MANAGER가 검토·제출(총무팀으로)\n  const canSubmitDept = isVersionEditable && deptStatus === 'DRAFT' && (isAdmin || isRequestor);\n  const canApproveDept = isVersionEditable && deptStatus === 'PENDING' && (isAdmin || isManager);\n  const canRejectDept = isVersionEditable && deptStatus === 'PENDING' && (isAdmin || isManager);\n  const canReopenDept = isVersionEditable && deptStatus !== 'DRAFT' && isAdmin;\n\n  const nextApproveLabel = '총무팀으로 제출';\n\n  const reasonFieldByAction = {\n    approve: 'deptApprove',\n    reject: 'deptReject',\n    reopen: 'deptReopen',\n  };\n\n  const runDeptWorkflow = async (action, reason = '') => {\n    if (!version || !selectedDeptId) {\n      await modal.alert('예산 회차와 부서를 선택해주세요.');\n      return;\n    }\n    if (!scopeEntries.length) {\n      await modal.alert('처리할 예산 항목이 없습니다.');\n      return;\n    }\n\n    const fromStatusMap = {\n      submit: 'DRAFT',\n      approve: deptStatus,\n      reject: deptStatus,\n      reopen: 'FINALIZED',\n    };\n    const toStatusMap = {\n      submit: 'PENDING',\n      approve: deptStatus === 'REVIEWING' ? 'FINALIZED' : 'REVIEWING',\n      reject: 'DRAFT',\n      reopen: 'DRAFT',\n    };\n\n    const fromStatus = fromStatusMap[action];\n    const toStatus = toStatusMap[action];\n    const eligible = scopeEntries.filter(entry => (entry.status || 'DRAFT') === fromStatus);\n    if (!eligible.length) {\n      await modal.alert(`'${STATUS_LABELS[fromStatus] || fromStatus}' 상태 항목이 없습니다.`);\n      return;\n    }\n\n    if (action === 'submit') {\n      let income = 0;\n      let expense = 0;\n      scopeEntries.forEach((entry) => {\n        const amount = Number(entry.total_amount || 0);\n        const subjectType = entry.subject_type || subjectById[Number(entry.subject)]?.subject_type;\n        if (subjectType === 'income') income += amount;\n        else expense += amount;\n      });\n      if (income !== expense) {\n        await modal.alert(\n          `수입/지출 합계가 일치하지 않아 제출할 수 없습니다.\\n수입: ${num(income)} / 지출: ${num(expense)} / 차액: ${num(income - expense)}`\n        );\n        return;\n      }\n    }\n\n    const actionLabel = {\n      submit: '제출',\n      approve: nextApproveLabel,\n      reject: '반려',\n      reopen: '재오픈',\n    }[action];\n\n    const ok = await modal.confirm(\n      `${eligible.length}건을 ${actionLabel} 처리하시겠습니까?\\n(${STATUS_LABELS[fromStatus] || fromStatus} → ${STATUS_LABELS[toStatus] || toStatus})`\n    );\n    if (!ok) return;\n\n    pageActions.setBusyWorkflow(true);\n    try {\n      const payload = {\n        action,\n        org_id: Number(selectedTeamId || selectedDeptId),\n        year: version.year,\n        round: version.round,\n        entry_ids: eligible.map(entry => Number(entry.id)),\n      };\n      if (reason) payload.reason = reason;\n      if (action === 'reopen') payload.to_status = 'DRAFT';\n      const res = await authAxios.post('/api/entries/workflow/', payload);\n      await onRefreshEntries?.();\n      await modal.alert(res?.data?.message || `${actionLabel} 처리가 완료되었습니다.`);\n      if (reasonFieldByAction[action]) {\n        pageActions.setWorkflowReason(reasonFieldByAction[action], '');\n      }\n    } catch (error) {\n      await modal.alert(apiErrorMessage(error, '워크플로우 처리 중 오류가 발생했습니다.'));\n    } finally {\n      pageActions.setBusyWorkflow(false);\n    }\n  };\n\n  const openReasonModal = (action) => {\n    if (action === 'approve' && !canApproveDept) return;\n    if (action === 'reject' && !canRejectDept) return;\n    if (action === 'reopen' && !canReopenDept) return;\n    setReasonModalAction(action);\n  };\n\n  const reasonFieldKey = reasonModalAction ? reasonFieldByAction[reasonModalAction] : '';\n  const reasonValue = reasonFieldKey ? (workflowReasons[reasonFieldKey] || '') : '';\n  const reasonModalConfig = {\n    approve: { title: '총무팀 제출 사유 입력', confirmLabel: '총무팀으로 제출', required: false },\n    reject: { title: '반려 사유 입력', confirmLabel: '반려 실행', required: true },\n    reopen: { title: '재오픈 사유 입력', confirmLabel: '재오픈 실행', required: false },\n  }[reasonModalAction];\n\n  return (\n    <>\n      {reasonModalAction && reasonModalConfig && (\n        <ReasonModal\n          title={reasonModalConfig.title}\n          value={reasonValue}\n          required={reasonModalConfig.required}\n          confirmLabel={reasonModalConfig.confirmLabel}\n          onChange={(value) => pageActions.setWorkflowReason(reasonFieldKey, value)}\n          onConfirm={async () => {\n            setReasonModalAction(null);\n            await runDeptWorkflow(reasonModalAction, reasonValue.trim());\n          }}\n          onCancel={() => setReasonModalAction(null)}\n        />\n      )}\n\n      <section style={menuPanelCard}>\n        <div style={{ ...menuPanelHead, display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 8, flexWrap: 'wrap' }}>\n          <span>부서 워크플로우</span>\n          <span style={{ fontSize: 12, color: '#64748b', fontWeight: 600 }}>\n            현재 상태: <strong style={{ color: '#0f172a' }}>{STATUS_LABELS[deptStatus] || deptStatus}</strong>\n          </span>\n        </div>\n\n        <div style={{ ...menuPanelBody, gap: 12 }}>\n          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n            <span style={{ fontSize: 11, color: '#1d4ed8', background: '#eff6ff', border: '1px solid #bfdbfe', borderRadius: 999, padding: '3px 10px', fontWeight: 700 }}>\n              매니저 검토중 {progressCounts.pending}건\n            </span>\n            <span style={{ fontSize: 11, color: '#166534', background: '#f0fdf4', border: '1px solid #bbf7d0', borderRadius: 999, padding: '3px 10px', fontWeight: 700 }}>\n              총무팀 제출 {progressCounts.forwarded}건\n            </span>\n            <span style={{ fontSize: 11, color: '#b91c1c', background: '#fef2f2', border: '1px solid #fecaca', borderRadius: 999, padding: '3px 10px', fontWeight: 700 }}>\n              반려 {progressCounts.rejected}건\n            </span>\n            <span style={{ fontSize: 11, color: '#475569', background: '#f1f5f9', border: '1px solid #e2e8f0', borderRadius: 999, padding: '3px 10px', fontWeight: 600 }}>\n              전체 {scopeEntries.length}건\n            </span>\n          </div>\n\n          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', alignItems: 'center' }}>\n            <button\n              type=\"button\"\n              style={actionBtn('#1d4ed8', '#eff6ff', '#bfdbfe', !canSubmitDept || busyWorkflow)}\n              disabled={!canSubmitDept || busyWorkflow}\n              onClick={() => runDeptWorkflow('submit')}\n            >\n              제출\n            </button>\n            <button\n              type=\"button\"\n              style={actionBtn('#15803d', '#f0fdf4', '#bbf7d0', !canApproveDept || busyWorkflow)}\n              disabled={!canApproveDept || busyWorkflow}\n              onClick={() => openReasonModal('approve')}\n            >\n              {nextApproveLabel}\n            </button>\n            <button\n              type=\"button\"\n              style={actionBtn('#b91c1c', '#fef2f2', '#fecaca', !canRejectDept || busyWorkflow)}\n              disabled={!canRejectDept || busyWorkflow}\n              onClick={() => openReasonModal('reject')}\n            >\n              반려\n            </button>\n            <button\n              type=\"button\"\n              style={actionBtn('#92400e', '#fffbeb', '#fcd34d', !canReopenDept || busyWorkflow)}\n              disabled={!canReopenDept || busyWorkflow}\n              onClick={() => openReasonModal('reopen')}\n            >\n              재오픈\n            </button>\n            {busyWorkflow ? <span style={{ fontSize: 12, color: '#64748b' }}>처리 중...</span> : null}\n          </div>\n\n          {!isVersionEditable && (\n            <div style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #fde68a', background: '#fffbeb', color: '#92400e', fontSize: 12, fontWeight: 600 }}>\n              현재 회차는 잠금 상태입니다. 접수중(PENDING) 회차에서만 워크플로우 처리할 수 있습니다.\n            </div>\n          )}\n        </div>\n      </section>\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\helpers.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\DepartmentApproval\\index.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isStaff' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":41,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"isStaff"},"fix":{"range":[1568,1596],"text":""},"desc":"Remove unused variable 'isStaff'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  103 |     if (!selectableDepartments.length) return;\n  104 |     const exists = selectableDepartments.some(dept => String(dept.id) === String(selectedDeptId));\n> 105 |     if (!exists) setSelectedDeptId(String(selectableDepartments[0].id));\n      |                  ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  106 |   }, [selectableDepartments, selectedDeptId]);\n  107 |\n  108 |   const teamsOfDept = useMemo(() => {","line":105,"column":18,"nodeType":null,"endLine":105,"endColumn":35},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  121 |     if (!selectedTeamId) return;\n  122 |     const exists = selectableTeams.some(team => String(team.id) === String(selectedTeamId));\n> 123 |     if (!exists) setSelectedTeamId('');\n      |                  ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  124 |   }, [selectedTeamId, selectableTeams]);\n  125 |\n  126 |   useEffect(() => {","line":123,"column":18,"nodeType":null,"endLine":123,"endColumn":35},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  128 |     if (!(myOrg.org_type === 'team' || myOrg.parent)) return;\n  129 |     if (Number(myOrg.parent) !== Number(selectedDeptId)) return;\n> 130 |     setSelectedTeamId(String(myOrg.id));\n      |     ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  131 |   }, [isAdmin, isManager, myOrg, selectedDeptId, selectedTeamId]);\n  132 |\n  133 |   useEffect(() => {","line":130,"column":5,"nodeType":null,"endLine":130,"endColumn":22},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  134 |     hasLogBaselineRef.current = false;\n  135 |     logMarkersRef.current = {};\n> 136 |     setEntryLogsById({});\n      |     ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  137 |     setNewLogEntries({});\n  138 |     setSelectedGroupKey('');\n  139 |     setDetailEntryIds([]);","line":136,"column":5,"nodeType":null,"endLine":136,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  189 |   useEffect(() => {\n  190 |     if (!scopeEntries.length) {\n> 191 |       setSelectedEntryId(null);\n      |       ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  192 |       setDetailDraft({});\n  193 |       setIsDetailModalOpen(false);\n  194 |       return;","line":191,"column":7,"nodeType":null,"endLine":191,"endColumn":25},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  259 |       }\n  260 |     });\n> 261 |     if (Object.keys(changed).length) setNewLogEntries(prev => ({ ...prev, ...changed }));\n      |                                      ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  262 |     logMarkersRef.current = currentMarkers;\n  263 |   }, [entryLogsById]);\n  264 |","line":261,"column":38,"nodeType":null,"endLine":261,"endColumn":54},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  402 |   useEffect(() => {\n  403 |     if (!groupedSubmissions.length) {\n> 404 |       setSelectedGroupKey('');\n      |       ^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  405 |       setDetailEntryIds([]);\n  406 |       setIsDetailModalOpen(false);\n  407 |       return;","line":404,"column":7,"nodeType":null,"endLine":404,"endColumn":26},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  434 |     if (!isDetailModalOpen) return;\n  435 |     if (!selectedSubmissionGroup) {\n> 436 |       setIsDetailModalOpen(false);\n      |       ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  437 |       return;\n  438 |     }\n  439 |     if (!detailModalEntries.length) {","line":436,"column":7,"nodeType":null,"endLine":436,"endColumn":27}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport * as XLSX from 'xlsx';\r\nimport { X } from 'lucide-react';\r\nimport { MenuShell, InfoBox, EmptyState } from '../../shared/menuUi';\r\nimport { apiErrorMessage, noOpModal, num } from '../../shared/utils';\r\nimport ApprovalFilters from './ApprovalFilters';\r\nimport ApprovalTable from './ApprovalTable';\r\nimport WorkflowPanel from './WorkflowPanel';\r\nimport RecentWorkflowLogTable from './RecentWorkflowLogTable';\r\nimport { STATUS_LABELS, isRejectLog, safeFileName, toLogMarker, formatLogDateTime } from './helpers';\r\nimport TraditionalLedgerView from '../../../core/TraditionalLedgerView';\r\n\r\nimport { DEPT_APPROVAL_STRINGS as S } from './constants';\r\n\r\nconst getDeptStatus = (scopeEntries) => {\r\n  if (!scopeEntries.length) return 'DRAFT';\r\n  const uniq = [...new Set(scopeEntries.map(e => e.status || 'DRAFT'))];\r\n  return uniq.length === 1 ? uniq[0] : 'MIXED';\r\n};\r\n\r\nexport default function DepartmentApprovalPage({\r\n  menuId,\r\n  authAxios,\r\n  version,\r\n  versions = [],\r\n  setVersion,\r\n  subjects = [],\r\n  orgs = [],\r\n  entries = [],\r\n  projects = [],\r\n  user,\r\n  onRefreshEntries,\r\n  modalApi,\r\n}) {\r\n  const modal = modalApi || noOpModal;\r\n  const isAdmin = user?.role === 'ADMIN';\r\n  // 새 역할: MANAGER = 총무팀(구 REVIEWER), STAFF = 부서담당자(구 MANAGER/REQUESTOR)\r\n  const isManager = user?.role === 'MANAGER' || user?.role === 'REVIEWER'; // 하위 호환\r\n  const isReviewer = isManager; // 하위 호환 alias\r\n  const isRequestor = user?.role === 'STAFF' || user?.role === 'REQUESTOR'; // 하위 호환\r\n  const isStaff = isRequestor;\r\n  const isVersionEditable = Boolean(version && version.status === 'PENDING');\r\n\r\n  const [selectedDeptId, setSelectedDeptId] = useState('');\r\n  const [selectedTeamId, setSelectedTeamId] = useState('');\r\n  const [statusFilter, setStatusFilter] = useState('ALL');\r\n  const [searchText, setSearchText] = useState('');\r\n  const [selectedEntryId, setSelectedEntryId] = useState(null);\r\n  const [selectedGroupKey, setSelectedGroupKey] = useState('');\r\n  const [detailEntryIds, setDetailEntryIds] = useState([]);\r\n  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);\r\n  const [detailDraft, setDetailDraft] = useState({});\r\n  const [busyWorkflow, setBusyWorkflow] = useState(false);\r\n  const [busySaveAll, setBusySaveAll] = useState(false);\r\n  const [busyAddDetail, setBusyAddDetail] = useState(false);\r\n  const [busyDeleteDetailId, setBusyDeleteDetailId] = useState(null);\r\n  const [entryLogsById, setEntryLogsById] = useState({});\r\n  const [newLogEntries, setNewLogEntries] = useState({});\r\n  const [workflowReasons, setWorkflowReasons] = useState({\r\n    deptApprove: '',\r\n    deptReject: '',\r\n    deptReopen: '',\r\n    entryApprove: '',\r\n    entryReject: '',\r\n    entryReopen: '',\r\n    entryRecall: '',\r\n    detailEdit: '',\r\n  });\r\n\r\n  const hasLogBaselineRef = useRef(false);\r\n  const logMarkersRef = useRef({});\r\n\r\n  const versionOptions = useMemo(\r\n    () => [...versions].sort((a, b) => b.year - a.year || b.round - a.round),\r\n    [versions]\r\n  );\r\n  const departments = useMemo(\r\n    () => orgs.filter(org => org.org_type !== 'team' && !org.parent),\r\n    [orgs]\r\n  );\r\n  const teams = useMemo(\r\n    () => orgs.filter(org => org.org_type === 'team' || org.parent),\r\n    [orgs]\r\n  );\r\n  const myOrg = useMemo(\r\n    () => orgs.find(org => Number(org.id) === Number(user?.organization)),\r\n    [orgs, user?.organization]\r\n  );\r\n  const myDeptId = useMemo(() => {\r\n    if (!myOrg) return null;\r\n    if (myOrg.org_type === 'team' || myOrg.parent) return Number(myOrg.parent);\r\n    return Number(myOrg.id);\r\n  }, [myOrg]);\r\n\r\n  const selectableDepartments = useMemo(() => {\r\n    if (isAdmin) return departments;\r\n    if (!myDeptId) return [];\r\n    // MANAGER와 STAFF 모두 자신이 속한 부서만 볼 수 있음\r\n    return departments.filter(dept => Number(dept.id) === Number(myDeptId));\r\n  }, [departments, isAdmin, myDeptId]);\r\n\r\n  useEffect(() => {\r\n    if (!selectableDepartments.length) return;\r\n    const exists = selectableDepartments.some(dept => String(dept.id) === String(selectedDeptId));\r\n    if (!exists) setSelectedDeptId(String(selectableDepartments[0].id));\r\n  }, [selectableDepartments, selectedDeptId]);\r\n\r\n  const teamsOfDept = useMemo(() => {\r\n    if (!selectedDeptId) return [];\r\n    return teams.filter(team => Number(team.parent) === Number(selectedDeptId));\r\n  }, [teams, selectedDeptId]);\r\n\r\n  const selectableTeams = useMemo(() => {\r\n    // ADMIN/MANAGER는 부서 내 모든 팀 볼 수 있음\r\n    if (isAdmin || isManager) return teamsOfDept;\r\n    if (!myOrg) return [];\r\n    return teamsOfDept.filter(team => Number(team.id) === Number(myOrg.id));\r\n  }, [isAdmin, isManager, teamsOfDept, myOrg]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedTeamId) return;\r\n    const exists = selectableTeams.some(team => String(team.id) === String(selectedTeamId));\r\n    if (!exists) setSelectedTeamId('');\r\n  }, [selectedTeamId, selectableTeams]);\r\n\r\n  useEffect(() => {\r\n    if (isAdmin || isManager || !myOrg || selectedTeamId) return;\r\n    if (!(myOrg.org_type === 'team' || myOrg.parent)) return;\r\n    if (Number(myOrg.parent) !== Number(selectedDeptId)) return;\r\n    setSelectedTeamId(String(myOrg.id));\r\n  }, [isAdmin, isManager, myOrg, selectedDeptId, selectedTeamId]);\r\n\r\n  useEffect(() => {\r\n    hasLogBaselineRef.current = false;\r\n    logMarkersRef.current = {};\r\n    setEntryLogsById({});\r\n    setNewLogEntries({});\r\n    setSelectedGroupKey('');\r\n    setDetailEntryIds([]);\r\n    setIsDetailModalOpen(false);\r\n    setWorkflowReasons({\r\n      deptApprove: '',\r\n      deptReject: '',\r\n      deptReopen: '',\r\n      entryApprove: '',\r\n      entryReject: '',\r\n      entryReopen: '',\r\n      entryRecall: '',\r\n      detailEdit: '',\r\n    });\r\n  }, [selectedDeptId, selectedTeamId, version?.id]);\r\n\r\n  const selectedScopeOrgIds = useMemo(() => {\r\n    if (selectedTeamId) return [Number(selectedTeamId)];\r\n    if (!selectedDeptId) return [];\r\n    const deptId = Number(selectedDeptId);\r\n    const teamIds = teams.filter(team => Number(team.parent) === deptId).map(team => Number(team.id));\r\n    return [deptId, ...teamIds];\r\n  }, [selectedDeptId, selectedTeamId, teams]);\r\n\r\n  const subjectById = useMemo(() => {\r\n    const map = {};\r\n    subjects.forEach(subject => { map[Number(subject.id)] = subject; });\r\n    return map;\r\n  }, [subjects]);\r\n\r\n  const scopeEntries = useMemo(() => entries.filter((entry) => (\r\n    Number(entry.year) === Number(version?.year)\r\n    && Number(entry.supplemental_round ?? 0) === Number(version?.round ?? 0)\r\n    && selectedScopeOrgIds.includes(Number(entry.organization))\r\n  )), [entries, version?.year, version?.round, selectedScopeOrgIds]);\r\n\r\n  const deptStatus = useMemo(() => getDeptStatus(scopeEntries), [scopeEntries]);\r\n\r\n  const filteredEntries = useMemo(() => {\r\n    const byStatus = statusFilter === 'ALL'\r\n      ? scopeEntries\r\n      : scopeEntries.filter(entry => (entry.status || 'DRAFT') === statusFilter);\r\n    if (!searchText.trim()) return byStatus;\r\n    const q = searchText.trim().toLowerCase();\r\n    return byStatus.filter(entry => (\r\n      String(entry.id).includes(q)\r\n      || String(entry.subject_name || '').toLowerCase().includes(q)\r\n      || String(entry.subject_code || '').toLowerCase().includes(q)\r\n      || String(entry.organization_name || '').toLowerCase().includes(q)\r\n    ));\r\n  }, [scopeEntries, statusFilter, searchText]);\r\n\r\n  useEffect(() => {\r\n    if (!scopeEntries.length) {\r\n      setSelectedEntryId(null);\r\n      setDetailDraft({});\r\n      setIsDetailModalOpen(false);\r\n      return;\r\n    }\r\n    const exists = scopeEntries.some(entry => Number(entry.id) === Number(selectedEntryId));\r\n    if (!exists) {\r\n      setSelectedEntryId(Number(scopeEntries[0].id));\r\n      setDetailDraft({});\r\n    }\r\n  }, [scopeEntries, selectedEntryId]);\r\n\r\n  const selectedEntry = useMemo(\r\n    () => scopeEntries.find(entry => Number(entry.id) === Number(selectedEntryId)) || null,\r\n    [scopeEntries, selectedEntryId]\r\n  );\r\n  const scopeEntryIds = useMemo(\r\n    () => scopeEntries.map(entry => Number(entry.id)).filter(id => Number.isFinite(id)),\r\n    [scopeEntries]\r\n  );\r\n\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    const loadLogs = async () => {\r\n      if (!scopeEntryIds.length) {\r\n        setEntryLogsById({});\r\n        return;\r\n      }\r\n      try {\r\n        const res = await authAxios.get('/api/logs/', {\r\n          params: {\r\n            entry_ids: scopeEntryIds.join(','),\r\n            year: version?.year,\r\n            round: version?.round,\r\n          },\r\n        });\r\n        const raw = Array.isArray(res.data) ? res.data : (res.data?.results || []);\r\n        const filtered = raw.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));\r\n        const map = {};\r\n        filtered.forEach((log) => {\r\n          const key = Number(log.entry);\r\n          if (!map[key]) map[key] = [];\r\n          map[key].push(log);\r\n        });\r\n        if (!cancelled) setEntryLogsById(map);\r\n      } catch {\r\n        if (!cancelled) setEntryLogsById({});\r\n      }\r\n    };\r\n    loadLogs();\r\n    return () => { cancelled = true; };\r\n  }, [authAxios, scopeEntryIds, version?.year, version?.round]);\r\n\r\n  useEffect(() => {\r\n    const currentMarkers = {};\r\n    Object.entries(entryLogsById).forEach(([entryId, logs]) => {\r\n      const marker = toLogMarker(logs?.[0]);\r\n      if (marker) currentMarkers[String(entryId)] = marker;\r\n    });\r\n    if (!hasLogBaselineRef.current) {\r\n      hasLogBaselineRef.current = true;\r\n      logMarkersRef.current = currentMarkers;\r\n      return;\r\n    }\r\n    const changed = {};\r\n    Object.entries(currentMarkers).forEach(([entryId, marker]) => {\r\n      if (!logMarkersRef.current[entryId] || logMarkersRef.current[entryId] !== marker) {\r\n        changed[entryId] = true;\r\n      }\r\n    });\r\n    if (Object.keys(changed).length) setNewLogEntries(prev => ({ ...prev, ...changed }));\r\n    logMarkersRef.current = currentMarkers;\r\n  }, [entryLogsById]);\r\n\r\n  const recentWorkflowLogs = useMemo(() => {\r\n    const seen = new Set();\r\n    const merged = [];\r\n    Object.values(entryLogsById).forEach((logs) => {\r\n      logs.forEach((log) => {\r\n        const key = log.id ? `id:${log.id}` : toLogMarker(log);\r\n        if (seen.has(key)) return;\r\n        seen.add(key);\r\n        merged.push(log);\r\n      });\r\n    });\r\n    merged.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));\r\n    return merged.slice(0, 12);\r\n  }, [entryLogsById]);\r\n\r\n  const submissionInfoById = useMemo(() => {\r\n    const map = {};\r\n    scopeEntries.forEach((entry) => {\r\n      const logs = (entryLogsById[Number(entry.id)] || []);\r\n      const submitLog = logs.find(log => log?.to_status === 'PENDING') || null;\r\n      const latestLog = logs[0] || null;\r\n      const detailCount = Array.isArray(entry?.details)\r\n        ? entry.details.length\r\n        : Number(entry?.detail_count || 0);\r\n\r\n      const submittedById = (\r\n        submitLog?.actor_name\r\n        || submitLog?.actor\r\n        || entry?.submitted_by\r\n        || latestLog?.actor_name\r\n        || latestLog?.actor\r\n        || entry?.latest_action_by\r\n        || '-'\r\n      );\r\n      const submittedByDisplay = (\r\n        submitLog?.actor_display\r\n        || entry?.submitted_by_display\r\n        || latestLog?.actor_display\r\n        || entry?.latest_action_by_display\r\n        || submittedById\r\n      );\r\n\r\n      map[Number(entry.id)] = {\r\n        submittedById,\r\n        submittedByDisplay,\r\n        submittedAt: submitLog?.created_at || entry?.submitted_at || null,\r\n        submittedAtLabel: formatLogDateTime(submitLog?.created_at || entry?.submitted_at),\r\n        latestActor: (\r\n          latestLog?.actor_display\r\n          || latestLog?.actor_name\r\n          || latestLog?.actor\r\n          || entry?.latest_action_by_display\r\n          || entry?.latest_action_by\r\n          || '-'\r\n        ),\r\n        latestAtLabel: formatLogDateTime(latestLog?.created_at || entry?.latest_action_at),\r\n        detailCount,\r\n        detailSummaryLabel: `산출내역 ${detailCount}건`,\r\n      };\r\n    });\r\n    return map;\r\n  }, [scopeEntries, entryLogsById]);\r\n\r\n  const groupedSubmissions = useMemo(() => {\r\n    const groups = new Map();\r\n    filteredEntries.forEach((entry) => {\r\n      const entryId = Number(entry.id);\r\n      const info = submissionInfoById[entryId] || {};\r\n      const submitterId = String(info.submittedById || entry.submitted_by || '-');\r\n      const submitterName = String(info.submittedByDisplay || entry.submitted_by_display || submitterId);\r\n      const key = submitterId !== '-' ? submitterId : `entry:${entryId}`;\r\n      if (!groups.has(key)) {\r\n        groups.set(key, {\r\n          key,\r\n          submitterId,\r\n          submitterName,\r\n          entries: [],\r\n          entryIds: [],\r\n          organizations: new Set(),\r\n          totalAmount: 0,\r\n          detailCount: 0,\r\n          submittedAt: null,\r\n          submittedAtLabel: '-',\r\n          changeLogCount: 0,\r\n          rejectLogCount: 0,\r\n          hasNewLog: false,\r\n          statusCounts: {},\r\n        });\r\n      }\r\n      const group = groups.get(key);\r\n      group.entries.push(entry);\r\n      group.entryIds.push(entryId);\r\n      group.organizations.add(entry.organization_name || String(entry.organization || '-'));\r\n      group.totalAmount += Number(entry.total_amount || 0);\r\n      group.detailCount += Number(info.detailCount || entry.detail_count || (Array.isArray(entry.details) ? entry.details.length : 0));\r\n      group.statusCounts[entry.status || 'DRAFT'] = (group.statusCounts[entry.status || 'DRAFT'] || 0) + 1;\r\n      if (newLogEntries[String(entryId)]) group.hasNewLog = true;\r\n\r\n      const logs = entryLogsById[entryId] || [];\r\n      group.changeLogCount += logs.filter(log => !isRejectLog(log)).length;\r\n      group.rejectLogCount += logs.filter(log => isRejectLog(log)).length;\r\n\r\n      const submittedAt = info.submittedAt || entry.submitted_at || null;\r\n      const submittedTs = submittedAt ? new Date(submittedAt).getTime() : 0;\r\n      const currentTs = group.submittedAt ? new Date(group.submittedAt).getTime() : 0;\r\n      if (submittedTs > currentTs) {\r\n        group.submittedAt = submittedAt;\r\n        group.submittedAtLabel = info.submittedAtLabel || formatLogDateTime(submittedAt);\r\n      }\r\n    });\r\n\r\n    return Array.from(groups.values())\r\n      .map((group) => {\r\n        const statuses = Object.keys(group.statusCounts);\r\n        const status = statuses.length === 1 ? statuses[0] : 'MIXED';\r\n        const subjectNames = group.entries.map(entry => entry.subject_name || entry.subject_code || `#${entry.subject}`);\r\n        const preview = subjectNames.slice(0, 2).join(', ');\r\n        const subjectSummaryLabel = subjectNames.length > 2 ? `${preview} +${subjectNames.length - 2}` : preview;\r\n        const organizationSummary = group.organizations.size === 1\r\n          ? Array.from(group.organizations)[0]\r\n          : `${group.organizations.size}개 부서`;\r\n        return {\r\n          ...group,\r\n          status,\r\n          entryCount: group.entries.length,\r\n          subjectSummaryLabel,\r\n          organizationSummary,\r\n        };\r\n      })\r\n      .sort((a, b) => {\r\n        const aTs = a.submittedAt ? new Date(a.submittedAt).getTime() : 0;\r\n        const bTs = b.submittedAt ? new Date(b.submittedAt).getTime() : 0;\r\n        if (bTs !== aTs) return bTs - aTs;\r\n        return String(a.submitterId).localeCompare(String(b.submitterId));\r\n      });\r\n  }, [filteredEntries, submissionInfoById, entryLogsById, newLogEntries]);\r\n\r\n  useEffect(() => {\r\n    if (!groupedSubmissions.length) {\r\n      setSelectedGroupKey('');\r\n      setDetailEntryIds([]);\r\n      setIsDetailModalOpen(false);\r\n      return;\r\n    }\r\n    if (!selectedGroupKey || !groupedSubmissions.some(group => group.key === selectedGroupKey)) {\r\n      const nextGroup = groupedSubmissions[0];\r\n      setSelectedGroupKey(nextGroup.key);\r\n      if (nextGroup.entryIds.length) {\r\n        setSelectedEntryId(Number(nextGroup.entryIds[0]));\r\n      }\r\n    }\r\n  }, [groupedSubmissions, selectedGroupKey]);\r\n\r\n  const selectedSubmissionGroup = useMemo(\r\n    () => groupedSubmissions.find(group => group.key === selectedGroupKey) || null,\r\n    [groupedSubmissions, selectedGroupKey]\r\n  );\r\n  const detailModalEntries = useMemo(() => {\r\n    if (!detailEntryIds.length) return [];\r\n    const idSet = new Set(detailEntryIds.map(id => Number(id)));\r\n    return scopeEntries.filter(entry => idSet.has(Number(entry.id)));\r\n  }, [scopeEntries, detailEntryIds]);\r\n  const detailModalPrimaryEntry = detailModalEntries[0] || null;\r\n  const detailModalTotalAmount = useMemo(\r\n    () => detailModalEntries.reduce((sum, entry) => sum + Number(entry.total_amount || 0), 0),\r\n    [detailModalEntries]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!isDetailModalOpen) return;\r\n    if (!selectedSubmissionGroup) {\r\n      setIsDetailModalOpen(false);\r\n      return;\r\n    }\r\n    if (!detailModalEntries.length) {\r\n      setIsDetailModalOpen(false);\r\n    }\r\n  }, [isDetailModalOpen, selectedSubmissionGroup, detailModalEntries.length]);\r\n\r\n  const summaryStats = useMemo(() => {\r\n    const statusCounts = { DRAFT: 0, PENDING: 0, REVIEWING: 0, FINALIZED: 0 };\r\n    let incomeAmount = 0;\r\n    let expenseAmount = 0;\r\n    scopeEntries.forEach((entry) => {\r\n      const status = entry.status || 'DRAFT';\r\n      if (statusCounts[status] != null) statusCounts[status] += 1;\r\n      const amount = Number(entry.total_amount || 0);\r\n      const subjectType = entry.subject_type || subjectById[Number(entry.subject)]?.subject_type;\r\n      if (subjectType === 'income') incomeAmount += amount;\r\n      else expenseAmount += amount;\r\n    });\r\n    return { statusCounts, totalEntries: scopeEntries.length, incomeAmount, expenseAmount, diffAmount: incomeAmount - expenseAmount };\r\n  }, [scopeEntries, subjectById]);\r\n\r\n  const urgentCount = summaryStats.statusCounts.PENDING + summaryStats.statusCounts.REVIEWING;\r\n\r\n  const handleVersionChange = (versionId) => {\r\n    if (!setVersion) return;\r\n    const next = versionOptions.find(v => String(v.id) === String(versionId));\r\n    if (next) setVersion(next);\r\n  };\r\n\r\n  const resetFilters = () => {\r\n    setStatusFilter('ALL');\r\n    setSearchText('');\r\n  };\r\n\r\n  const setWorkflowReason = useCallback((key, value) => {\r\n    setWorkflowReasons((prev) => ({ ...prev, [key]: value }));\r\n  }, []);\r\n\r\n  const clearNewLog = useCallback((entryId) => {\r\n    const key = String(entryId);\r\n    setNewLogEntries((prev) => {\r\n      if (!prev[key]) return prev;\r\n      const next = { ...prev };\r\n      delete next[key];\r\n      return next;\r\n    });\r\n  }, []);\r\n\r\n  const clearNewLogsByEntryIds = useCallback((entryIds = []) => {\r\n    setNewLogEntries((prev) => {\r\n      let changed = false;\r\n      const next = { ...prev };\r\n      entryIds.forEach((entryId) => {\r\n        const key = String(entryId);\r\n        if (next[key]) {\r\n          delete next[key];\r\n          changed = true;\r\n        }\r\n      });\r\n      return changed ? next : prev;\r\n    });\r\n  }, []);\r\n\r\n  const openEntryDetailModal = useCallback((target) => {\r\n    const entryIds = Array.isArray(target?.entryIds)\r\n      ? target.entryIds.map(id => Number(id)).filter(id => Number.isFinite(id))\r\n      : [Number(target)].filter(id => Number.isFinite(id));\r\n    if (!entryIds.length) return;\r\n    if (target?.key) setSelectedGroupKey(target.key);\r\n    setDetailEntryIds(entryIds);\r\n    setSelectedEntryId(entryIds[0]);\r\n    clearNewLogsByEntryIds(entryIds);\r\n    setIsDetailModalOpen(true);\r\n  }, [clearNewLogsByEntryIds]);\r\n\r\n  const closeEntryDetailModal = useCallback(() => {\r\n    setIsDetailModalOpen(false);\r\n  }, []);\r\n\r\n  const openEntryHistoryLog = useCallback(async (target, mode = 'change') => {\r\n    const targetEntryIds = Array.isArray(target?.entryIds)\r\n      ? target.entryIds.map(id => Number(id)).filter(id => Number.isFinite(id))\r\n      : [Number(target?.id)].filter(id => Number.isFinite(id));\r\n    const allLogs = targetEntryIds\r\n      .flatMap(entryId => entryLogsById[entryId] || [])\r\n      .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));\r\n    const logs = mode === 'reject' ? allLogs.filter(isRejectLog) : allLogs.filter(log => !isRejectLog(log));\r\n    if (!logs.length) {\r\n      await modal.alert(S.noLogsMsg);\r\n      return;\r\n    }\r\n    const lines = logs.slice(0, 20).map((log, idx) => {\r\n      const actor = log.actor_name || log.actor || 'SYSTEM';\r\n      const from = STATUS_LABELS[log.from_status] || log.from_status || '-';\r\n      const to = STATUS_LABELS[log.to_status] || log.to_status || '-';\r\n      const reason = String(log.reason || '').trim();\r\n      const base = `${idx + 1}. ${formatLogDateTime(log.created_at)} | ${actor} | ${from} -> ${to}`;\r\n      return reason ? `${base} | ${reason}` : base;\r\n    });\r\n    const heading = mode === 'reject' ? S.rejectLogs : S.changeLogs;\r\n    const moreLine = logs.length > 20 ? `\\n... ${S.all} ${logs.length} ${S.totalItems}` : '';\r\n    const title = target?.submitterId\r\n      ? `${target.submitterName || target.submitterId} (항목 ${target.entryCount || targetEntryIds.length}건)`\r\n      : (target?.subject_name || target?.subject_code || target?.id || '-');\r\n    await modal.alert(`[${title}] ${heading}\\n\\n${lines.join('\\n')}${moreLine}`);\r\n    clearNewLogsByEntryIds(targetEntryIds);\r\n  }, [entryLogsById, modal, clearNewLogsByEntryIds]);\r\n\r\n  const pageState = {\r\n    isAdmin,\r\n    isReviewer,\r\n    isManager,\r\n    isRequestor,\r\n    isVersionEditable,\r\n    busyWorkflow,\r\n    busySaveAll,\r\n    busyAddDetail,\r\n    busyDeleteDetailId,\r\n    detailDraft,\r\n    selectedEntry,\r\n    deptStatus,\r\n    scopeEntries,\r\n    entryLogsById,\r\n    newLogEntries,\r\n    recentWorkflowLogs,\r\n    summaryStats,\r\n    subjectById,\r\n    workflowReasons,\r\n    submissionInfoById,\r\n    selectedSubmissionGroup,\r\n  };\r\n\r\n  const pageActions = {\r\n    setSelectedTeamId,\r\n    setSelectedDeptId,\r\n    setStatusFilter,\r\n    setSearchText,\r\n    setSelectedEntryId,\r\n    setDetailDraft,\r\n    setBusyWorkflow,\r\n    setBusySaveAll,\r\n    setBusyAddDetail,\r\n    setBusyDeleteDetailId,\r\n    handleVersionChange,\r\n    resetFilters,\r\n    setWorkflowReason,\r\n    clearNewLog,\r\n    clearNewLogsByEntryIds,\r\n    openEntryHistoryLog,\r\n    openEntryDetailModal,\r\n    closeEntryDetailModal,\r\n  };\r\n\r\n  const handleExportWorkbook = async () => {\r\n    if (!version || !selectedDeptId || !scopeEntries.length) return;\r\n    try {\r\n      const wb = XLSX.utils.book_new();\r\n      const now = new Date();\r\n      const dept = departments.find(d => String(d.id) === String(selectedDeptId));\r\n      const deptName = dept?.name || selectedDeptId;\r\n      const summaryRows = [\r\n        { item: S.version, value: `${version.year} ${version.name || `Round ${version.round}`}` },\r\n        { item: S.department, value: deptName },\r\n        { item: S.generatedAt, value: now.toLocaleString('ko-KR') },\r\n        { item: S.totalEntries, value: summaryStats.totalEntries },\r\n        { item: S.incomeAmount, value: summaryStats.incomeAmount },\r\n        { item: S.expenseAmount, value: summaryStats.expenseAmount },\r\n        { item: S.diffAmount, value: summaryStats.diffAmount },\r\n      ];\r\n      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), 'Summary');\r\n      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(scopeEntries.map((entry, idx) => ({\r\n        no: idx + 1,\r\n        id: entry.id,\r\n        status: STATUS_LABELS[entry.status] || entry.status,\r\n        organization: entry.organization_name || entry.organization,\r\n        subject_code: entry.subject_code || '',\r\n        subject_name: entry.subject_name || entry.subject,\r\n        detail_count: entry.details?.length || 0,\r\n        amount: Number(entry.total_amount || 0),\r\n      }))), 'Entries');\r\n      XLSX.writeFile(wb, `${safeFileName(deptName)}_budget_${version.year}_r${version.round}_${now.toISOString().slice(0, 10)}.xlsx`);\r\n      await modal.alert(S.exportComplete);\r\n    } catch (e) {\r\n      await modal.alert(apiErrorMessage(e, S.exportFail));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <MenuShell\r\n      menuId={menuId}\r\n      user={user}\r\n      stats={[\r\n        { label: S.needReview, value: String(urgentCount) },\r\n        { label: S.finalized, value: String(summaryStats.statusCounts.FINALIZED) },\r\n        { label: S.incomeTotal, value: num(summaryStats.incomeAmount) },\r\n        { label: S.expenseTotal, value: num(summaryStats.expenseAmount) },\r\n      ]}\r\n      actions={[\r\n        { label: S.exportWorkbook, onClick: handleExportWorkbook, disabled: !selectedDeptId || !scopeEntries.length },\r\n      ]}\r\n    >\r\n      {!version && <InfoBox type='warning' title={S.noVersionSelected} message={S.selectVersionMsg} />}\r\n\r\n      <ApprovalFilters\r\n        version={version}\r\n        versionOptions={versionOptions}\r\n        selectableDepartments={selectableDepartments}\r\n        selectableTeams={selectableTeams}\r\n        selectedDeptId={selectedDeptId}\r\n        selectedTeamId={selectedTeamId}\r\n        statusFilter={statusFilter}\r\n        searchText={searchText}\r\n        canChangeDept={isAdmin}\r\n        onChange={pageActions}\r\n      />\r\n\r\n      {!selectedDeptId ? (\r\n        <EmptyState icon='!' title={S.selectDeptTitle} message={S.selectDeptMsg} />\r\n      ) : (\r\n        <>\r\n          <WorkflowPanel\r\n            pageState={pageState}\r\n            pageActions={pageActions}\r\n            version={version}\r\n            selectedDeptId={selectedDeptId}\r\n            selectedTeamId={selectedTeamId}\r\n            authAxios={authAxios}\r\n            modal={modal}\r\n            onRefreshEntries={onRefreshEntries}\r\n          />\r\n\r\n          <section style={{ display: 'grid', gap: 12 }}>\r\n            <ApprovalTable\r\n              groups={groupedSubmissions}\r\n              selectedGroupKey={selectedGroupKey}\r\n              onSelectGroup={setSelectedGroupKey}\r\n              onOpenLog={openEntryHistoryLog}\r\n              onOpenDetail={openEntryDetailModal}\r\n            />\r\n          </section>\r\n\r\n          {isDetailModalOpen && selectedSubmissionGroup && (\r\n            <div\r\n              style={{\r\n                position: 'fixed',\r\n                inset: 0,\r\n                zIndex: 20000,\r\n                background: 'rgba(15,23,42,0.5)',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                padding: 16,\r\n              }}\r\n              onClick={closeEntryDetailModal}\r\n            >\r\n              <div\r\n                style={{\r\n                  width: 'min(1320px, calc(100vw - 24px))',\r\n                  maxHeight: 'calc(100vh - 24px)',\r\n                  background: '#ffffff',\r\n                  borderRadius: 14,\r\n                  boxShadow: '0 20px 40px -12px rgba(15,23,42,0.5)',\r\n                  overflow: 'hidden',\r\n                  display: 'flex',\r\n                  flexDirection: 'column',\r\n                }}\r\n                onClick={event => event.stopPropagation()}\r\n              >\r\n                <div\r\n                  style={{\r\n                    padding: '12px 16px',\r\n                    borderBottom: '1px solid #e2e8f0',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'space-between',\r\n                    gap: 12,\r\n                  }}\r\n                >\r\n                  <div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>\r\n                    <strong style={{ fontSize: '14px', color: '#0f172a' }}>{S.entryReviewTitle}</strong>\r\n                    <span style={{ fontSize: 12, color: '#64748b' }}>\r\n                      제출자 {selectedSubmissionGroup.submitterName || selectedSubmissionGroup.submitterId} | 예산 항목 {selectedSubmissionGroup.entryCount}건\r\n                    </span>\r\n                  </div>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={closeEntryDetailModal}\r\n                    style={{\r\n                      width: 28,\r\n                      height: 28,\r\n                      borderRadius: 8,\r\n                      border: '1px solid #e2e8f0',\r\n                      background: '#ffffff',\r\n                      color: '#475569',\r\n                      display: 'inline-flex',\r\n                      alignItems: 'center',\r\n                      justifyContent: 'center',\r\n                      cursor: 'pointer',\r\n                      padding: 0,\r\n                    }}\r\n                    title='닫기'\r\n                  >\r\n                    <X size={14} />\r\n                  </button>\r\n                </div>\r\n\r\n                <div\r\n                  style={{\r\n                    padding: '10px 16px',\r\n                    borderBottom: '1px solid #eef2f7',\r\n                    display: 'grid',\r\n                    gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',\r\n                    gap: 8,\r\n                    background: '#f8fafc',\r\n                  }}\r\n                >\r\n                  {[\r\n                    { label: '제출자 ID', value: selectedSubmissionGroup.submitterId || '-' },\r\n                    { label: '제출자명', value: selectedSubmissionGroup.submitterName || '-' },\r\n                    { label: '제출일시', value: selectedSubmissionGroup.submittedAtLabel || '-' },\r\n                    {\r\n                      label: '검토 대상',\r\n                      value: detailModalPrimaryEntry\r\n                        ? `${detailModalPrimaryEntry.subject_name || detailModalPrimaryEntry.subject_code || `#${detailModalPrimaryEntry.subject}`}${selectedSubmissionGroup.entryCount > 1 ? ` 외 ${selectedSubmissionGroup.entryCount - 1}건` : ''}`\r\n                        : '-',\r\n                    },\r\n                    {\r\n                      label: '산출내역',\r\n                      value: `${selectedSubmissionGroup.detailCount}건 / ${num(detailModalTotalAmount)}원`,\r\n                    },\r\n                  ].map((item) => (\r\n                    <div key={item.label} style={{ border: '1px solid #e2e8f0', borderRadius: 8, background: '#ffffff', padding: '8px 10px' }}>\r\n                      <div style={{ fontSize: 11, color: '#64748b', marginBottom: 2 }}>{item.label}</div>\r\n                      <div style={{ fontSize: 12, color: '#0f172a', fontWeight: 700 }}>{item.value}</div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n\r\n                <div style={{ overflow: 'auto', flex: 1 }}>\r\n                  <TraditionalLedgerView\r\n                    authAxios={authAxios}\r\n                    entries={entries}\r\n                    subjects={subjects}\r\n                    orgs={orgs}\r\n                    projects={projects}\r\n                    onRefresh={onRefreshEntries}\r\n                    modalApi={modal}\r\n                    version={version}\r\n                    versions={versions}\r\n                    setVersion={setVersion}\r\n                    user={user}\r\n                    targetDeptId={selectedDeptId ? Number(selectedDeptId) : null}\r\n                    targetTeamId={selectedTeamId ? Number(selectedTeamId) : null}\r\n                    focusEntryIds={detailEntryIds}\r\n                    embeddedMode={true}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <RecentWorkflowLogTable logs={recentWorkflowLogs} />\r\n        </>\r\n      )}\r\n    </MenuShell>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\HQReview\\ApprovalTab.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'user' is defined but never used.","line":18,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":9,"suggestions":[{"messageId":"removeVar","data":{"varName":"user"},"fix":{"range":[525,536],"text":""},"desc":"Remove unused variable 'user'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React from 'react';\r\nimport { menuStyles, StatusBadge, EmptyState } from '../../shared/menuUi';\r\nimport { num } from '../../shared/utils';\r\nimport { HQ_REVIEW_STRINGS as S } from './constants';\r\n\r\nconst { menuPanelCard, menuPanelHead, menuPanelBody, simpleTable, simpleTh, simpleTd, simpleSelect } = menuStyles;\r\n\r\nexport default function ApprovalTab({\r\n    version,\r\n    versions,\r\n    handleVersionChange,\r\n    selectedDeptId,\r\n    setSelectedDeptId,\r\n    departments,\r\n    departmentsSummary,\r\n    filteredEntries,\r\n    user,\r\n    canManage,\r\n}) {\r\n    return (\r\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>\r\n            <section style={{ ...menuPanelCard, minHeight: 'auto' }}>\r\n                <div style={{ ...menuPanelBody, padding: '12px 14px' }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 10, flexWrap: 'wrap' }}>\r\n                        <label style={{ fontSize: 13, color: '#64748b', fontWeight: 700 }}>{S.budgetVersion}</label>\r\n                        <select\r\n                            style={{ ...simpleSelect, minWidth: 220, fontWeight: 600 }}\r\n                            aria-label={S.budgetVersion}\r\n                            value={version?.id ? String(version.id) : ''}\r\n                            onChange={(e) => handleVersionChange(e.target.value)}\r\n                        >\r\n                            {!version?.id && <option value=\"\">{S.selectVersion}</option>}\r\n                            {versions.map(v => (\r\n                                <option key={v.id} value={v.id}>\r\n                                    {v.year} / {v.name || `${v.round}차`}\r\n                                </option>\r\n                            ))}\r\n                        </select>\r\n                        <select\r\n                            style={{ ...simpleSelect, minWidth: 220 }}\r\n                            value={selectedDeptId}\r\n                            onChange={(e) => setSelectedDeptId(e.target.value)}\r\n                        >\r\n                            <option value=\"\">{S.allDepartments}</option>\r\n                            {departments.map(dept => <option key={dept.id} value={dept.id}>{dept.name}</option>)}\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n            </section>\r\n\r\n            {!canManage && (\r\n                <section style={{ ...menuPanelCard, borderLeft: '4px solid #ff9800', backgroundColor: '#fff3e0' }}>\r\n                    <div style={menuPanelHead}>{S.permissionTitle}</div>\r\n                    <div style={menuPanelBody}>\r\n                        <p>{S.adminOnlyNotice}</p>\r\n                    </div>\r\n                </section>\r\n            )}\r\n\r\n            <section style={menuPanelCard}>\r\n                <div style={menuPanelHead}>{S.deptProgress}</div>\r\n                <div style={menuPanelBody}>\r\n                    {departmentsSummary.length === 0 ? (\r\n                        <EmptyState icon=\"🏢\" title={S.noDepartments} message={S.noDeptSummary} />\r\n                    ) : (\r\n                        <table style={simpleTable}>\r\n                            <thead>\r\n                                <tr>\r\n                                    <th style={simpleTh}>{S.department}</th>\r\n                                    <th style={simpleTh}>{S.reviewing}</th>\r\n                                    <th style={simpleTh}>{S.finalized}</th>\r\n                                    <th style={simpleTh}>{S.totalEntries}</th>\r\n                                    <th style={simpleTh}>{S.amount}</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {departmentsSummary.map((dept) => (\r\n                                    <tr key={dept.id} style={selectedDeptId === String(dept.id) ? { backgroundColor: '#f0f7ff' } : {}}>\r\n                                        <td style={simpleTd}>{dept.name}</td>\r\n                                        <td style={simpleTd}>{dept.reviewing}</td>\r\n                                        <td style={simpleTd}>{dept.finalized}</td>\r\n                                        <td style={simpleTd}>{dept.total}</td>\r\n                                        <td style={simpleTd}>{num(dept.amount)}</td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n                    )}\r\n                </div>\r\n            </section>\r\n\r\n            <section style={menuPanelCard}>\r\n                <div style={menuPanelHead}>{S.reviewFinalizeItems}</div>\r\n                <div style={menuPanelBody}>\r\n                    <table style={simpleTable}>\r\n                        <thead>\r\n                            <tr>\r\n                                <th style={simpleTh}>ID</th>\r\n                                <th style={simpleTh}>{S.department}</th>\r\n                                <th style={simpleTh}>{S.subject}</th>\r\n                                <th style={simpleTh}>{S.status}</th>\r\n                                <th style={simpleTh}>{S.amount}</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {filteredEntries\r\n                                .filter(entry => entry.status === 'REVIEWING' || entry.status === 'FINALIZED')\r\n                                .slice(0, 300)\r\n                                .map((entry) => (\r\n                                    <tr key={entry.id} style={entry.status === 'FINALIZED' ? { backgroundColor: '#f1f8e9' } : {}}>\r\n                                        <td style={simpleTd}>{entry.id}</td>\r\n                                        <td style={simpleTd}>{entry.organization_name || entry.organization}</td>\r\n                                        <td style={simpleTd}>{entry.subject_name || entry.subject_code || `#${entry.subject}`}</td>\r\n                                        <td style={simpleTd}><StatusBadge status={entry.status} /></td>\r\n                                        <td style={simpleTd}>{num(entry.total_amount || 0)}</td>\r\n                                    </tr>\r\n                                ))}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\HQReview\\ReportsTab.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\HQReview\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\HQReview\\index.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'num' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"num"},"fix":{"range":[139,144],"text":""},"desc":"Remove unused variable 'num'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'onNavigate' is defined but never used.","line":29,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"onNavigate"},"fix":{"range":[808,825],"text":""},"desc":"Remove unused variable 'onNavigate'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isReviewer' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":34,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"isReviewer"},"fix":{"range":[1027,1056],"text":""},"desc":"Remove unused variable 'isReviewer'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":195,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":195,"endColumn":19},{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":275,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":275,"endColumn":23}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useMemo, useState } from 'react';\r\nimport { MenuShell, menuStyles } from '../../shared/menuUi';\r\nimport { apiErrorMessage, num } from '../../shared/utils';\r\nimport { ENTRY_STATUS_LABELS } from '../../config';\r\nimport ApprovalTab from './ApprovalTab';\r\nimport ReportsTab from './ReportsTab';\r\nimport { HQ_REVIEW_STRINGS as S } from './constants';\r\n\r\nconst { menuPanelCard, menuPanelHead, menuPanelBody, menuGhostBtn } = menuStyles;\r\n\r\nconst REPORT_TYPES = [\r\n    { id: 'summary', label: S.summary },\r\n    { id: 'details', label: S.details },\r\n    { id: 'by_dept', label: S.byDept },\r\n];\r\n\r\nexport default function HQReviewPage({\r\n    menuId,\r\n    authAxios,\r\n    version,\r\n    versions = [],\r\n    setVersion,\r\n    orgs = [],\r\n    entries = [],\r\n    user,\r\n    onRefreshEntries,\r\n    modalApi,\r\n    onNavigate,\r\n}) {\r\n    // 총무팀(MANAGER, 구 REVIEWER)도 확정 권한 보유, ADMIN은 모든 권한\r\n    const isAdmin = user?.role === 'ADMIN';\r\n    const isManager = user?.role === 'MANAGER' || user?.role === 'REVIEWER'; // 하위 호환\r\n    const isReviewer = isManager; // 하위 호환 alias\r\n    const canManage = isAdmin || isManager;\r\n    const [activeTab, setActiveTab] = useState('approval');\r\n    const [busy, setBusy] = useState(false);\r\n\r\n    const [selectedDeptId, setSelectedDeptId] = useState('');\r\n\r\n    const [selectedOrgId, setSelectedOrgId] = useState('');\r\n    const [includeStatusSheet, setIncludeStatusSheet] = useState(true);\r\n\r\n    const versionOptions = useMemo(\r\n        () => [...versions].sort((a, b) => b.year - a.year || b.round - a.round),\r\n        [versions]\r\n    );\r\n\r\n    const handleVersionChange = (versionId) => {\r\n        if (!setVersion) return;\r\n        const next = versionOptions.find(v => String(v.id) === String(versionId));\r\n        if (!next) return;\r\n        setVersion(next);\r\n    };\r\n\r\n    const departments = useMemo(\r\n        () => orgs.filter(o => o.org_type !== 'team' && !o.parent),\r\n        [orgs]\r\n    );\r\n\r\n    const approvalEntries = useMemo(() => {\r\n        if (!selectedDeptId) return entries;\r\n        const deptId = Number(selectedDeptId);\r\n        const teamIds = orgs.filter(org => Number(org.parent) === deptId).map(org => Number(org.id));\r\n        const scopeIds = [deptId, ...teamIds];\r\n        return entries.filter(entry => scopeIds.includes(Number(entry.organization)));\r\n    }, [entries, selectedDeptId, orgs]);\r\n\r\n    const approvalCounts = useMemo(() => ({\r\n        reviewing: approvalEntries.filter(entry => entry.status === 'REVIEWING').length,\r\n        finalized: approvalEntries.filter(entry => entry.status === 'FINALIZED').length,\r\n        total: approvalEntries.length,\r\n    }), [approvalEntries]);\r\n\r\n    const departmentsSummary = useMemo(() => {\r\n        const summary = {};\r\n        entries.forEach((entry) => {\r\n            const dept = departments.find(d => Number(d.id) === Number(entry.organization))\r\n                || departments.find(d => Number(d.id) === Number(orgs.find(o => Number(o.id) === Number(entry.organization))?.parent));\r\n            const key = dept?.id;\r\n            if (!key) return;\r\n            if (!summary[key]) {\r\n                summary[key] = {\r\n                    id: dept.id,\r\n                    name: dept.name,\r\n                    total: 0,\r\n                    reviewing: 0,\r\n                    finalized: 0,\r\n                    amount: 0,\r\n                };\r\n            }\r\n            summary[key].total += 1;\r\n            if (entry.status === 'REVIEWING') summary[key].reviewing += 1;\r\n            if (entry.status === 'FINALIZED') summary[key].finalized += 1;\r\n            summary[key].amount += Number(entry.total_amount || 0);\r\n        });\r\n        return Object.values(summary).sort((a, b) => a.name.localeCompare(b.name));\r\n    }, [entries, departments, orgs]);\r\n\r\n    const runWorkflow = async (action, targetDeptId = null) => {\r\n        if (!version || !canManage) return;\r\n        const targets = targetDeptId ? [Number(targetDeptId)] : departments.map(d => Number(d.id));\r\n        if (!targets.length) return;\r\n\r\n        const label = action === 'approve' ? S.approveAction : S.reopenAction;\r\n        const ok = await modalApi.confirm(S.confirmWorkflow(label, targets.length));\r\n        if (!ok) return;\r\n\r\n        const reason = action === 'reopen'\r\n            ? (window.prompt(S.reasonLabel, S.defaultReopenReason) || '')\r\n            : '';\r\n\r\n        setBusy(true);\r\n        try {\r\n            let successCount = 0;\r\n            for (const deptId of targets) {\r\n                const payload = {\r\n                    action,\r\n                    org_id: deptId,\r\n                    year: version.year,\r\n                    round: version.round,\r\n                };\r\n                if (action === 'reopen') payload.to_status = 'DRAFT';\r\n                if (reason) payload.reason = reason;\r\n                await authAxios.post('/api/entries/workflow/', payload);\r\n                successCount += 1;\r\n            }\r\n            await onRefreshEntries?.();\r\n            await modalApi.alert(S.processSuccess(successCount));\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, S.processFail));\r\n        } finally {\r\n            setBusy(false);\r\n        }\r\n    };\r\n\r\n    const handleFinalClose = async () => {\r\n        if (!version || !canManage) return;\r\n        const notFinalizedCount = entries.filter(e => e.status !== 'FINALIZED').length;\r\n        const ok = await modalApi.confirm(S.confirmFinalClose(notFinalizedCount));\r\n        if (!ok) return;\r\n\r\n        setBusy(true);\r\n        try {\r\n            await authAxios.post(`/api/versions/${version.id}/close/`);\r\n            await modalApi.alert(S.versionClosed);\r\n            window.location.reload();\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, S.finalCloseFail));\r\n        } finally {\r\n            setBusy(false);\r\n        }\r\n    };\r\n\r\n    const exportApprovalExcel = async (reportType) => {\r\n        if (!version) { await modalApi.alert(S.noVersionSelected); return; }\r\n        if (!entries.length) { await modalApi.alert(S.noDataToExport); return; }\r\n\r\n        try {\r\n            const XLSX = await import('xlsx');\r\n            const wb = XLSX.utils.book_new();\r\n            const now = new Date();\r\n            let rows = [];\r\n\r\n            if (reportType === 'summary') {\r\n                rows = departmentsSummary.map((dept, idx) => ({\r\n                    no: idx + 1,\r\n                    [S.department]: dept.name,\r\n                    [S.reviewing]: dept.reviewing,\r\n                    [S.finalized]: dept.finalized,\r\n                    [S.totalEntries]: dept.total,\r\n                    [S.amount]: dept.amount,\r\n                }));\r\n            } else if (reportType === 'by_dept') {\r\n                rows = departmentsSummary.map((dept) => ({\r\n                    [S.department]: dept.name,\r\n                    ['진행률(%)']: dept.total ? Math.round((dept.finalized / dept.total) * 100) : 0,\r\n                    [S.amount]: dept.amount,\r\n                }));\r\n            } else {\r\n                rows = entries.map((entry, idx) => ({\r\n                    no: idx + 1,\r\n                    id: entry.id,\r\n                    [S.organization]: entry.organization_name || entry.organization,\r\n                    [S.subject]: entry.subject_name || entry.subject_code || `#${entry.subject}`,\r\n                    [S.status]: entry.status,\r\n                    [S.amount]: Number(entry.total_amount || 0),\r\n                }));\r\n            }\r\n\r\n            const sheetName = REPORT_TYPES.find(r => r.id === reportType)?.label || reportType;\r\n            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), sheetName);\r\n            XLSX.writeFile(wb, `${reportType}_${version.year}_r${version.round}_${now.toISOString().slice(0, 10)}.xlsx`);\r\n            await modalApi.alert(S.downloadComplete(sheetName));\r\n        } catch (e) {\r\n            await modalApi.alert(S.exportFail);\r\n        }\r\n    };\r\n\r\n\r\n    // --- Reports Logic ---\r\n    const reportFilteredEntries = useMemo(() => {\r\n        if (!selectedOrgId) return entries;\r\n        return entries.filter(entry => Number(entry.organization) === Number(selectedOrgId));\r\n    }, [entries, selectedOrgId]);\r\n\r\n    const reportStats = useMemo(() => {\r\n        const statusCounts = { DRAFT: 0, PENDING: 0, REVIEWING: 0, FINALIZED: 0 };\r\n        let totalAmount = 0;\r\n        reportFilteredEntries.forEach((entry) => {\r\n            if (statusCounts[entry.status] != null) statusCounts[entry.status] += 1;\r\n            totalAmount += Number(entry.total_amount || 0);\r\n        });\r\n        return { statusCounts, totalAmount };\r\n    }, [reportFilteredEntries]);\r\n\r\n    const exportReportExcel = async () => {\r\n        if (!version) { await modalApi.alert(S.noVersionSelected); return; }\r\n        if (!reportFilteredEntries.length) { await modalApi.alert(S.noDataToExport); return; }\r\n\r\n        try {\r\n            const XLSX = await import('xlsx');\r\n            const wb = XLSX.utils.book_new();\r\n            const now = new Date();\r\n            const selectedOrgName = selectedOrgId\r\n                ? (orgs.find(org => Number(org.id) === Number(selectedOrgId))?.name || selectedOrgId)\r\n                : S.excelAll;\r\n\r\n            const metaRows = [\r\n                { [S.subject]: S.excelGeneratedAt, [S.amount]: now.toLocaleString() },\r\n                { [S.subject]: S.excelGeneratedBy, [S.amount]: user?.username || '-' },\r\n                { [S.subject]: S.excelBudgetVersion, [S.amount]: `${version.year} ${version.name}` },\r\n                { [S.subject]: S.excelOrganization, [S.amount]: selectedOrgName },\r\n                { [S.subject]: S.excelRows, [S.amount]: reportFilteredEntries.length },\r\n            ];\r\n            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(metaRows), S.excelMeta);\r\n\r\n            const detailRows = reportFilteredEntries.map((entry, idx) => ({\r\n                no: idx + 1,\r\n                [S.version]: entry.year,\r\n                ['추경차수']: entry.supplemental_round,\r\n                [S.organization]: entry.organization_name || entry.organization,\r\n                ['수탁사업']: entry.entrusted_project_name || '-',\r\n                ['과목코드']: entry.subject_code || '',\r\n                [S.subject]: entry.subject_name || entry.subject,\r\n                [S.status]: ENTRY_STATUS_LABELS[entry.status] || entry.status,\r\n                [S.amount]: Number(entry.total_amount || 0),\r\n                ['집행액']: Number(entry.executed_total || 0),\r\n                ['잔액']: Number(entry.remaining_amount || 0),\r\n            }));\r\n            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detailRows), S.excelDetails);\r\n\r\n            const summaryRows = Object.entries(reportStats.statusCounts).map(([status, count]) => ({\r\n                [S.status]: status,\r\n                ['표시명']: ENTRY_STATUS_LABELS[status] || status,\r\n                [S.excelRows]: count,\r\n            }));\r\n            summaryRows.push({ [S.status]: S.excelTotal, ['표시명']: S.excelTotal, [S.excelRows]: reportFilteredEntries.length });\r\n            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), S.excelSummary);\r\n\r\n            if (includeStatusSheet) {\r\n                const byOrg = {};\r\n                reportFilteredEntries.forEach((entry) => {\r\n                    const key = entry.organization_name || String(entry.organization);\r\n                    if (!byOrg[key]) byOrg[key] = { [S.organization]: key, [S.excelRows]: 0, [S.amount]: 0 };\r\n                    byOrg[key][S.excelRows] += 1;\r\n                    byOrg[key][S.amount] += Number(entry.total_amount || 0);\r\n                });\r\n                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.values(byOrg)), S.excelByOrg);\r\n            }\r\n\r\n            const fileName = `budget_report_${version.year}_r${version.round}_${now.toISOString().slice(0, 10)}.xlsx`;\r\n            XLSX.writeFile(wb, fileName);\r\n            await modalApi.alert(S.downloadComplete(S.excelReport));\r\n        } catch (error) {\r\n            await modalApi.alert(S.exportFail);\r\n        }\r\n    };\r\n\r\n\r\n    // --- Shell Actions ---\r\n    const getActions = () => {\r\n        if (activeTab === 'approval') {\r\n            return [\r\n                {\r\n                    label: S.approveSelected,\r\n                    onClick: () => selectedDeptId ? runWorkflow('approve', selectedDeptId) : modalApi.alert(S.selectDeptMsg),\r\n                    disabled: busy || !canManage || !selectedDeptId,\r\n                    style: { backgroundColor: '#4CAF50', color: 'white' }\r\n                },\r\n                {\r\n                    label: S.approveAll,\r\n                    onClick: () => runWorkflow('approve'),\r\n                    disabled: busy || !canManage || approvalCounts.total !== approvalCounts.reviewing + approvalCounts.finalized,\r\n                },\r\n                {\r\n                    label: S.reopenSelected,\r\n                    onClick: () => runWorkflow('reopen', selectedDeptId),\r\n                    disabled: busy || !canManage || !selectedDeptId,\r\n                }\r\n            ];\r\n        } else {\r\n            return [\r\n                { label: S.exportReport, onClick: exportReportExcel }\r\n            ];\r\n        }\r\n    };\r\n\r\n    const currentStats = activeTab === 'approval'\r\n        ? [\r\n            { label: S.reviewing, value: `${approvalCounts.reviewing}` },\r\n            { label: S.finalized, value: `${approvalCounts.finalized}` },\r\n            { label: S.totalEntries, value: `${approvalCounts.total}` },\r\n        ]\r\n        : [\r\n            { label: S.rows, value: `${reportFilteredEntries.length}` },\r\n            { label: S.totalAmount, value: `${Math.round(reportStats.totalAmount)}` },\r\n            { label: S.version, value: version ? `${version.year} (${version.round})` : '-' },\r\n        ];\r\n\r\n    return (\r\n        <MenuShell\r\n            menuId={menuId}\r\n            user={user}\r\n            actions={getActions()}\r\n            stats={currentStats}\r\n            tabs={[\r\n                { id: 'approval', label: S.tabApproval },\r\n                { id: 'reports', label: S.tabReports },\r\n            ]}\r\n            activeTab={activeTab}\r\n            onTabChange={setActiveTab}\r\n        >\r\n            {activeTab === 'approval' ? (\r\n                <>\r\n                    <ApprovalTab\r\n                        version={version}\r\n                        versions={versions}\r\n                        handleVersionChange={handleVersionChange}\r\n                        selectedDeptId={selectedDeptId}\r\n                        setSelectedDeptId={setSelectedDeptId}\r\n                        departments={departments}\r\n                        departmentsSummary={departmentsSummary}\r\n                        filteredEntries={approvalEntries}\r\n                        user={user}\r\n                        canManage={canManage}\r\n                    />\r\n                    {canManage && (\r\n                        <section style={{ ...menuPanelCard, borderTop: '4px solid #3b82f6', marginTop: 24 }}>\r\n                            <div style={menuPanelHead}>{S.adminControls}</div>\r\n                            <div style={menuPanelBody}>\r\n                                <div style={{ display: 'flex', gap: 16, flexWrap: 'wrap', alignItems: 'center' }}>\r\n                                    <button\r\n                                        onClick={handleFinalClose}\r\n                                        disabled={busy || !version}\r\n                                        style={{ ...menuGhostBtn, backgroundColor: '#1e293b', color: '#fff', padding: '10px 16px' }}\r\n                                    >\r\n                                        {S.finalClose}\r\n                                    </button>\r\n                                    <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>\r\n                                        {REPORT_TYPES.map((rpt) => (\r\n                                            <button\r\n                                                key={rpt.id}\r\n                                                onClick={() => exportApprovalExcel(rpt.id)}\r\n                                                style={{ ...menuGhostBtn, fontSize: 13, padding: '8px 12px' }}\r\n                                            >\r\n                                                {S.exportPrefix}{rpt.label}\r\n                                            </button>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n                    )}\r\n                </>\r\n            ) : (\r\n                <ReportsTab\r\n                    version={version}\r\n                    versions={versions}\r\n                    handleVersionChange={handleVersionChange}\r\n                    orgs={orgs}\r\n                    selectedOrgId={selectedOrgId}\r\n                    setSelectedOrgId={setSelectedOrgId}\r\n                    includeStatusSheet={includeStatusSheet}\r\n                    setIncludeStatusSheet={setIncludeStatusSheet}\r\n                    summaryStats={reportStats}\r\n                    filteredEntries={reportFilteredEntries}\r\n                />\r\n            )}\r\n        </MenuShell>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\NoticePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\ReportsPage.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":111,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":111,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState } from 'react';\nimport { ENTRY_STATUS_LABELS } from '../config';\nimport { MenuShell, menuStyles, InfoBox, EmptyState } from '../shared/menuUi';\n\nconst { menuPanelCard, menuPanelHead, menuPanelBody, simpleLabel, simpleSelect } = menuStyles;\n\nexport default function ReportsPage({ menuId, version, versions = [], setVersion, entries = [], orgs = [], user, modalApi }) {\n  const [selectedOrgId, setSelectedOrgId] = useState('');\n  const [includeStatusSheet, setIncludeStatusSheet] = useState(true);\n\n  const versionOptions = useMemo(\n    () => [...versions].sort((a, b) => b.year - a.year || b.round - a.round),\n    [versions]\n  );\n\n  const allOrgs = useMemo(() => {\n    const seen = new Set();\n    return orgs.filter((org) => {\n      if (seen.has(org.id)) return false;\n      seen.add(org.id);\n      return true;\n    });\n  }, [orgs]);\n\n  const filteredEntries = useMemo(() => {\n    if (!selectedOrgId) return entries;\n    return entries.filter(entry => Number(entry.organization) === Number(selectedOrgId));\n  }, [entries, selectedOrgId]);\n\n  const summaryStats = useMemo(() => {\n    const statusCounts = { DRAFT: 0, PENDING: 0, REVIEWING: 0, FINALIZED: 0 };\n    let totalAmount = 0;\n    filteredEntries.forEach((entry) => {\n      if (statusCounts[entry.status] != null) statusCounts[entry.status] += 1;\n      totalAmount += Number(entry.total_amount || 0);\n    });\n    return { statusCounts, totalAmount };\n  }, [filteredEntries]);\n\n  const handleVersionChange = (versionId) => {\n    if (!setVersion) return;\n    const next = versionOptions.find(v => String(v.id) === String(versionId));\n    if (!next) return;\n    setVersion(next);\n  };\n\n  const exportExcel = async () => {\n    if (!version) {\n      await modalApi.alert('No budget version is selected.');\n      return;\n    }\n    if (!filteredEntries.length) {\n      await modalApi.alert('No data to export for current filter.');\n      return;\n    }\n\n    try {\n      const XLSX = await import('xlsx');\n      const wb = XLSX.utils.book_new();\n      const now = new Date();\n      const selectedOrgName = selectedOrgId\n        ? (orgs.find(org => Number(org.id) === Number(selectedOrgId))?.name || selectedOrgId)\n        : 'All';\n\n      const metaRows = [\n        { item: 'GeneratedAt', value: now.toLocaleString() },\n        { item: 'GeneratedBy', value: user?.username || '-' },\n        { item: 'BudgetVersion', value: `${version.year} ${version.name}` },\n        { item: 'Organization', value: selectedOrgName },\n        { item: 'Rows', value: filteredEntries.length },\n      ];\n      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(metaRows), 'Meta');\n\n      const detailRows = filteredEntries.map((entry, idx) => ({\n        no: idx + 1,\n        year: entry.year,\n        round: entry.supplemental_round,\n        organization: entry.organization_name || entry.organization,\n        project: entry.entrusted_project_name || '-',\n        subject_code: entry.subject_code || '',\n        subject_name: entry.subject_name || entry.subject,\n        status: ENTRY_STATUS_LABELS[entry.status] || entry.status,\n        amount: Number(entry.total_amount || 0),\n        executed: Number(entry.executed_total || 0),\n        remaining: Number(entry.remaining_amount || 0),\n      }));\n      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detailRows), 'Details');\n\n      const summaryRows = Object.entries(summaryStats.statusCounts).map(([status, count]) => ({\n        status,\n        label: ENTRY_STATUS_LABELS[status] || status,\n        count,\n      }));\n      summaryRows.push({ status: 'TOTAL', label: 'Total', count: filteredEntries.length });\n      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), 'Summary');\n\n      if (includeStatusSheet) {\n        const byOrg = {};\n        filteredEntries.forEach((entry) => {\n          const key = entry.organization_name || String(entry.organization);\n          if (!byOrg[key]) byOrg[key] = { organization: key, count: 0, amount: 0 };\n          byOrg[key].count += 1;\n          byOrg[key].amount += Number(entry.total_amount || 0);\n        });\n        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.values(byOrg)), 'ByOrg');\n      }\n\n      const fileName = `budget_report_${version.year}_r${version.round}_${now.toISOString().slice(0, 10)}.xlsx`;\n      XLSX.writeFile(wb, fileName);\n      await modalApi.alert('Excel export completed.');\n    } catch (error) {\n      await modalApi.alert('Failed to export Excel.');\n    }\n  };\n\n  return (\n    <MenuShell\n      menuId={menuId}\n      user={user}\n      actions={[{ label: 'Excel Export', onClick: exportExcel }]}\n      stats={[\n        { label: 'Rows', value: `${filteredEntries.length}` },\n        { label: 'Total Amount', value: `${Math.round(summaryStats.totalAmount)}` },\n        { label: 'Version', value: version ? `${version.year} ${version.name}` : '-' },\n      ]}\n    >\n      {!version && (\n        <InfoBox\n          type=\"warning\"\n          title=\"No Version Selected\"\n          message=\"Select a budget version to view/export reports.\"\n        />\n      )}\n\n      {version && filteredEntries.length === 0 && (\n        <EmptyState\n          icon=\"📄\"\n          title=\"No Data\"\n          message=\"No rows match the current filters.\"\n        />\n      )}\n\n      <section style={{ ...menuPanelCard, borderTop: '4px solid #2196F3', backgroundColor: '#f3f6ff' }}>\n        <div style={menuPanelHead}>Report Filters</div>\n        <div style={menuPanelBody}>\n          <div style={{ marginBottom: 16 }}>\n            <label style={{ ...simpleLabel, display: 'block', marginBottom: 8, fontWeight: 'bold' }}>Budget Version</label>\n            <select style={simpleSelect} value={version?.id ? String(version.id) : ''} onChange={e => handleVersionChange(e.target.value)}>\n              {!version?.id && <option value=\"\">Select Version</option>}\n              {versionOptions.map(v => (\n                <option key={v.id} value={v.id}>\n                  {v.year} / {v.name || `Round ${v.round}`}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div style={{ marginBottom: 16 }}>\n            <label style={{ ...simpleLabel, display: 'block', marginBottom: 8, fontWeight: 'bold' }}>Organization</label>\n            <select style={simpleSelect} value={selectedOrgId} onChange={e => setSelectedOrgId(e.target.value)}>\n              <option value=\"\">All Organizations</option>\n              {allOrgs.map(org => <option key={org.id} value={org.id}>{org.name}</option>)}\n            </select>\n          </div>\n\n          <div style={{ display: 'flex', gap: 12, padding: 12, backgroundColor: '#fff', borderRadius: 8, border: '1px solid #cbd5e1' }}>\n            <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', fontSize: 14 }}>\n              <input type=\"checkbox\" checked={includeStatusSheet} onChange={e => setIncludeStatusSheet(e.target.checked)} />\n              <span>Include ByOrg sheet</span>\n            </label>\n          </div>\n        </div>\n      </section>\n\n      <section style={menuPanelCard}>\n        <div style={menuPanelHead}>Preview</div>\n        <div style={menuPanelBody}>\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, minmax(0, 1fr))', gap: 12 }}>\n            <MetricCard label=\"DRAFT\" value={summaryStats.statusCounts.DRAFT} bg=\"#ffebee\" color=\"#c62828\" />\n            <MetricCard label=\"PENDING\" value={summaryStats.statusCounts.PENDING} bg=\"#fff3e0\" color=\"#e65100\" />\n            <MetricCard label=\"REVIEWING\" value={summaryStats.statusCounts.REVIEWING} bg=\"#e3f2fd\" color=\"#0d47a1\" />\n            <MetricCard label=\"FINALIZED\" value={summaryStats.statusCounts.FINALIZED} bg=\"#e8f5e9\" color=\"#1b5e20\" />\n          </div>\n        </div>\n      </section>\n    </MenuShell>\n  );\n}\n\nfunction MetricCard({ label, value, bg, color }) {\n  return (\n    <div style={{ padding: 12, backgroundColor: bg, borderRadius: 8, textAlign: 'center' }}>\n      <div style={{ fontSize: 11, color, marginBottom: 4, fontWeight: 600 }}>{label}</div>\n      <div style={{ fontSize: 20, fontWeight: 800, color }}>{value}</div>\n    </div>\n  );\n}","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\UserAccess\\UserEditModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\UserAccess\\UserForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\UserAccess\\UserImportModal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\UserAccess\\UserList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\UserAccess\\index.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":191,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":191,"endColumn":29},{"ruleId":"no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":199,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":199,"endColumn":21}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useCallback, useEffect, useState, useMemo } from 'react';\r\nimport * as XLSX from 'xlsx';\r\nimport { MenuShell, menuStyles, EmptyState } from '../../shared/menuUi';\r\nimport { apiErrorMessage, toList } from '../../shared/utils';\r\nimport UserForm from './UserForm';\r\nimport UserList from './UserList';\r\nimport UserEditModal from './UserEditModal';\r\nimport UserImportModal from './UserImportModal';\r\n\r\nconst { menuPanelCard, menuPanelHead, menuPanelBody } = menuStyles;\r\n\r\nconst ROLE_LABELS = {\r\n    ADMIN: '시스템 관리자',\r\n    MANAGER: '총무팀',\r\n    STAFF: '부서담당자',\r\n    REVIEWER: '총무팀',    // 하위 호환\r\n    REQUESTOR: '부서담당자', // 하위 호환\r\n    ORG_VIEWER: '단순 조회자'\r\n};\r\n\r\nexport default function UserAccessPage({ menuId, user, authAxios, modalApi, orgs = [] }) {\r\n    const isAdmin = user?.role === 'ADMIN';\r\n\r\n    const roleDescriptions = {\r\n        ADMIN: '모든 메뉴 접근 가능. 회차 생성/관리, 사용자 및 권한 관리.',\r\n        MANAGER: '전체 부서 예산 확인 및 편집. 수정요청·버전 마감 가능.',\r\n        STAFF: '본인 부서 예산 편성·편집. 작성완료·질문·답변 등록 가능.',\r\n        ORG_VIEWER: '대시보드와 보고서 조회만 가능.'\r\n    };\r\n\r\n    const [users, setUsers] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n\r\n    // New User Form State\r\n    const [newUser, setNewUser] = useState({ username: '', password: '', name: '', email: '', role: 'REQUESTOR', organization: '' });\r\n\r\n    // Edit Modal State\r\n    const [editUser, setEditUser] = useState(null); // The user being edited (original)\r\n    const [editForm, setEditForm] = useState(null); // The form data\r\n    const [isEditModalOpen, setIsEditModalOpen] = useState(false);\r\n\r\n    // Import Modal State\r\n    const [showImportModal, setShowImportModal] = useState(false);\r\n    const [importLoading, setImportLoading] = useState(false);\r\n\r\n    const loadUsers = useCallback(async () => {\r\n        if (!isAdmin) return;\r\n        setLoading(true);\r\n        try {\r\n            const res = await authAxios.get('/api/auth/users/');\r\n            const rows = Array.isArray(res.data) ? res.data : toList(res.data);\r\n            setUsers(rows);\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, '사용자 목록 조회에 실패했습니다.'));\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [authAxios, isAdmin, modalApi]);\r\n\r\n    useEffect(() => { loadUsers(); }, [loadUsers]);\r\n\r\n    const filteredUsers = useMemo(() => {\r\n        if (!searchTerm.trim()) return users;\r\n        const lower = searchTerm.toLowerCase();\r\n        return users.filter(u =>\r\n            u.username.toLowerCase().includes(lower) ||\r\n            (u.name && u.name.toLowerCase().includes(lower))\r\n        );\r\n    }, [users, searchTerm]);\r\n\r\n    const createUser = async () => {\r\n        if (!newUser.username || !newUser.password) return modalApi.alert('아이디와 비밀번호는 필수입니다.');\r\n        try {\r\n            const payload = { ...newUser, organization: newUser.organization || null };\r\n            await authAxios.post('/api/auth/users/', payload);\r\n            setNewUser({ username: '', password: '', name: '', email: '', role: 'REQUESTOR', organization: '' });\r\n            await loadUsers();\r\n            await modalApi.alert('사용자가 생성되었습니다.');\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, '사용자 생성에 실패했습니다.'));\r\n        }\r\n    };\r\n\r\n    const openEditModal = (targetUser) => {\r\n        setEditUser(targetUser);\r\n        setEditForm({\r\n            username: targetUser.username,\r\n            name: targetUser.name || '',\r\n            email: targetUser.email || '',\r\n            role: targetUser.role || 'REQUESTOR',\r\n            organization: targetUser.organization || '',\r\n            is_active: targetUser.is_active,\r\n            password: '' // Empty by default (no change)\r\n        });\r\n        setIsEditModalOpen(true);\r\n    };\r\n\r\n    const handleUpdateUser = async () => {\r\n        if (!editForm) return;\r\n        try {\r\n            const payload = {\r\n                name: editForm.name,\r\n                email: editForm.email,\r\n                role: editForm.role,\r\n                organization: editForm.organization || null,\r\n                is_active: editForm.is_active\r\n            };\r\n            if (editForm.password && editForm.password.trim()) {\r\n                payload.reset_password = editForm.password.trim();\r\n            }\r\n\r\n            await authAxios.patch(`/api/auth/users/${editUser.id}/`, payload);\r\n            await loadUsers();\r\n            setIsEditModalOpen(false);\r\n            await modalApi.alert('사용자 정보가 수정되었습니다.');\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, '사용자 수정에 실패했습니다.'));\r\n        }\r\n    };\r\n\r\n    const removeUser = async (id) => {\r\n        const ok = await modalApi.confirm('해당 사용자를 삭제하시겠습니까?');\r\n        if (!ok) return;\r\n        try {\r\n            await authAxios.delete(`/api/auth/users/${id}/`);\r\n            await loadUsers();\r\n            await modalApi.alert('사용자가 삭제되었습니다.');\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, '사용자 삭제에 실패했습니다.'));\r\n        }\r\n    };\r\n\r\n    const downloadTemplate = () => {\r\n        const templateData = [\r\n            { username: 'user001', password: 'password123', name: '홍길동', email: 'hong@example.com', role: 'STAFF', organization: '' },\r\n            { username: 'user002', password: 'password456', name: '김영희', email: 'kim@example.com', role: 'MANAGER', organization: '' }\r\n        ];\r\n        const ws = XLSX.utils.json_to_sheet(templateData);\r\n        const wb = XLSX.utils.book_new();\r\n        XLSX.utils.book_append_sheet(wb, ws, '사용자');\r\n        XLSX.writeFile(wb, '사용자_임포트_템플릿.xlsx');\r\n    };\r\n\r\n    const handleImportFile = async (e) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n        setImportLoading(true);\r\n        try {\r\n            const buffer = await file.arrayBuffer();\r\n            const wb = XLSX.read(buffer, { type: 'array' });\r\n            const ws = wb.Sheets[wb.SheetNames[0]];\r\n            const data = XLSX.utils.sheet_to_json(ws);\r\n\r\n            if (data.length === 0) {\r\n                await modalApi.alert('임포트할 사용자가 없습니다.');\r\n                return;\r\n            }\r\n\r\n            const errors = [];\r\n            data.forEach((row, idx) => {\r\n                if (!row.username) errors.push(`${idx + 2}행: 아이디 필수`);\r\n                if (!row.password) errors.push(`${idx + 2}행: 비밀번호 필수`);\r\n                if (!row.role || !['ADMIN', 'MANAGER', 'STAFF', 'ORG_VIEWER'].includes(row.role)) errors.push(`${idx + 2}행: 유효한 역할 필수 (ADMIN/MANAGER/STAFF/ORG_VIEWER)`);\r\n            });\r\n\r\n            if (errors.length > 0) {\r\n                await modalApi.alert(`검증 오류:\\n${errors.slice(0, 5).join('\\n')}${errors.length > 5 ? `\\n외 ${errors.length - 5}건` : ''}`);\r\n                return;\r\n            }\r\n\r\n            const ok = await modalApi.confirm(`${data.length}명의 사용자를 임포트하시겠습니까?`);\r\n            if (!ok) return;\r\n\r\n            let successCount = 0;\r\n            let failCount = 0;\r\n\r\n            for (const row of data) {\r\n                try {\r\n                    const payload = {\r\n                        username: row.username,\r\n                        password: row.password,\r\n                        name: row.name || '',\r\n                        email: row.email || '',\r\n                        role: row.role || 'REQUESTOR',\r\n                        organization: row.organization || null\r\n                    };\r\n                    await authAxios.post('/api/auth/users/', payload);\r\n                    successCount += 1;\r\n                } catch (err) {\r\n                    failCount += 1;\r\n                }\r\n            }\r\n\r\n            await modalApi.alert(`임포트 완료: 성공 ${successCount}명, 실패 ${failCount}명`);\r\n            await loadUsers();\r\n            setShowImportModal(false);\r\n        } catch (err) {\r\n            await modalApi.alert('Excel 파일 읽기에 실패했습니다.');\r\n        } finally {\r\n            setImportLoading(false);\r\n            e.target.value = '';\r\n        }\r\n    };\r\n\r\n    if (!isAdmin) {\r\n        return (\r\n            <MenuShell menuId={menuId} user={user} stats={[{ label: '권한', value: 'ADMIN 필요' }]}>\r\n                <section style={menuPanelCard}>\r\n                    <div style={menuPanelHead}>접근 제한</div>\r\n                    <div style={menuPanelBody}>\r\n                        <EmptyState title=\"관리자만 접근할 수 있습니다\" description=\"사용자 관리 기능은 시스템 관리자(ADMIN) 권한이 필요합니다.\" />\r\n                    </div>\r\n                </section>\r\n                <section style={menuPanelCard}>\r\n                    <div style={menuPanelHead}>역할별 설명</div>\r\n                    <div style={menuPanelBody}>\r\n                        {Object.entries(roleDescriptions).map(([role, desc]) => (\r\n                            <div key={role} style={{ padding: '10px', backgroundColor: '#f8fafc', borderRadius: '6px', borderLeft: '3px solid #3b82f6', marginBottom: '8px' }}>\r\n                                <div style={{ fontWeight: 'bold', fontSize: '13px', color: '#1e40af', marginBottom: '4px' }}>\r\n                                    {ROLE_LABELS[role]} <span style={{ fontSize: '11px', color: '#94a3b8', fontWeight: 400 }}>({role})</span>\r\n                                </div>\r\n                                <div style={{ fontSize: '12px', color: '#475569' }}>{desc}</div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </section>\r\n            </MenuShell>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <MenuShell\r\n            menuId={menuId}\r\n            user={user}\r\n            actions={[\r\n                { label: '목록 새로고침', onClick: loadUsers, disabled: loading, icon: <div style={{ width: 14, height: 14, background: 'currentColor', borderRadius: '50%' }} /> },\r\n                { label: '일괄 임포트', onClick: () => setShowImportModal(true) },\r\n                { label: '템플릿 다운로드', onClick: downloadTemplate }\r\n            ]}\r\n            stats={[{ label: '전체 사용자', value: `${users.length}명` }]}\r\n        >\r\n            <UserForm newUser={newUser} setNewUser={setNewUser} createUser={createUser} orgs={orgs} />\r\n            <UserList\r\n                filteredUsers={filteredUsers}\r\n                searchTerm={searchTerm}\r\n                setSearchTerm={setSearchTerm}\r\n                openEditModal={openEditModal}\r\n                removeUser={removeUser}\r\n                orgs={orgs}\r\n            />\r\n            <UserEditModal\r\n                isOpen={isEditModalOpen}\r\n                onClose={() => setIsEditModalOpen(false)}\r\n                editForm={editForm}\r\n                setEditForm={setEditForm}\r\n                handleUpdateUser={handleUpdateUser}\r\n                orgs={orgs}\r\n            />\r\n            <UserImportModal\r\n                isOpen={showImportModal}\r\n                onClose={() => setShowImportModal(false)}\r\n                handleImportFile={handleImportFile}\r\n                importLoading={importLoading}\r\n                downloadTemplate={downloadTemplate}\r\n            />\r\n        </MenuShell>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\VersionIntake\\VersionDetail.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\VersionIntake\\VersionForm.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  13 |\n  14 |     useEffect(() => {\n> 15 |         setNameDraft(data.name || '');\n     |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  16 |     }, [data.name]);\n  17 |\n  18 |     useEffect(() => {","line":15,"column":9,"nodeType":null,"endLine":15,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  17 |\n  18 |     useEffect(() => {\n> 19 |         setGuidelinesDraft(data.guidelines || '');\n     |         ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  20 |     }, [data.guidelines]);\n  21 |\n  22 |     const commitField = (field, value) => {","line":19,"column":9,"nodeType":null,"endLine":19,"endColumn":27}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useState, useEffect } from 'react';\r\nimport { Paperclip, Trash2 } from 'lucide-react';\r\nimport { menuStyles } from '../../shared/menuUi';\r\nimport { VERSION_INTAKE_STRINGS as S } from './constants';\r\n\r\n// Destructure styles for easier use\r\nconst { simpleLabel, simpleInput, simpleSelect, simpleTextarea } = menuStyles;\r\n\r\nexport default function VersionForm({ data, setData, currentFileUrl, isCreate = false, fileInputId, transferSourceOptions }) {\r\n    const [nameDraft, setNameDraft] = useState(data.name || '');\r\n    const [guidelinesDraft, setGuidelinesDraft] = useState(data.guidelines || '');\r\n\r\n    useEffect(() => {\r\n        setNameDraft(data.name || '');\r\n    }, [data.name]);\r\n\r\n    useEffect(() => {\r\n        setGuidelinesDraft(data.guidelines || '');\r\n    }, [data.guidelines]);\r\n\r\n    const commitField = (field, value) => {\r\n        setData(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    return (\r\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 24, padding: '10px 0' }}>\r\n            <div style={{ display: 'grid', gridTemplateColumns: '100px 1fr', gap: 16, alignItems: 'center' }}>\r\n                <label style={{ ...simpleLabel, margin: 0 }}>{S.applyYear}</label>\r\n                <input type=\"number\" style={{ ...simpleInput, borderRadius: 10 }} value={data.year} onChange={e => { const v = parseInt(e.target.value); setData(prev => ({ ...prev, year: v })); }} />\r\n            </div>\r\n            <div style={{ display: 'grid', gridTemplateColumns: '100px 1fr', gap: 16, alignItems: 'center' }}>\r\n                <label style={{ ...simpleLabel, margin: 0 }}>{S.roundName}</label>\r\n                <input\r\n                    style={{ ...simpleInput, borderRadius: 10 }}\r\n                    placeholder={S.namePlaceholder}\r\n                    value={nameDraft}\r\n                    onChange={e => {\r\n                        const v = e.target.value;\r\n                        setNameDraft(v);\r\n                    }}\r\n                    onCompositionEnd={e => {\r\n                        commitField('name', e.currentTarget.value);\r\n                    }}\r\n                    onBlur={e => {\r\n                        commitField('name', e.target.value);\r\n                    }}\r\n                />\r\n            </div>\r\n            {isCreate && (\r\n                <div style={{ borderTop: '1px solid #f1f5f9', paddingTop: 20, display: 'grid', gap: 14 }}>\r\n                    <div style={{ display: 'grid', gridTemplateColumns: '100px 1fr', gap: 16, alignItems: 'center' }}>\r\n                        <label style={{ ...simpleLabel, margin: 0 }}>{S.createMode}</label>\r\n                        <select\r\n                            style={{ ...simpleSelect, borderRadius: 10 }}\r\n                            value={data.creation_mode || 'NEW'}\r\n                            onChange={(e) => { const v = e.target.value; setData(prev => ({ ...prev, creation_mode: v, source_version_id: v === 'TRANSFER' ? prev.source_version_id : '' })); }}\r\n                        >\r\n                            <option value=\"NEW\">{S.newCreate}</option>\r\n                            <option value=\"TRANSFER\">{S.copyRound}</option>\r\n                        </select>\r\n                    </div>\r\n                    {data.creation_mode === 'TRANSFER' && (\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '100px 1fr', gap: 16, alignItems: 'center' }}>\r\n                            <label style={{ ...simpleLabel, margin: 0 }}>{S.originalRound}</label>\r\n                            <select\r\n                                style={{ ...simpleSelect, borderRadius: 10 }}\r\n                                value={data.source_version_id || ''}\r\n                                onChange={(e) => { const v = e.target.value; setData(prev => ({ ...prev, source_version_id: v })); }}\r\n                            >\r\n                                <option value=\"\">{S.selectOriginal}</option>\r\n                                {transferSourceOptions.map(item => (\r\n                                    <option key={item.id} value={item.id}>\r\n                                        {item.year} {item.name} (r{item.round ?? 0})\r\n                                    </option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    )}\r\n                    {data.creation_mode === 'TRANSFER' && (\r\n                        <div style={{ fontSize: 12, color: '#64748b', paddingLeft: 116 }}>\r\n                            {S.copyNotice}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            )}\r\n            <div style={{ borderTop: '1px solid #f1f5f9', paddingTop: 20 }}>\r\n                <label style={{ ...simpleLabel, marginBottom: 8, display: 'block' }}>{S.periodSetting}</label>\r\n                <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>\r\n                    <input type=\"date\" style={{ ...simpleInput, borderRadius: 10, flex: 1 }} value={data.start_date} onChange={e => { const v = e.target.value; setData(prev => ({ ...prev, start_date: v })); }} />\r\n                    <span style={{ color: '#94a3b8' }}>~</span>\r\n                    <input type=\"date\" style={{ ...simpleInput, borderRadius: 10, flex: 1 }} value={data.end_date} onChange={e => { const v = e.target.value; setData(prev => ({ ...prev, end_date: v })); }} />\r\n                </div>\r\n            </div>\r\n            <div>\r\n                <label style={{ ...simpleLabel, marginBottom: 8, display: 'block' }}>{S.guidelinesLabel}</label>\r\n                <textarea\r\n                    style={{ ...simpleTextarea, height: 120, borderRadius: 12, padding: 16 }}\r\n                    value={guidelinesDraft}\r\n                    onChange={e => {\r\n                        const v = e.target.value;\r\n                        setGuidelinesDraft(v);\r\n                    }}\r\n                    onCompositionEnd={e => {\r\n                        commitField('guidelines', e.currentTarget.value);\r\n                    }}\r\n                    onBlur={e => {\r\n                        commitField('guidelines', e.target.value);\r\n                    }}\r\n                    placeholder={S.guidelinesPlaceholder}\r\n                />\r\n            </div>\r\n            <div>\r\n                <label style={{ ...simpleLabel, marginBottom: 8, display: 'block' }}>{S.fileUploadLabel}</label>\r\n                <div\r\n                    style={{ border: '2px dashed #e2e8f0', borderRadius: 12, padding: '20px', textAlign: 'center', cursor: 'pointer', transition: 'all 0.2s', position: 'relative' }}\r\n                    onClick={() => document.getElementById(fileInputId).click()}\r\n                >\r\n                    <Paperclip size={24} color=\"#94a3b8\" style={{ marginBottom: 8 }} />\r\n                    <div style={{ fontSize: 13, color: '#64748b' }}>\r\n                        {data.file ? data.file.name : (currentFileUrl ? `${S.currentFile}${currentFileUrl.split('/').pop()}` : S.uploadPlaceholder)}\r\n                    </div>\r\n                    <input\r\n                        id={fileInputId}\r\n                        type=\"file\"\r\n                        style={{ display: 'none' }}\r\n                        onChange={e => { const f = e.target.files[0]; setData(prev => ({ ...prev, file: f })); }}\r\n                    />\r\n                    {(data.file || currentFileUrl) && (\r\n                        <button\r\n                            type=\"button\"\r\n                            style={{ position: 'absolute', top: 10, right: 10, background: 'none', border: 'none', cursor: 'pointer', color: '#ef4444' }}\r\n                            onClick={(e) => { e.stopPropagation(); setData(prev => ({ ...prev, file: null })); }}\r\n                            title={S.removeFile}\r\n                        >\r\n                            <Trash2 size={16} />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\VersionIntake\\VersionList.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'version' is defined but never used.","line":15,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":56,"suggestions":[{"messageId":"removeVar","data":{"varName":"version"},"fix":{"range":[501,510],"text":""},"desc":"Remove unused variable 'version'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setViewMode' is defined but never used.","line":15,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":81,"suggestions":[{"messageId":"removeVar","data":{"varName":"setViewMode"},"fix":{"range":[522,535],"text":""},"desc":"Remove unused variable 'setViewMode'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setIsCreateModalOpen' is defined but never used.","line":15,"column":222,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":242,"suggestions":[{"messageId":"removeVar","data":{"varName":"setIsCreateModalOpen"},"fix":{"range":[674,696],"text":""},"desc":"Remove unused variable 'setIsCreateModalOpen'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useMemo, useState } from 'react';\r\nimport {\r\n    FileText, Calendar, ChevronUp, ChevronDown, ArrowUpDown,\r\n    Eye, Edit2, PauseCircle, Trash2\r\n} from 'lucide-react';\r\nimport { menuStyles, StatusBadge } from '../../shared/menuUi';\r\nimport { VERSION_INTAKE_STRINGS as S } from './constants';\r\n\r\nconst {\r\n    menuPanelCard, menuPanelHead, menuPanelBody,\r\n    simpleTable, simpleTh, simpleTd, menuGhostBtn, simpleSelect\r\n} = menuStyles;\r\n\r\nexport default function VersionList({ versions, version, setVersion, setViewMode, canManage, statusById, setStatusById, saveVersionStatus, handleGoDetail, setIsEditModalOpen, handleDeactivateVersion, handleDeleteVersion, setIsCreateModalOpen }) {\r\n    const [sortField, setSortField] = useState('year');\r\n    const [sortDir, setSortDir] = useState('desc');\r\n\r\n    const sortedVersions = useMemo(() => {\r\n        let temp = [...versions];\r\n        temp.sort((a, b) => {\r\n            let valA = a[sortField];\r\n            let valB = b[sortField];\r\n\r\n            if (sortField === 'status') {\r\n                valA = a.status || '';\r\n                valB = b.status || '';\r\n            }\r\n\r\n            if (valA < valB) return sortDir === 'asc' ? -1 : 1;\r\n            if (valA > valB) return sortDir === 'asc' ? 1 : -1;\r\n            return 0;\r\n        });\r\n        return temp;\r\n    }, [versions, sortField, sortDir]);\r\n\r\n    const handleSort = (field) => {\r\n        if (sortField === field) {\r\n            setSortDir(sortDir === 'asc' ? 'desc' : 'asc');\r\n        } else {\r\n            setSortField(field);\r\n            setSortDir('asc');\r\n        }\r\n    };\r\n\r\n    const renderSortIcon = (field) => {\r\n        if (sortField !== field) return <ArrowUpDown size={12} style={{ marginLeft: 4, opacity: 0.3 }} />;\r\n        return sortDir === 'asc' ? <ChevronUp size={12} style={{ marginLeft: 4 }} /> : <ChevronDown size={12} style={{ marginLeft: 4 }} />;\r\n    };\r\n\r\n    return (\r\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 32 }}>\r\n            <section style={{ ...menuPanelCard, borderRadius: 20, overflow: 'hidden', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }}>\r\n                <div style={{ ...menuPanelHead, background: '#1e293b', color: '#fff', padding: '20px 28px', border: 'none' }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\r\n                        <FileText size={20} />\r\n                        <span style={{ fontWeight: 800, fontSize: 17 }}>{S.masterTitle}</span>\r\n                    </div>\r\n                </div>\r\n                <div style={{ ...menuPanelBody, padding: 0 }}>\r\n                    <table style={{ ...simpleTable, border: 'none' }}>\r\n                        <thead style={{ background: '#f8fafc', borderBottom: '2px solid #e2e8f0' }}>\r\n                            <tr>\r\n                                <th style={{ ...simpleTh, padding: '16px 28px', color: '#475569', fontSize: 13, width: 60 }}>{S.no}</th>\r\n                                <th style={{ ...simpleTh, color: '#475569', fontSize: 13, cursor: 'pointer' }} onClick={() => handleSort('year')}>\r\n                                    {S.year} {renderSortIcon('year')}\r\n                                </th>\r\n                                <th style={{ ...simpleTh, color: '#475569', fontSize: 13, cursor: 'pointer' }} onClick={() => handleSort('name')}>\r\n                                    {S.roundName} {renderSortIcon('name')}\r\n                                </th>\r\n                                <th style={{ ...simpleTh, color: '#475569', fontSize: 13, cursor: 'pointer' }} onClick={() => handleSort('start_date')}>\r\n                                    {S.period} {renderSortIcon('start_date')}\r\n                                </th>\r\n                                <th style={{ ...simpleTh, textAlign: 'center', color: '#475569', fontSize: 13, cursor: 'pointer' }} onClick={() => handleSort('status')}>\r\n                                    {S.currentStatus} {renderSortIcon('status')}\r\n                                </th>\r\n                                <th style={{ ...simpleTh, color: '#475569', fontSize: 13 }}>{S.statusControl}</th>\r\n                                <th style={{ ...simpleTh, textAlign: 'center', paddingRight: 28, color: '#475569', fontSize: 13 }}>{S.management}</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {sortedVersions.map((item, idx) => {\r\n                                return (\r\n                                    <tr key={item.id} style={{\r\n                                        backgroundColor: '#fff',\r\n                                        borderBottom: '1px solid #f1f5f9',\r\n                                        transition: 'all 0.2s'\r\n                                    }}>\r\n                                        <td style={{ ...simpleTd, paddingLeft: 28, color: '#94a3b8', fontWeight: 600 }}>{idx + 1}</td>\r\n                                        <td style={{ ...simpleTd, fontWeight: 700, color: '#334155' }}>{item.year}</td>\r\n                                        <td style={{ ...simpleTd }}>\r\n                                            <div style={{ fontWeight: 800, fontSize: 15, color: '#1e293b' }}>{item.name}</div>\r\n                                        </td>\r\n                                        <td style={{ ...simpleTd }}>\r\n                                            <div style={{ display: 'flex', alignItems: 'center', gap: 6, color: '#64748b', fontSize: 13 }}>\r\n                                                <Calendar size={14} />\r\n                                                {item.start_date ? <span><b>{item.start_date}</b> ~ <b>{item.end_date}</b></span> : <span style={{ color: '#cbd5e1' }}>{S.periodUndefined}</span>}\r\n                                            </div>\r\n                                        </td>\r\n                                        <td style={{ ...simpleTd, textAlign: 'center' }}>\r\n                                            <StatusBadge status={item.status} type=\"version\" />\r\n                                        </td>\r\n                                        <td style={simpleTd}>\r\n                                            {canManage ? (\r\n                                                <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\r\n                                                    <select\r\n                                                        style={{ ...simpleSelect, padding: '6px 10px', fontSize: 13, borderRadius: 8, border: '1px solid #e2e8f0', background: '#fff' }}\r\n                                                        value={statusById[item.id] || item.status}\r\n                                                        onChange={e => setStatusById({ ...statusById, [item.id]: e.target.value })}\r\n                                                    >\r\n                                                        <option value=\"DRAFT\">{S.draft}</option>\r\n                                                        <option value=\"PENDING\">{S.pending}</option>\r\n                                                        <option value=\"CONFIRMED\">{S.confirmed}</option>\r\n                                                        <option value=\"CLOSED\">{S.closed}</option>\r\n                                                    </select>\r\n                                                    {statusById[item.id] !== item.status && (\r\n                                                        <button\r\n                                                            onClick={() => saveVersionStatus(item)}\r\n                                                            style={{ padding: '6px 12px', borderRadius: 8, fontSize: 12, fontWeight: 800, background: '#2563eb', color: '#fff', border: 'none', cursor: 'pointer', boxShadow: '0 2px 4px rgba(37,99,235,0.2)' }}\r\n                                                        >\r\n                                                            {S.save}\r\n                                                        </button>\r\n                                                    )}\r\n                                                </div>\r\n                                            ) : '-'}\r\n                                        </td>\r\n                                        <td style={{ ...simpleTd, textAlign: 'center', paddingRight: 28 }}>\r\n                                            <div style={{ display: 'flex', gap: 6, justifyContent: 'center' }}>\r\n                                                <button\r\n                                                    title={S.view}\r\n                                                    style={{ ...menuGhostBtn, padding: '8px', display: 'flex', alignItems: 'center', gap: 4, fontSize: 12 }}\r\n                                                    onClick={() => handleGoDetail(item)}\r\n                                                >\r\n                                                    <Eye size={14} /> {S.view}\r\n                                                </button>\r\n                                                {canManage && (\r\n                                                    <>\r\n                                                        <button\r\n                                                            title={S.edit}\r\n                                                            style={{ ...menuGhostBtn, padding: '8px', display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, color: '#2563eb', borderColor: '#dbeafe' }}\r\n                                                            onClick={() => { setVersion(item); setIsEditModalOpen(true); }}\r\n                                                        >\r\n                                                            <Edit2 size={14} /> {S.edit}\r\n                                                        </button>\r\n                                                        <button\r\n                                                            title={S.deactivate}\r\n                                                            style={{ ...menuGhostBtn, padding: '8px', display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, color: '#f59e0b', borderColor: '#fef3c7' }}\r\n                                                            onClick={() => handleDeactivateVersion(item)}\r\n                                                        >\r\n                                                            <PauseCircle size={14} /> {S.deactivate}\r\n                                                        </button>\r\n                                                        <button\r\n                                                            title={S.delete}\r\n                                                            style={{ ...menuGhostBtn, padding: '8px', display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, color: '#ef4444', borderColor: '#fee2e2' }}\r\n                                                            onClick={() => handleDeleteVersion(item)}\r\n                                                        >\r\n                                                            <Trash2 size={14} /> {S.delete}\r\n                                                        </button>\r\n                                                    </>\r\n                                                )}\r\n                                            </div>\r\n                                        </td>\r\n                                    </tr>\r\n                                );\r\n                            })}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\VersionIntake\\constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\pages\\VersionIntake\\index.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchProgress'. Either include it or remove the dependency array.","line":64,"column":8,"nodeType":"ArrayExpression","endLine":64,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [fetchProgress, version, viewMode]","fix":{"range":[2312,2331],"text":"[fetchProgress, version, viewMode]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useEffect, useMemo, useState } from 'react';\r\nimport { Plus } from 'lucide-react';\r\nimport { MenuShell, Modal } from '../../shared/menuUi';\r\nimport { apiErrorMessage } from '../../shared/utils';\r\nimport VersionList from './VersionList';\r\nimport VersionDetail from './VersionDetail';\r\nimport VersionForm from './VersionForm';\r\nimport { VERSION_INTAKE_STRINGS as S } from './constants';\r\n\r\nexport default function VersionIntakePage({\r\n    menuId, authAxios, version, versions, setVersion, onBootstrap, user, modalApi\r\n}) {\r\n    const getInitialCreateData = () => ({\r\n        year: new Date().getFullYear(),\r\n        name: '',\r\n        start_date: '',\r\n        end_date: '',\r\n        guidelines: '',\r\n        file: null,\r\n        creation_mode: 'NEW',\r\n        source_version_id: '',\r\n    });\r\n\r\n    const [viewMode, setViewMode] = useState('list');\r\n    const [statusById, setStatusById] = useState({});\r\n    const [, setSavingId] = useState(null);\r\n    const [progressData, setProgressData] = useState([]);\r\n    const [loadingProgress, setLoadingProgress] = useState(false);\r\n\r\n    // Modals\r\n    const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\r\n    const [isEditModalOpen, setIsEditModalOpen] = useState(false);\r\n\r\n    const [createData, setCreateData] = useState(getInitialCreateData());\r\n    const [editData, setEditData] = useState({ year: '', name: '', start_date: '', end_date: '', guidelines: '' });\r\n\r\n    // UI States\r\n    const [isBulkExpanded, setIsBulkExpanded] = useState(false);\r\n    const [csvContent, setCsvContent] = useState('');\r\n    const [, setBulkResult] = useState(null);\r\n\r\n    const canManage = user?.role === 'ADMIN';\r\n\r\n    useEffect(() => {\r\n        const next = {};\r\n        versions.forEach(item => { next[item.id] = item.status; });\r\n        setStatusById(next);\r\n    }, [versions]);\r\n\r\n    useEffect(() => {\r\n        if (version && version.id) {\r\n            if (viewMode === 'detail') {\r\n                fetchProgress(version.id);\r\n            }\r\n            setEditData({\r\n                year: version.year,\r\n                name: version.name,\r\n                start_date: version.start_date || '',\r\n                end_date: version.end_date || '',\r\n                guidelines: version.guidelines || ''\r\n            });\r\n        }\r\n    }, [version, viewMode]);\r\n\r\n    const fetchProgress = async (vId) => {\r\n        const targetId = vId || version?.id;\r\n        if (!targetId) return;\r\n        setLoadingProgress(true);\r\n        try {\r\n            const res = await authAxios.get(`/api/versions/${targetId}/progress/`);\r\n            setProgressData(res.data);\r\n        } catch (e) { console.error(e); }\r\n        finally { setLoadingProgress(false); }\r\n    };\r\n\r\n    const transferSourceOptions = useMemo(() => {\r\n        return [...versions].sort((a, b) => b.year - a.year || b.round - a.round);\r\n    }, [versions]);\r\n\r\n    const handleDeleteVersion = async (v) => {\r\n        if (!await modalApi.confirm(S.confirmDelete(v.name))) return;\r\n        try {\r\n            await authAxios.delete(`/api/versions/${v.id}/`);\r\n            await onBootstrap();\r\n            await modalApi.alert(S.deleteSuccess);\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, S.deleteFail));\r\n        }\r\n    };\r\n\r\n    const handleDeactivateVersion = async (v) => {\r\n        if (v.status === 'CLOSED') return modalApi.alert(S.alreadyClosed);\r\n        if (!await modalApi.confirm(S.confirmDeactivate(v.name))) return;\r\n        try {\r\n            await authAxios.patch(`/api/versions/${v.id}/`, { status: 'CLOSED' });\r\n            await onBootstrap();\r\n            await modalApi.alert(S.deactivateSuccess);\r\n        } catch (e) {\r\n            await modalApi.alert(apiErrorMessage(e, S.changeFail));\r\n        }\r\n    };\r\n\r\n    const handleCreateVersion = async () => {\r\n        try {\r\n            if (createData.creation_mode === 'TRANSFER' && !createData.source_version_id) {\r\n                await modalApi.alert(S.transferRequired);\r\n                return;\r\n            }\r\n\r\n            const formData = new FormData();\r\n            formData.append('year', createData.year);\r\n            formData.append('name', createData.name || S.newRoundName(createData.year));\r\n            formData.append('start_date', createData.start_date);\r\n            formData.append('end_date', createData.end_date);\r\n            formData.append('guidelines', createData.guidelines);\r\n            formData.append('creation_mode', createData.creation_mode || 'NEW');\r\n            if (createData.source_version_id) {\r\n                formData.append('source_version_id', createData.source_version_id);\r\n            }\r\n            if (createData.file) {\r\n                formData.append('guidelines_file', createData.file);\r\n            }\r\n\r\n            const res = await authAxios.post('/api/versions/create_next_round/', formData, {\r\n                headers: { 'Content-Type': 'multipart/form-data' }\r\n            });\r\n            await onBootstrap();\r\n            setIsCreateModalOpen(false);\r\n            setCreateData(getInitialCreateData());\r\n            const clonedCount = Number(res?.data?.cloned_count || 0);\r\n            await modalApi.alert(S.createSuccess(clonedCount));\r\n        } catch (e) { await modalApi.alert(apiErrorMessage(e, S.createFail)); }\r\n    };\r\n\r\n    const saveVersionStatus = async (item) => {\r\n        const nextStatus = statusById[item.id];\r\n        if (!nextStatus || nextStatus === item.status) return;\r\n        setSavingId(item.id);\r\n        try {\r\n            await authAxios.patch(`/api/versions/${item.id}/`, { status: nextStatus, confirmed_at: nextStatus === 'CONFIRMED' ? new Date().toISOString() : null });\r\n            await onBootstrap();\r\n            await modalApi.alert(S.updateSuccess);\r\n        } catch (e) { await modalApi.alert(apiErrorMessage(e, S.updateFail)); }\r\n        finally { setSavingId(null); }\r\n    };\r\n\r\n    const saveVersionDetails = async () => {\r\n        if (!version) return;\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('year', editData.year);\r\n            formData.append('name', editData.name);\r\n            formData.append('start_date', editData.start_date);\r\n            formData.append('end_date', editData.end_date);\r\n            formData.append('guidelines', editData.guidelines);\r\n            if (editData.file) {\r\n                formData.append('guidelines_file', editData.file);\r\n            } else if (editData.file === null && version.guidelines_file) { // If file was cleared\r\n                formData.append('guidelines_file', ''); // Send empty string to clear existing file\r\n            }\r\n\r\n            const res = await authAxios.patch(`/api/versions/${version.id}/`, formData, {\r\n                headers: { 'Content-Type': 'multipart/form-data' }\r\n            });\r\n            setVersion(res.data);\r\n            await onBootstrap();\r\n            setIsEditModalOpen(false);\r\n            setEditData({ year: '', name: '', start_date: '', end_date: '', guidelines: '', file: null }); // Reset form\r\n            await modalApi.alert(S.saveSuccess);\r\n        } catch (e) { await modalApi.alert(apiErrorMessage(e, S.saveFail)); }\r\n    };\r\n\r\n    const handleBulkUpload = async () => {\r\n        if (!csvContent.trim()) return modalApi.alert(S.inputRequired);\r\n        try {\r\n            const lines = csvContent.trim().split('\\n');\r\n            const entries = lines.map(line => {\r\n                const [subject_code, org_code, name, price, qty] = line.split(',').map(s => s.trim());\r\n                return { subject_code, org_code, details: [{ name, price: parseInt(price) || 0, qty: parseFloat(qty) || 0, freq: 1, source: '자체' }] };\r\n            }).filter(e => e.subject_code && e.org_code);\r\n            const res = await authAxios.post('/api/entries/bulk-upsert/', { year: version.year, round: version.round || 0, entries });\r\n            setBulkResult(res.data);\r\n            await onBootstrap();\r\n            setCsvContent('');\r\n            await modalApi.alert(S.uploadSuccess(res.data.created, res.data.updated));\r\n            fetchProgress(version.id);\r\n        } catch (e) { await modalApi.alert(apiErrorMessage(e, S.uploadFail)); }\r\n    };\r\n\r\n    const handleGoDetail = (v) => { setVersion(v); setViewMode('detail'); };\r\n\r\n    return (\r\n        <MenuShell\r\n            menuId={menuId}\r\n            user={user}\r\n            breadcrumbs={viewMode === 'detail'\r\n                ? [\r\n                    { label: S.pageTitle, onClick: () => setViewMode('list') },\r\n                    { label: S.listTitle, onClick: () => setViewMode('list') },\r\n                    `${S.detailTitle} (${version?.name || ''})`\r\n                ]\r\n                : [S.pageTitle, S.listTitle]}\r\n            contextBadge={version ? `${version.year}년 ${version.name}` : ''}\r\n            actions={viewMode === 'list' && canManage ? [{ label: S.newRoundBtn, onClick: () => setIsCreateModalOpen(true), icon: <Plus size={16} /> }] : []}\r\n        >\r\n            <div style={{ padding: '0 20px 40px 20px' }}>\r\n                {viewMode === 'list' ? (\r\n                    <VersionList\r\n                        versions={versions}\r\n                        version={version}\r\n                        setVersion={setVersion}\r\n                        setViewMode={setViewMode}\r\n                        canManage={canManage}\r\n                        statusById={statusById}\r\n                        setStatusById={setStatusById}\r\n                        saveVersionStatus={saveVersionStatus}\r\n                        handleGoDetail={handleGoDetail}\r\n                        setIsEditModalOpen={setIsEditModalOpen}\r\n                        handleDeactivateVersion={handleDeactivateVersion}\r\n                        handleDeleteVersion={handleDeleteVersion}\r\n                        setIsCreateModalOpen={setIsCreateModalOpen}\r\n                    />\r\n                ) : (\r\n                    <VersionDetail\r\n                        version={version}\r\n                        canManage={canManage}\r\n                        setViewMode={setViewMode}\r\n                        fetchProgress={fetchProgress}\r\n                        progressData={progressData}\r\n                        loadingProgress={loadingProgress}\r\n                        setIsEditModalOpen={setIsEditModalOpen}\r\n                        handleBulkUpload={handleBulkUpload}\r\n                        csvContent={csvContent}\r\n                        setCsvContent={setCsvContent}\r\n                        isBulkExpanded={isBulkExpanded}\r\n                        setIsBulkExpanded={setIsBulkExpanded}\r\n                    />\r\n                )}\r\n            </div>\r\n\r\n            <Modal isOpen={isCreateModalOpen} onClose={() => setIsCreateModalOpen(false)} title={S.newRoundBtn} width={600}>\r\n                <VersionForm data={createData} setData={setCreateData} isCreate={true} fileInputId=\"version-file-input-create\" transferSourceOptions={transferSourceOptions} />\r\n                <div style={{ paddingTop: 20, borderTop: '1px solid #f1f5f9', display: 'flex', justifyContent: 'flex-end', marginTop: 10 }}>\r\n                    <button type=\"button\" style={{ background: '#2563eb', color: '#fff', border: 'none', padding: '12px 32px', borderRadius: 12, fontWeight: 800, cursor: 'pointer', boxShadow: '0 4px 6px -1px rgba(37,99,235,0.2)' }} onClick={handleCreateVersion}>{S.newRoundBtn}</button>\r\n                </div>\r\n            </Modal>\r\n\r\n            <Modal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} title={S.editRoundBtn} width={600}>\r\n                <VersionForm data={editData} setData={setEditData} currentFileUrl={version?.guidelines_file} fileInputId=\"version-file-input-edit\" />\r\n                <div style={{ paddingTop: 20, borderTop: '1px solid #f1f5f9', display: 'flex', justifyContent: 'flex-end', marginTop: 10 }}>\r\n                    <button type=\"button\" style={{ background: '#10b981', color: '#fff', border: 'none', padding: '12px 32px', borderRadius: 12, fontWeight: 800, cursor: 'pointer', boxShadow: '0 4px 6px -1px rgba(16,185,129,0.2)' }} onClick={saveVersionDetails}>{S.save}</button>\r\n                </div>\r\n            </Modal>\r\n        </MenuShell>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\EmptyState.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\FormWizard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\GuideBox.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\InfoBox.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\LoadingSpinner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\MenuShell.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\Modal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\PresetCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\QuickActionCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\SelectableTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\SkeletonLoader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\StatusBadge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\Tabs.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\components\\TimelineView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\menuUi.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":5,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":5,"endColumn":26},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":6,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":6,"endColumn":40},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":7,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":7,"endColumn":42},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":8,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":8,"endColumn":36},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":9,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":9,"endColumn":35},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":10,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":10,"endColumn":41},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":11,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":11,"endColumn":38},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":12,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":12,"endColumn":39},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":13,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":13,"endColumn":46},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":14,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":14,"endColumn":45},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":15,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":15,"endColumn":45},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":16,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":16,"endColumn":41},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":17,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":17,"endColumn":43},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":18,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":18,"endColumn":41},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"This rule can't verify that `export *` only exports components.","line":19,"column":1,"nodeType":"ExportAllDeclaration","messageId":"exportAll","endLine":19,"endColumn":46}],"suppressedMessages":[],"errorCount":15,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\n// This file basically aggregates everything from components and styles\n// to maintain backward compatibility with existing imports.\n\nexport * from './styles';\nexport * from './components/MenuShell';\nexport * from './components/StatusBadge';\nexport * from './components/Modal';\nexport * from './components/Tabs';\nexport * from './components/EmptyState';\nexport * from './components/InfoBox';\nexport * from './components/GuideBox';\nexport * from './components/QuickActionCard';\nexport * from './components/LoadingSpinner';\nexport * from './components/SkeletonLoader';\nexport * from './components/FormWizard';\nexport * from './components/TimelineView';\nexport * from './components/PresetCard';\nexport * from './components/SelectableTable';\n","usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\styles.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Budget\\src\\pages\\menu\\shared\\utils.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":56,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":13}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const num = (v) => (Number(v) || 0).toLocaleString();\nexport const toList = (d) => (Array.isArray(d) ? d : d?.results || []);\n\nexport const apiErrorMessage = (e, fallback = '오류가 발생했습니다.') => {\n  const data = e?.response?.data;\n  if (!data) {\n    const status = e?.response?.status;\n    const msg = e?.message || '네트워크 오류';\n    return status ? `${fallback} (상태코드 ${status})` : `${fallback} (${msg})`;\n  }\n  if (typeof data === 'string') {\n    if (data.includes('<html') || data.includes('<!DOCTYPE')) {\n      const titleMatch = data.match(/<title>(.*?)<\\/title>/i);\n      const title = titleMatch?.[1]?.trim();\n      return title ? `서버 오류: ${title}` : fallback;\n    }\n    return data;\n  }\n  if (typeof data.error === 'string') {\n    if (typeof data.details === 'string' && data.details.trim()) return `${data.error}: ${data.details}`;\n    if (data.details && typeof data.details === 'object') return `${data.error}: ${JSON.stringify(data.details)}`;\n    return data.error;\n  }\n  const parts = [];\n  Object.entries(data).forEach(([k, v]) => {\n    if (Array.isArray(v)) parts.push(`${k}: ${v.join(', ')}`);\n    else if (typeof v === 'string') parts.push(`${k}: ${v}`);\n  });\n  return parts.length ? parts.join('\\n') : fallback;\n};\n\nexport const noOpModal = {\n  alert: async (msg) => window.alert(msg),\n  confirm: async (msg) => window.confirm(msg),\n};\n\n// 헬퍼 함수들\nexport const validateEmail = (email) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\n\nexport const validatePassword = (password) => password && password.length >= 6;\n\nexport const getStatusColor = (status) => {\n  const colors = {\n    DRAFT: { bg: '#f5f5f5', text: '#666' },\n    PENDING: { bg: '#ffedd5', text: '#9a3412' },\n    REVIEWING: { bg: '#dbeafe', text: '#1d4ed8' },\n    FINALIZED: { bg: '#d1fae5', text: '#065f46' },\n  };\n  return colors[status] || { bg: '#f5f5f5', text: '#666' };\n};\n\nexport const formatDatetime = (dateStr) => {\n  if (!dateStr) return '-';\n  try {\n    return new Date(dateStr).toLocaleString('ko-KR');\n  } catch (e) {\n    return dateStr;\n  }\n};\n\nexport const getTimeDiff = (fromDate) => {\n  if (!fromDate) return '';\n  const now = new Date();\n  const date = new Date(fromDate);\n  const diffMs = now - date;\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n  const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n  \n  if (diffDays > 0) return `${diffDays}일 ${diffHours}시간`;\n  if (diffHours > 0) return `${diffHours}시간`;\n  return '방금 전';\n};\n","usedDeprecatedRules":[]}]
