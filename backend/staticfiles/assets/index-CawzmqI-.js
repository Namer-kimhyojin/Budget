import{j as e,m as M,a as c,o as Q,t as oe,h as X,M as le,_ as re}from"./index-BO6clO3M.js";import{E as ie}from"./EmptyState-BTfvDnOD.js";const W={DRAFT:"ì‘ì„±ì¤‘",PENDING:"ì œì¶œ",REVIEWING:"ê²€í† ì¤‘",FINALIZED:"í™•ì •",CREATE:"ìƒì„±",UPDATE:"ìˆ˜ì •",DELETE:"ì‚­ì œ",ACTION:"í–‰ìœ„",LOGIN:"ë¡œê·¸ì¸",LOGIN_FAILED:"ë¡œê·¸ì¸ ì‹¤íŒ¨",LOGOUT:"ë¡œê·¸ì•„ì›ƒ",SIGNUP:"íšŒì›ê°€ì…",AUTH:"ì¸ì¦",API:"API"},ae={DRAFT:{color:"#9a3412",bg:"#ffedd5"},PENDING:{color:"#1d4ed8",bg:"#dbeafe"},REVIEWING:{color:"#5b21b6",bg:"#ede9fe"},FINALIZED:{color:"#065f46",bg:"#d1fae5"},CREATE:{color:"#166534",bg:"#dcfce7"},UPDATE:{color:"#1d4ed8",bg:"#dbeafe"},DELETE:{color:"#b91c1c",bg:"#fee2e2"},ACTION:{color:"#334155",bg:"#e2e8f0"},LOGIN:{color:"#0f766e",bg:"#ccfbf1"},LOGIN_FAILED:{color:"#991b1b",bg:"#fecaca"},LOGOUT:{color:"#0f766e",bg:"#ccfbf1"},SIGNUP:{color:"#7c3aed",bg:"#ede9fe"},AUTH:{color:"#475569",bg:"#e2e8f0"},API:{color:"#475569",bg:"#e2e8f0"}},q={danger:{bg:"#fef2f2",border:"#fca5a5",badge:"#dc2626",icon:"!!"},warning:{bg:"#fffbeb",border:"#fcd34d",badge:"#d97706",icon:"!"},info:{bg:"#eff6ff",border:"#93c5fd",badge:"#2563eb",icon:"i"}};function ce(r){const i=[],a=Array.isArray(r)?r:[],d=a.filter(t=>{const n=t.entry!==null&&t.entry!==void 0,l=!!(t.from_status||t.to_status);return t.log_type==="WORKFLOW"||n&&l}),g=a.filter(t=>{const n=new Date(t.created_at).getHours();return n<8||n>=18});g.length>0&&i.push({level:"warning",title:"ì—…ë¬´ì‹œê°„ ì™¸ í™œë™",desc:`${g.length}ê±´ì˜ ë¡œê·¸ê°€ ì—…ë¬´ì‹œê°„(08:00~18:00) ì™¸ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`,logs:g.map(t=>t.id).filter(Boolean)});const x={DRAFT:0,PENDING:1,REVIEWING:2,FINALIZED:3},y=d.filter(t=>(x[t.from_status]??-1)>(x[t.to_status]??-1));y.length>0&&i.push({level:"danger",title:"ìƒíƒœ ì—­í–‰ ê°ì§€",desc:`${y.length}ê±´ì˜ ë¡œê·¸ì—ì„œ ìƒíƒœê°€ ë˜ëŒì•„ê°”ìŠµë‹ˆë‹¤ (ì˜ˆ: FINALIZED -> DRAFT).`,logs:y.map(t=>t.id).filter(Boolean)});const m={};d.forEach(t=>{const n=t.entry;n&&(m[n]||(m[n]=[]),m[n].push(t))});const h=[];Object.values(m).forEach(t=>{const n=[...t].sort((l,_)=>new Date(l.created_at)-new Date(_.created_at));for(let l=1;l<n.length;l+=1)if((new Date(n[l].created_at)-new Date(n[l-1].created_at))/1e3/60<10){n[l].id&&h.push(n[l].id),n[l-1].id&&h.push(n[l-1].id);break}}),h.length>0&&i.push({level:"warning",title:"ë‹¨ì‹œê°„ ë°˜ë³µ ë³€ê²½",desc:`${new Set(h).size}ê±´ì˜ ë¡œê·¸ê°€ 10ë¶„ ì´ë‚´ ë°˜ë³µ ìƒíƒœë³€ê²½ìœ¼ë¡œ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`,logs:[...new Set(h)]});const p={};a.forEach(t=>{const n=t.actor_name||t.actor||"Unknown";p[n]=(p[n]||0)+1}),Object.entries(p).forEach(([t,n])=>{n>=5&&n/Math.max(a.length,1)>=.5&&i.push({level:"info",title:"ì²˜ë¦¬ì ì§‘ì¤‘",desc:`${t}ì´(ê°€) ì „ì²´ ë¡œê·¸ì˜ ${Math.round(n/Math.max(a.length,1)*100)}% (${n}ê±´)ë¥¼ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.`,logs:[]})});const E=d.filter(t=>t.to_status==="DRAFT"&&t.from_status!=="DRAFT"&&!String(t.reason||"").trim());return E.length>0&&i.push({level:"warning",title:"ì‚¬ìœ  ì—†ëŠ” ë°˜ë ¤",desc:`${E.length}ê±´ì˜ ë°˜ë ¤ ì²˜ë¦¬ì— ì‚¬ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.`,logs:E.map(t=>t.id).filter(Boolean)}),i}const{menuPanelCard:de,menuPanelHead:ue,menuPanelBody:he,menuGhostBtn:ee}=M;function xe({anomaly:r,onHighlight:i}){const a=q[r.level]||q.info;return e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:10,padding:"10px 12px",borderRadius:8,background:a.bg,border:`1px solid ${a.border}`},children:[e.jsx("span",{style:{width:22,height:22,borderRadius:"50%",background:a.badge,color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:800,flexShrink:0},children:a.icon}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:13,fontWeight:700,color:"#1e293b"},children:r.title}),e.jsx("div",{style:{fontSize:12,color:"#475569",marginTop:2},children:r.desc})]}),r.logs.length>0&&e.jsx("button",{onClick:()=>i(r.logs),style:{...ee,fontSize:12,padding:"4px 8px",flexShrink:0},children:"ê°•ì¡°"})]})}function fe({anomalies:r,highlighted:i,setHighlighted:a}){return r.length?e.jsxs("section",{style:de,children:[e.jsxs("div",{style:{...ue,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("span",{children:["ì´ìƒì§•í›„ ë¶„ì„ (",r.length,"ê±´)"]}),i&&e.jsx("button",{style:{...ee,fontSize:12,padding:"2px 8px"},onClick:()=>a(null),children:"ê°•ì¡° í•´ì œ"})]}),e.jsx("div",{style:{...he,gap:6},children:r.map((d,g)=>e.jsx(xe,{anomaly:d,onHighlight:x=>a(x)},g))})]}):null}const{menuPanelCard:ge,menuPanelHead:pe,menuPanelBody:be,simpleInput:T,simpleSelect:J,menuGhostBtn:N}=M,L={display:"block",fontSize:12,fontWeight:600,marginBottom:4,color:"#475569"};function ye({keyword:r,setKeyword:i,statusFilter:a,setStatusFilter:d,logTypeFilter:g,setLogTypeFilter:x,actionFilter:y,setActionFilter:m,actorFilter:h,setActorFilter:p,entryFilter:E,setEntryFilter:t,fromDate:n,setFromDate:l,toDate:_,setToDate:b,resetFilters:j}){const s=()=>{const o=new Date().toISOString().slice(0,10);l(o),b(o)},v=()=>{const o=new Date,I=new Date;I.setDate(I.getDate()-7),b(o.toISOString().slice(0,10)),l(I.toISOString().slice(0,10))},f=()=>{const o=new Date,I=new Date;I.setMonth(I.getMonth()-1),b(o.toISOString().slice(0,10)),l(I.toISOString().slice(0,10))};return e.jsxs("section",{style:ge,children:[e.jsx("div",{style:pe,children:"ê²€ìƒ‰ / í•„í„°"}),e.jsxs("div",{style:be,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:10},children:[e.jsxs("div",{children:[e.jsx("label",{style:L,children:"í‚¤ì›Œë“œ"}),e.jsx("input",{style:{...T,width:"100%",boxSizing:"border-box"},placeholder:"ì²˜ë¦¬ì/ì‚¬ìœ /ë¦¬ì†ŒìŠ¤",value:r,onChange:o=>i(o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"ë¡œê·¸ êµ¬ë¶„"}),e.jsxs("select",{style:{...J,width:"100%",boxSizing:"border-box"},value:g,onChange:o=>x(o.target.value),children:[e.jsx("option",{value:"",children:"ì „ì²´"}),e.jsx("option",{value:"WORKFLOW",children:"WORKFLOW"}),e.jsx("option",{value:"AUTH",children:"AUTH"}),e.jsx("option",{value:"CRUD",children:"CRUD"}),e.jsx("option",{value:"SYSTEM",children:"SYSTEM"})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"ìƒíƒœ"}),e.jsxs("select",{style:{...J,width:"100%",boxSizing:"border-box"},value:a,onChange:o=>d(o.target.value),children:[e.jsx("option",{value:"",children:"ì „ì²´"}),e.jsx("option",{value:"DRAFT",children:"ì‘ì„±ì¤‘"}),e.jsx("option",{value:"PENDING",children:"ì œì¶œ"}),e.jsx("option",{value:"REVIEWING",children:"ê²€í† ì¤‘"}),e.jsx("option",{value:"FINALIZED",children:"í™•ì •"}),e.jsx("option",{value:"CREATE",children:"CREATE"}),e.jsx("option",{value:"UPDATE",children:"UPDATE"}),e.jsx("option",{value:"DELETE",children:"DELETE"}),e.jsx("option",{value:"LOGIN",children:"LOGIN"}),e.jsx("option",{value:"LOGIN_FAILED",children:"LOGIN_FAILED"}),e.jsx("option",{value:"LOGOUT",children:"LOGOUT"})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"ì•¡ì…˜"}),e.jsx("input",{style:{...T,width:"100%",boxSizing:"border-box"},placeholder:"ì˜ˆ: CREATE, UPDATE",value:y,onChange:o=>m(o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"ì²˜ë¦¬ì"}),e.jsx("input",{style:{...T,width:"100%",boxSizing:"border-box"},placeholder:"ì²˜ë¦¬ìëª…",value:h,onChange:o=>p(o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"Entry ID"}),e.jsx("input",{style:{...T,width:"100%",boxSizing:"border-box"},placeholder:"ì˜ˆ: 42",value:E,onChange:o=>t(o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"ì‹œì‘ì¼"}),e.jsx("input",{style:{...T,width:"100%",boxSizing:"border-box"},type:"date",value:n,onChange:o=>l(o.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{style:L,children:"ì¢…ë£Œì¼"}),e.jsx("input",{style:{...T,width:"100%",boxSizing:"border-box"},type:"date",value:_,onChange:o=>b(o.target.value)})]})]}),e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginTop:4},children:[e.jsx("button",{style:N,onClick:s,children:"ì˜¤ëŠ˜"}),e.jsx("button",{style:N,onClick:v,children:"1ì£¼ì¼"}),e.jsx("button",{style:N,onClick:f,children:"1ê°œì›”"}),e.jsx("button",{style:{...N,marginLeft:"auto",color:"#dc2626",borderColor:"#fca5a5"},onClick:j,children:"ì´ˆê¸°í™”"})]})]})]})}function U({status:r}){const i=ae[r]||{color:"#334155",bg:"#e2e8f0"};return e.jsx("span",{style:{fontSize:12,fontWeight:700,padding:"2px 8px",borderRadius:999,color:i.color,background:i.bg,whiteSpace:"nowrap"},children:W[r]||r||"-"})}const{menuPanelCard:je,menuPanelHead:Se,menuPanelBody:me,simpleTable:ve,simpleTh:w,simpleTd:C,menuGhostBtn:F}=M;function Ee({logs:r,loading:i,highlighted:a}){const[d,g]=c.useState("created_at"),[x,y]=c.useState("desc"),[m,h]=c.useState(1),p=50,E=c.useMemo(()=>a?new Set(a):null,[a]),t=c.useMemo(()=>[...r].sort((s,v)=>{let f=s[d],o=v[d];return d==="created_at"&&(f=new Date(f),o=new Date(o)),f<o?x==="asc"?-1:1:f>o?x==="asc"?1:-1:0}),[r,d,x]),n=Math.max(1,Math.ceil(t.length/p)),l=Math.min(m,n),_=c.useMemo(()=>t.slice((l-1)*p,l*p),[t,l]),b=s=>{d===s?y(v=>v==="asc"?"desc":"asc"):(g(s),y("asc"))},j=s=>d===s?x==="asc"?" â–²":" â–¼":" â†•";return e.jsxs("section",{style:je,children:[e.jsxs("div",{style:{...Se,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("span",{children:["ê°ì‚¬ ë¡œê·¸ (",t.length,"ê±´)"]}),a&&e.jsx("span",{style:{fontSize:12,color:"#d97706",fontWeight:600},children:"ì´ìƒì§•í›„ í•­ëª© ê°•ì¡° í‘œì‹œ ì¤‘"})]}),e.jsx("div",{style:{...me,padding:0,overflow:"auto"},children:i?e.jsx("div",{style:{textAlign:"center",padding:48,color:"#94a3b8",fontSize:14},children:"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."}):t.length===0?e.jsx(ie,{icon:"ğŸ“­",title:"ë¡œê·¸ ì—†ìŒ",message:"ê²€ìƒ‰ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ê°ì‚¬ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."}):e.jsxs(e.Fragment,{children:[e.jsxs("table",{style:ve,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{style:{...w,cursor:"pointer",userSelect:"none"},onClick:()=>b("created_at"),children:["ì¼ì‹œ",j("created_at")]}),e.jsxs("th",{style:{...w,cursor:"pointer",userSelect:"none"},onClick:()=>b("log_type"),children:["êµ¬ë¶„",j("log_type")]}),e.jsxs("th",{style:{...w,cursor:"pointer",userSelect:"none"},onClick:()=>b("action"),children:["ì•¡ì…˜",j("action")]}),e.jsx("th",{style:w,children:"ëŒ€ìƒ"}),e.jsx("th",{style:w,children:"ì´ì „ ìƒíƒœ"}),e.jsx("th",{style:w,children:"ë³€ê²½ ìƒíƒœ"}),e.jsxs("th",{style:{...w,cursor:"pointer",userSelect:"none"},onClick:()=>b("actor_name"),children:["ì²˜ë¦¬ì",j("actor_name")]}),e.jsxs("th",{style:{...w,cursor:"pointer",userSelect:"none"},onClick:()=>b("status_code"),children:["ê²°ê³¼",j("status_code")]}),e.jsx("th",{style:w,children:"ì‚¬ìœ "})]})}),e.jsx("tbody",{children:_.map((s,v)=>{const f=E&&E.has(s.id),o=s.entry?`Entry #${s.entry}`:`${s.resource_type||"-"}${s.resource_id?` #${s.resource_id}`:""}`;return e.jsxs("tr",{style:{background:f?"#fffbeb":void 0,outline:f?"2px solid #fcd34d":void 0,outlineOffset:f?"-1px":void 0},children:[e.jsxs("td",{style:{...C,whiteSpace:"nowrap",fontSize:13},children:[Q(s.created_at),f&&e.jsx("span",{style:{marginLeft:4,fontSize:11,color:"#d97706"},children:"!"})]}),e.jsx("td",{style:{...C,fontWeight:700},children:s.log_type||"-"}),e.jsx("td",{style:{...C},children:e.jsx(U,{status:s.action})}),e.jsx("td",{style:{...C,fontWeight:600},children:o}),e.jsx("td",{style:{...C,textAlign:"center"},children:e.jsx(U,{status:s.from_status})}),e.jsx("td",{style:{...C,textAlign:"center"},children:e.jsx(U,{status:s.to_status})}),e.jsx("td",{style:{...C,fontWeight:600},children:s.actor_display||s.actor_name||"-"}),e.jsx("td",{style:{...C,textAlign:"center"},children:s.status_code||"-"}),e.jsx("td",{title:s.reason||"",style:{...C,color:s.reason?"#1e293b":"#94a3b8",fontStyle:s.reason?"normal":"italic",maxWidth:320,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:s.reason||"ì—†ìŒ"})]},s.id??v)})})]}),n>1&&e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:8,padding:"12px 16px",borderTop:"1px solid #f1f5f9"},children:[e.jsx("button",{style:{...F,padding:"4px 10px",fontSize:13},disabled:l===1,onClick:()=>h(1),children:"ì²˜ìŒ"}),e.jsx("button",{style:{...F,padding:"4px 10px",fontSize:13},disabled:l===1,onClick:()=>h(s=>Math.max(1,s-1)),children:"ì´ì „"}),e.jsxs("span",{style:{fontSize:13,color:"#475569",fontWeight:600},children:[l," / ",n]}),e.jsx("button",{style:{...F,padding:"4px 10px",fontSize:13},disabled:l===n,onClick:()=>h(s=>Math.min(n,s+1)),children:"ë‹¤ìŒ"}),e.jsx("button",{style:{...F,padding:"4px 10px",fontSize:13},disabled:l===n,onClick:()=>h(n),children:"ë§ˆì§€ë§‰"}),e.jsxs("span",{style:{fontSize:12,color:"#94a3b8",marginLeft:8},children:["ì´ ",t.length,"ê±´ ì¤‘ ",(l-1)*p+1," ~ ",Math.min(l*p,t.length)]})]})]})})]})}function _e(r){if(!r)return null;try{const i=new URL(r);return`${i.pathname}${i.search}`}catch{return r}}function Le({menuId:r,authAxios:i,user:a,modalApi:d}){const[g,x]=c.useState([]),[y,m]=c.useState(!1),[h,p]=c.useState(null),[E,t]=c.useState(0),[n,l]=c.useState(""),[_,b]=c.useState(""),[j,s]=c.useState(""),[v,f]=c.useState(""),[o,I]=c.useState(""),[R,B]=c.useState(""),[A,H]=c.useState(""),[O,V]=c.useState(""),[Z,K]=c.useState(null),k=c.useCallback(async({append:S=!1,url:G=null}={})=>{m(!0);try{const D=S?void 0:{q:n||void 0,from_date:A||void 0,to_date:O||void 0,status:_||void 0,log_type:j||void 0,action:v||void 0,actor:o||void 0,entry:R||void 0},u=S&&G||"/api/logs/",$=(await i.get(u,D?{params:D}:void 0)).data,z=oe($);x(S?se=>[...se,...z]:z),p(_e($?.next)),t(Number($?.count||z.length||0))}catch(D){await d.alert(X(D,"ê°ì‚¬ë¡œê·¸ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."))}finally{m(!1)}},[v,o,i,R,A,n,j,d,_,O]);c.useEffect(()=>{const S=setTimeout(()=>{k({append:!1})},250);return()=>clearTimeout(S)},[k]);const P=g,Y=c.useMemo(()=>ce(g),[g]),te=()=>{l(""),b(""),s(""),f(""),I(""),B(""),H(""),V(""),K(null)},ne=async()=>{if(P.length===0){await d.alert("ë‚´ë³´ë‚¼ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");return}try{const S=await re(()=>import("./xlsx-CNerDvZX.js"),[]),G=P.map(u=>({ì¼ì‹œ:Q(u.created_at),ë¡œê·¸êµ¬ë¶„:u.log_type||"-",ì•¡ì…˜:u.action||"-",ì—”íŠ¸ë¦¬ID:u.entry||"-",ë¦¬ì†ŒìŠ¤:u.resource_type||"-",ë¦¬ì†ŒìŠ¤ID:u.resource_id||"-",ì´ì „ìƒíƒœ:W[u.from_status]||u.from_status||"-",ë³€ê²½ìƒíƒœ:W[u.to_status]||u.to_status||"-",ì²˜ë¦¬ì:u.actor_display||u.actor_name||u.actor||"-",ê²°ê³¼ì½”ë“œ:u.status_code||"-",ì‚¬ìœ :u.reason||"-",ê²½ë¡œ:u.path||"-"})),D=S.utils.book_new();S.utils.book_append_sheet(D,S.utils.json_to_sheet(G),"ê°ì‚¬ë¡œê·¸"),S.writeFile(D,`audit_logs_${new Date().toISOString().slice(0,10)}.xlsx`),await d.alert("Excel íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(S){await d.alert(X(S,"ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."))}};return e.jsxs(le,{menuId:r,user:a,actions:[{label:"ìƒˆë¡œê³ ì¹¨",onClick:k,disabled:y},...h?[{label:"ë” ë¶ˆëŸ¬ì˜¤ê¸°",onClick:()=>k({append:!0,url:h}),disabled:y}]:[],{label:"Excel ë‚´ë³´ë‚´ê¸°",onClick:ne,disabled:P.length===0}],stats:[{label:"ì „ì²´ ë¡œê·¸",value:`${E}ê±´`},{label:"ê²€ìƒ‰ ê²°ê³¼",value:`${P.length}ê±´`},{label:"ì´ìƒì§•í›„",value:`${Y.length}ê±´`},{label:"ë¡œê·¸ êµ¬ë¶„",value:j||"ì „ì²´"},{label:"ì¡°íšŒ ê¸°ê°„",value:A&&O?`${A} ~ ${O}`:"ì „ì²´"}],children:[e.jsx(fe,{anomalies:Y,highlighted:Z,setHighlighted:K}),e.jsx(ye,{keyword:n,setKeyword:l,statusFilter:_,setStatusFilter:b,logTypeFilter:j,setLogTypeFilter:s,actionFilter:v,setActionFilter:f,actorFilter:o,setActorFilter:I,entryFilter:R,setEntryFilter:B,fromDate:A,setFromDate:H,toDate:O,setToDate:V,resetFilters:te}),e.jsx(Ee,{logs:P,loading:y,highlighted:Z})]})}export{Le as default};
