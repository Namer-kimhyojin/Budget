import{a as d,j as t,M as L,m as P,_ as $,E}from"./index-DGmJ4d-A.js";import{E as M}from"./EmptyState-SZt51KYm.js";import{I as V}from"./InfoBox-6zlRvVx0.js";const{menuPanelCard:N,menuPanelHead:I,menuPanelBody:v,simpleLabel:w,simpleSelect:R}=P;function X({menuId:b,version:o,versions:g=[],setVersion:c,entries:x=[],orgs:f=[],user:j,modalApi:h}){const[i,C]=d.useState(""),[_,O]=d.useState(!0),S=d.useMemo(()=>[...g].sort((e,s)=>s.year-e.year||s.round-e.round),[g]),k=d.useMemo(()=>{const e=new Set;return f.filter(s=>e.has(s.id)?!1:(e.add(s.id),!0))},[f]),n=d.useMemo(()=>i?x.filter(e=>Number(e.organization)===Number(i)):x,[x,i]),u=d.useMemo(()=>{const e={DRAFT:0,PENDING:0,REVIEWING:0,FINALIZED:0};let s=0;return n.forEach(l=>{e[l.status]!=null&&(e[l.status]+=1),s+=Number(l.total_amount||0)}),{statusCounts:e,totalAmount:s}},[n]),A=e=>{if(!c)return;const s=S.find(l=>String(l.id)===String(e));s&&c(s)},z=async()=>{if(!o){await h.alert("No budget version is selected.");return}if(!n.length){await h.alert("No data to export for current filter.");return}try{const e=await $(()=>import("./xlsx-CNerDvZX.js"),[]),s=e.utils.book_new(),l=new Date,B=i?f.find(a=>Number(a.id)===Number(i))?.name||i:"All",D=[{item:"GeneratedAt",value:l.toLocaleString()},{item:"GeneratedBy",value:j?.username||"-"},{item:"BudgetVersion",value:`${o.year} ${o.name}`},{item:"Organization",value:B},{item:"Rows",value:n.length}];e.utils.book_append_sheet(s,e.utils.json_to_sheet(D),"Meta");const T=n.map((a,r)=>({no:r+1,year:a.year,round:a.supplemental_round,organization:a.organization_name||a.organization,project:a.entrusted_project_name||"-",subject_code:a.subject_code||"",subject_name:a.subject_name||a.subject,status:E[a.status]||a.status,amount:Number(a.total_amount||0),executed:Number(a.executed_total||0),remaining:Number(a.remaining_amount||0)}));e.utils.book_append_sheet(s,e.utils.json_to_sheet(T),"Details");const y=Object.entries(u.statusCounts).map(([a,r])=>({status:a,label:E[a]||a,count:r}));if(y.push({status:"TOTAL",label:"Total",count:n.length}),e.utils.book_append_sheet(s,e.utils.json_to_sheet(y),"Summary"),_){const a={};n.forEach(r=>{const m=r.organization_name||String(r.organization);a[m]||(a[m]={organization:m,count:0,amount:0}),a[m].count+=1,a[m].amount+=Number(r.total_amount||0)}),e.utils.book_append_sheet(s,e.utils.json_to_sheet(Object.values(a)),"ByOrg")}const F=`budget_report_${o.year}_r${o.round}_${l.toISOString().slice(0,10)}.xlsx`;e.writeFile(s,F),await h.alert("Excel export completed.")}catch{await h.alert("Failed to export Excel.")}};return t.jsxs(L,{menuId:b,user:j,actions:[{label:"Excel Export",onClick:z}],stats:[{label:"Rows",value:`${n.length}`},{label:"Total Amount",value:`${Math.round(u.totalAmount)}`},{label:"Version",value:o?`${o.year} ${o.name}`:"-"}],children:[!o&&t.jsx(V,{type:"warning",title:"No Version Selected",message:"Select a budget version to view/export reports."}),o&&n.length===0&&t.jsx(M,{icon:"ðŸ“„",title:"No Data",message:"No rows match the current filters."}),t.jsxs("section",{style:{...N,borderTop:"4px solid #2196F3",backgroundColor:"#f3f6ff"},children:[t.jsx("div",{style:I,children:"Report Filters"}),t.jsxs("div",{style:v,children:[t.jsxs("div",{style:{marginBottom:16},children:[t.jsx("label",{style:{...w,display:"block",marginBottom:8,fontWeight:"bold"},children:"Budget Version"}),t.jsxs("select",{style:R,value:o?.id?String(o.id):"",onChange:e=>A(e.target.value),children:[!o?.id&&t.jsx("option",{value:"",children:"Select Version"}),S.map(e=>t.jsxs("option",{value:e.id,children:[e.year," / ",e.name||`Round ${e.round}`]},e.id))]})]}),t.jsxs("div",{style:{marginBottom:16},children:[t.jsx("label",{style:{...w,display:"block",marginBottom:8,fontWeight:"bold"},children:"Organization"}),t.jsxs("select",{style:R,value:i,onChange:e=>C(e.target.value),children:[t.jsx("option",{value:"",children:"All Organizations"}),k.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsx("div",{style:{display:"flex",gap:12,padding:12,backgroundColor:"#fff",borderRadius:8,border:"1px solid #cbd5e1"},children:t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:14},children:[t.jsx("input",{type:"checkbox",checked:_,onChange:e=>O(e.target.checked)}),t.jsx("span",{children:"Include ByOrg sheet"})]})})]})]}),t.jsxs("section",{style:N,children:[t.jsx("div",{style:I,children:"Preview"}),t.jsx("div",{style:v,children:t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",gap:12},children:[t.jsx(p,{label:"DRAFT",value:u.statusCounts.DRAFT,bg:"#ffebee",color:"#c62828"}),t.jsx(p,{label:"PENDING",value:u.statusCounts.PENDING,bg:"#fff3e0",color:"#e65100"}),t.jsx(p,{label:"REVIEWING",value:u.statusCounts.REVIEWING,bg:"#e3f2fd",color:"#0d47a1"}),t.jsx(p,{label:"FINALIZED",value:u.statusCounts.FINALIZED,bg:"#e8f5e9",color:"#1b5e20"})]})})]})]})}function p({label:b,value:o,bg:g,color:c}){return t.jsxs("div",{style:{padding:12,backgroundColor:g,borderRadius:8,textAlign:"center"},children:[t.jsx("div",{style:{fontSize:11,color:c,marginBottom:4,fontWeight:600},children:b}),t.jsx("div",{style:{fontSize:20,fontWeight:800,color:c},children:o})]})}export{X as default};
